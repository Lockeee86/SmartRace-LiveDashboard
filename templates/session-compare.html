{% extends "base.html" %}

{% block title %}Session-Vergleich - SmartRace Live{% endblock %}

{% block content %}
<div class="session-selector d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0"><i class="fas fa-columns me-2"></i>Session-Vergleich</h5>
</div>

<!-- Session-Auswahl -->
<div class="row g-3 mb-3">
    <div class="col-md-5">
        <div class="card">
            <div class="card-body py-2">
                <label class="form-label small text-muted mb-1">Session 1</label>
                <select id="session1Select" class="form-select form-select-sm">
                    <option value="">Session waehlen...</option>
                </select>
            </div>
        </div>
    </div>
    <div class="col-md-2 d-flex align-items-center justify-content-center">
        <button class="btn btn-primary" id="compareBtn" disabled>
            <i class="fas fa-exchange-alt me-1"></i> Vergleichen
        </button>
    </div>
    <div class="col-md-5">
        <div class="card">
            <div class="card-body py-2">
                <label class="form-label small text-muted mb-1">Session 2</label>
                <select id="session2Select" class="form-select form-select-sm">
                    <option value="">Session waehlen...</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Vergleich -->
<div id="compareContainer" class="d-none">
    <div class="row g-3 mb-3">
        <!-- Session 1 -->
        <div class="col-md-6">
            <div class="card h2h-card" id="session1Card">
                <div class="card-header py-2">
                    <strong id="s1Title">Session 1</strong>
                    <span class="float-end small text-muted" id="s1Date">--</span>
                </div>
                <div class="card-body">
                    <div class="row text-center g-2 mb-3">
                        <div class="col-3">
                            <div class="fw-bold fs-5" id="s1Laps">0</div>
                            <div class="small text-muted">Runden</div>
                        </div>
                        <div class="col-3">
                            <div class="fw-bold fs-5" id="s1Drivers">0</div>
                            <div class="small text-muted">Fahrer</div>
                        </div>
                        <div class="col-3">
                            <div class="fw-bold fs-5" id="s1Penalties">0</div>
                            <div class="small text-muted">Strafen</div>
                        </div>
                        <div class="col-3">
                            <div class="fw-bold fs-5 font-mono" id="s1Best">--</div>
                            <div class="small text-muted">Bestzeit</div>
                        </div>
                    </div>
                    <table class="table table-sm mb-0">
                        <thead><tr><th>Fahrer</th><th class="text-center">Runden</th><th class="text-center">Bestzeit</th><th class="text-center">Schnitt</th></tr></thead>
                        <tbody id="s1Body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Session 2 -->
        <div class="col-md-6">
            <div class="card h2h-card" id="session2Card">
                <div class="card-header py-2">
                    <strong id="s2Title">Session 2</strong>
                    <span class="float-end small text-muted" id="s2Date">--</span>
                </div>
                <div class="card-body">
                    <div class="row text-center g-2 mb-3">
                        <div class="col-3">
                            <div class="fw-bold fs-5" id="s2Laps">0</div>
                            <div class="small text-muted">Runden</div>
                        </div>
                        <div class="col-3">
                            <div class="fw-bold fs-5" id="s2Drivers">0</div>
                            <div class="small text-muted">Fahrer</div>
                        </div>
                        <div class="col-3">
                            <div class="fw-bold fs-5" id="s2Penalties">0</div>
                            <div class="small text-muted">Strafen</div>
                        </div>
                        <div class="col-3">
                            <div class="fw-bold fs-5 font-mono" id="s2Best">--</div>
                            <div class="small text-muted">Bestzeit</div>
                        </div>
                    </div>
                    <table class="table table-sm mb-0">
                        <thead><tr><th>Fahrer</th><th class="text-center">Runden</th><th class="text-center">Bestzeit</th><th class="text-center">Schnitt</th></tr></thead>
                        <tbody id="s2Body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Fahrer-Vergleich -->
    <div class="card">
        <div class="card-header border-0 bg-transparent">
            <h6 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Fahrer-Vergleich (gleiche Fahrer)</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>Fahrer</th>
                            <th class="text-center">Bestzeit S1</th>
                            <th class="text-center">Bestzeit S2</th>
                            <th class="text-center">Differenz</th>
                            <th class="text-center">Besser in</th>
                        </tr>
                    </thead>
                    <tbody id="crossBody">
                        <tr><td colspan="5" class="text-center text-muted py-3">Session waehlen und vergleichen</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadSessions() {
    try {
        const res = await fetch('/api/sessions');
        if (!res.ok) return;
        const sessions = await res.json();
        ['session1Select', 'session2Select'].forEach(id => {
            const sel = document.getElementById(id);
            sel.innerHTML = '<option value="">Session waehlen...</option>';
            sessions.forEach(s => {
                const date = s.start_time ? new Date(s.start_time).toLocaleDateString('de-DE') : '';
                const opt = document.createElement('option');
                opt.value = s.session_id;
                opt.textContent = `${s.session_type || 'Training'} - ${date} - ${s.total_laps} Runden`;
                sel.appendChild(opt);
            });
        });
    } catch (e) {}
}

function checkSelections() {
    const s1 = document.getElementById('session1Select').value;
    const s2 = document.getElementById('session2Select').value;
    document.getElementById('compareBtn').disabled = !(s1 && s2 && s1 !== s2);
}

async function compare() {
    const s1 = document.getElementById('session1Select').value;
    const s2 = document.getElementById('session2Select').value;
    if (!s1 || !s2 || s1 === s2) return;

    try {
        const res = await fetch(`/api/session-compare?session1=${encodeURIComponent(s1)}&session2=${encodeURIComponent(s2)}`);
        if (!res.ok) { showToast('Vergleich fehlgeschlagen', 'danger'); return; }
        const data = await res.json();
        if (data.error) { showToast(data.error, 'danger'); return; }
        renderComparison(data, s1, s2);
    } catch (e) {
        showToast('Vergleich fehlgeschlagen', 'danger');
    }
}

function renderComparison(data, s1Id, s2Id) {
    document.getElementById('compareContainer').classList.remove('d-none');
    const s1 = data[s1Id] || {};
    const s2 = data[s2Id] || {};

    // Session 1
    document.getElementById('s1Title').textContent = s1.session_type || 'Session 1';
    document.getElementById('s1Date').textContent = s1.start_time ? new Date(s1.start_time).toLocaleDateString('de-DE') : '';
    document.getElementById('s1Laps').textContent = s1.total_laps || 0;
    document.getElementById('s1Drivers').textContent = (s1.drivers || []).length;
    document.getElementById('s1Penalties').textContent = s1.penalties || 0;
    const s1Best = (s1.drivers || []).length > 0 ? s1.drivers[0].best_time_formatted : '--';
    document.getElementById('s1Best').textContent = s1Best;

    // Session 2
    document.getElementById('s2Title').textContent = s2.session_type || 'Session 2';
    document.getElementById('s2Date').textContent = s2.start_time ? new Date(s2.start_time).toLocaleDateString('de-DE') : '';
    document.getElementById('s2Laps').textContent = s2.total_laps || 0;
    document.getElementById('s2Drivers').textContent = (s2.drivers || []).length;
    document.getElementById('s2Penalties').textContent = s2.penalties || 0;
    const s2Best = (s2.drivers || []).length > 0 ? s2.drivers[0].best_time_formatted : '--';
    document.getElementById('s2Best').textContent = s2Best;

    // Highlight bessere Session
    const s1BestMs = (s1.drivers || []).length > 0 ? s1.drivers[0].best_time : null;
    const s2BestMs = (s2.drivers || []).length > 0 ? s2.drivers[0].best_time : null;
    document.getElementById('session1Card').style.borderColor = (s1BestMs && s2BestMs && s1BestMs < s2BestMs) ? 'var(--sr-success)' : 'var(--sr-border)';
    document.getElementById('session2Card').style.borderColor = (s1BestMs && s2BestMs && s2BestMs < s1BestMs) ? 'var(--sr-success)' : 'var(--sr-border)';

    // Fahrer-Tabellen
    ['s1Body', 's2Body'].forEach((id, idx) => {
        const drivers = idx === 0 ? (s1.drivers || []) : (s2.drivers || []);
        document.getElementById(id).innerHTML = drivers.map(d =>
            `<tr>
                <td class="fw-bold">${d.driver_name}</td>
                <td class="text-center">${d.total_laps}</td>
                <td class="text-center font-mono fw-bold">${d.best_time_formatted}</td>
                <td class="text-center font-mono">${d.avg_time_formatted}</td>
            </tr>`
        ).join('') || '<tr><td colspan="4" class="text-center text-muted">Keine Daten</td></tr>';
    });

    // Cross-Vergleich: gleiche Fahrer in beiden Sessions
    const s1Map = {};
    const s2Map = {};
    (s1.drivers || []).forEach(d => { s1Map[d.driver_name] = d; });
    (s2.drivers || []).forEach(d => { s2Map[d.driver_name] = d; });
    const commonDrivers = Object.keys(s1Map).filter(n => n in s2Map);

    const crossBody = document.getElementById('crossBody');
    if (commonDrivers.length === 0) {
        crossBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">Keine gemeinsamen Fahrer</td></tr>';
        return;
    }

    crossBody.innerHTML = commonDrivers.map(name => {
        const d1 = s1Map[name];
        const d2 = s2Map[name];
        const diff = d1.best_time - d2.best_time;
        const absDiff = Math.abs(diff);
        let betterIn = '=';
        let diffClass = 'text-muted';
        if (diff < 0) { betterIn = '<i class="fas fa-arrow-left text-success"></i> S1'; diffClass = 'text-success'; }
        else if (diff > 0) { betterIn = '<i class="fas fa-arrow-right text-primary"></i> S2'; diffClass = 'text-primary'; }

        return `<tr>
            <td class="fw-bold">${name}</td>
            <td class="text-center font-mono ${diff < 0 ? 'text-success fw-bold' : ''}">${d1.best_time_formatted}</td>
            <td class="text-center font-mono ${diff > 0 ? 'text-primary fw-bold' : ''}">${d2.best_time_formatted}</td>
            <td class="text-center font-mono ${diffClass}">${diff > 0 ? '+' : (diff < 0 ? '-' : '')}${formatTime(absDiff)}</td>
            <td class="text-center">${betterIn}</td>
        </tr>`;
    }).join('');
}

document.addEventListener('DOMContentLoaded', () => { loadSessions(); });
document.getElementById('session1Select').addEventListener('change', checkSelections);
document.getElementById('session2Select').addEventListener('change', checkSelections);
document.getElementById('compareBtn').addEventListener('click', compare);
</script>
{% endblock %}
