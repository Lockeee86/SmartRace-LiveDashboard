<!DOCTYPE html>
<html lang="de" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SmartRace Dashboard{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    {% block styles %}{% endblock %}
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg border-bottom">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="{{ url_for('page_leaderboard') }}">
                <i class="fas fa-flag-checkered me-2"></i>SmartRace Live
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto flex-row flex-wrap justify-content-center gap-1">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_leaderboard' %}active{% endif %}" href="{{ url_for('page_leaderboard') }}" title="Leaderboard">
                            <i class="fas fa-trophy me-1"></i><span class="d-none d-xl-inline">Leaderboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_dashboard' %}active{% endif %}" href="{{ url_for('page_dashboard') }}" title="Dashboard">
                            <i class="fas fa-gauge-high me-1"></i><span class="d-none d-xl-inline">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_analytics' %}active{% endif %}" href="{{ url_for('page_analytics') }}" title="Analytics">
                            <i class="fas fa-chart-line me-1"></i><span class="d-none d-xl-inline">Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_database' %}active{% endif %}" href="{{ url_for('page_database') }}" title="Datenbank">
                            <i class="fas fa-database me-1"></i><span class="d-none d-xl-inline">Datenbank</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_stats' or request.endpoint == 'page_driver_profile' %}active{% endif %}" href="{{ url_for('page_stats') }}" title="Statistiken">
                            <i class="fas fa-chart-column me-1"></i><span class="d-none d-xl-inline">Statistiken</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_tracks' %}active{% endif %}" href="{{ url_for('page_tracks') }}" title="Strecken">
                            <i class="fas fa-road me-1"></i><span class="d-none d-xl-inline">Strecken</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_head_to_head' %}active{% endif %}" href="{{ url_for('page_head_to_head') }}" title="Head-to-Head">
                            <i class="fas fa-people-arrows me-1"></i><span class="d-none d-xl-inline">H2H</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_live_timing' %}active{% endif %}" href="{{ url_for('page_live_timing') }}" title="Live-Timing">
                            <i class="fas fa-stopwatch me-1"></i><span class="d-none d-xl-inline">Timing</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_results' %}active{% endif %}" href="{{ url_for('page_results') }}" title="Ergebnis">
                            <i class="fas fa-flag-checkered me-1"></i><span class="d-none d-xl-inline">Ergebnis</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_race_control' %}active{% endif %}" href="{{ url_for('page_race_control') }}" title="Race Control">
                            <i class="fas fa-tower-broadcast me-1"></i><span class="d-none d-xl-inline">Control</span>
                        </a>
                    </li>
                </ul>
                <!-- Rennstatus Badge -->
                <span class="badge race-status-badge bg-secondary ms-3" id="raceStatusBadge" title="Rennstatus">
                    <i class="fas fa-hourglass me-1"></i> <span id="raceStatusText">Warte...</span>
                </span>
                <!-- Theme Toggle -->
                <button class="btn btn-sm btn-outline-light ms-2" id="themeToggleBtn" title="Hell/Dunkel umschalten">
                    <i class="fas fa-sun" id="themeIcon"></i>
                </button>
                <!-- Schriftgroesse -->
                <div class="btn-group ms-1" id="fontSizeGroup">
                    <button class="btn btn-sm btn-outline-light" id="fontSizeDownBtn" title="Schrift kleiner">
                        <i class="fas fa-minus" style="font-size:0.6rem"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" id="fontSizeResetBtn" title="Schriftgroesse zuruecksetzen" style="min-width:38px; font-size:0.7rem; pointer-events:auto;">
                        <span id="fontSizeLabel">100%</span>
                    </button>
                    <button class="btn btn-sm btn-outline-light" id="fontSizeUpBtn" title="Schrift groesser">
                        <i class="fas fa-plus" style="font-size:0.6rem"></i>
                    </button>
                </div>
                <!-- Sound Toggle -->
                <button class="btn btn-sm btn-outline-light ms-1" id="soundToggleBtn" title="Ton an/aus">
                    <i class="fas fa-volume-xmark" id="soundIcon"></i>
                </button>
                <!-- Benachrichtigungen -->
                <button class="btn btn-sm btn-outline-light ms-1" id="notifyToggleBtn" title="Browser-Benachrichtigungen">
                    <i class="fas fa-bell-slash" id="notifyIcon"></i>
                </button>
                <!-- Vollbild -->
                <button class="btn btn-sm btn-outline-light ms-1" id="fullscreenBtn" title="Vollbild (F11)">
                    <i class="fas fa-expand"></i>
                </button>
                <!-- Verbindungsstatus -->
                <span class="badge bg-warning ms-2" id="connectionBadge">
                    <i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Verbinde...
                </span>
            </div>
        </div>
    </nav>

    <!-- VSC Banner -->
    <div class="vsc-banner d-none" id="vscBanner">
        <i class="fas fa-shield-halved me-2"></i>VIRTUAL SAFETY CAR<i class="fas fa-shield-halved ms-2"></i>
    </div>

    <!-- Race-Info-Bar -->
    <div class="race-info-bar d-none" id="raceInfoBar">
        <div class="container-fluid px-4 d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <span id="raceInfoType"><i class="fas fa-flag-checkered me-1"></i>--</span>
                <span id="raceInfoTarget" class="text-muted">--</span>
                <span id="raceInfoTrack" class="text-muted d-none"><i class="fas fa-road me-1"></i><span id="trackNameDisplay">--</span></span>
            </div>
            <div class="race-progress-container flex-grow-1 mx-3 d-none" id="raceProgressContainer">
                <div class="race-progress-bar">
                    <div class="race-progress-fill" id="raceProgressFill" style="width: 0%"></div>
                </div>
                <span class="race-progress-text" id="raceProgressText">--</span>
            </div>
        </div>
    </div>

    <!-- Toast-Container fuer Benachrichtigungen -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <!-- Hauptinhalt -->
    <main class="container-fluid px-4 py-3">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="border-top mt-4 py-3 text-center text-muted small">
        <div class="container-fluid d-flex justify-content-center align-items-center gap-3">
            <span>SmartRace Live Dashboard &middot; Carrera Digital</span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <script>
    // =========================================================================
    // Globale Hilfsfunktionen
    // =========================================================================
    function formatTime(timeMs) {
        if (!timeMs || timeMs <= 0) return '--:--.---';
        const minutes = Math.floor(timeMs / 60000);
        const seconds = ((timeMs % 60000) / 1000).toFixed(3);
        return minutes + ':' + seconds.padStart(6, '0');
    }

    const CONTROLLER_COLORS = {
        '1': '#e74c3c', '2': '#3498db', '3': '#2ecc71',
        '4': '#f1c40f', '5': '#e67e22', '6': '#9b59b6'
    };

    function getControllerColor(id) {
        return CONTROLLER_COLORS[String(id)] || '#95a5a6';
    }

    // =========================================================================
    // Toast-Benachrichtigungen
    // =========================================================================
    function showToast(message, type = 'info', duration = 5000) {
        const container = document.getElementById('toastContainer');
        const icons = {
            success: 'fa-check-circle text-success',
            danger: 'fa-exclamation-circle text-danger',
            warning: 'fa-exclamation-triangle text-warning',
            info: 'fa-info-circle text-info',
        };
        const id = 'toast-' + Date.now();
        const html = `<div id="${id}" class="toast show" role="alert" style="background: var(--sr-card); border: 1px solid var(--sr-border);">
            <div class="toast-body d-flex align-items-center gap-2">
                <i class="fas ${icons[type] || icons.info}"></i>
                <span style="color: var(--sr-text);">${message}</span>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
        if (duration > 0) {
            setTimeout(() => {
                const el = document.getElementById(id);
                if (el) el.remove();
            }, duration);
        }
    }

    // =========================================================================
    // WebSocket-Verbindung (mit Reconnect)
    // =========================================================================
    const socket = io({
        reconnection: true,
        reconnectionAttempts: 10,
        reconnectionDelay: 2000,
        reconnectionDelayMax: 30000,
    });
    const badge = document.getElementById('connectionBadge');

    socket.on('connect', () => {
        badge.className = 'badge bg-success ms-2';
        badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Verbunden';
    });

    socket.on('disconnect', () => {
        badge.className = 'badge bg-danger ms-2';
        badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Getrennt';
    });

    socket.on('reconnect_attempt', (attempt) => {
        badge.className = 'badge bg-warning ms-2';
        badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Verbinde... (' + attempt + ')';
    });

    socket.on('reconnect', () => {
        showToast('Verbindung wiederhergestellt', 'success', 3000);
    });

    socket.on('reconnect_failed', () => {
        badge.className = 'badge bg-danger ms-2';
        badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Offline';
        showToast('Verbindung zum Server verloren. Bitte Seite neu laden.', 'danger', 0);
    });

    socket.on('connect_error', () => {
        badge.className = 'badge bg-danger ms-2';
        badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Fehler';
    });

    // Penalty-Benachrichtigung global
    socket.on('penalty', (data) => {
        const name = data.driver_name || 'Fahrer ' + (data.controller_id || '?');
        const secs = data.penalty_seconds || 0;
        if (secs === 0) {
            showToast(`<strong>Strafe abgesessen:</strong> ${name}`, 'success', 5000);
        } else {
            showToast(`<strong>${secs}s Strafe:</strong> ${name}`, 'warning', 6000);
        }
    });

    // VSC-Banner global
    socket.on('vsc', (data) => {
        const banner = document.getElementById('vscBanner');
        if (data.active) {
            banner.classList.remove('d-none');
            showToast('<strong>Virtual Safety Car</strong> aktiviert', 'warning', 8000);
            playSound('vsc');
        } else {
            banner.classList.add('d-none');
            showToast('<strong>Virtual Safety Car</strong> zurueckgezogen', 'info', 5000);
        }
    });

    // Aktive Strecke
    socket.on('active_track', (data) => {
        if (data.name) {
            const trackEl = document.getElementById('raceInfoTrack');
            document.getElementById('trackNameDisplay').textContent = data.name;
            trackEl.classList.remove('d-none');
            showToast(`<strong>Strecke:</strong> ${data.name}`, 'info', 5000);
        }
    });

    // Rennstatus live aktualisieren
    const RACE_STATUS_MAP = {
        'prepare_for_start': { text: 'Startvorbereitung', cls: 'bg-info', icon: 'fa-traffic-light' },
        'starting': { text: 'Startphase', cls: 'bg-info', icon: 'fa-traffic-light' },
        'jumpstart': { text: 'Fruehstart!', cls: 'bg-danger', icon: 'fa-exclamation-triangle' },
        'running': { text: 'Rennen', cls: 'bg-success', icon: 'fa-play' },
        'racing': { text: 'Rennen', cls: 'bg-success', icon: 'fa-play' },
        'started': { text: 'Gestartet', cls: 'bg-success', icon: 'fa-play' },
        'suspended': { text: 'Unterbrochen', cls: 'bg-warning', icon: 'fa-pause' },
        'paused': { text: 'Pausiert', cls: 'bg-warning', icon: 'fa-pause' },
        'restarting': { text: 'Neustart', cls: 'bg-info', icon: 'fa-rotate' },
        'finished': { text: 'Beendet', cls: 'bg-secondary', icon: 'fa-flag-checkered' },
        'ended': { text: 'Beendet', cls: 'bg-secondary', icon: 'fa-flag-checkered' },
        'waiting': { text: 'Warte...', cls: 'bg-secondary', icon: 'fa-hourglass' },
        'unknown': { text: 'Unbekannt', cls: 'bg-secondary', icon: 'fa-question' },
    };

    function updateRaceStatusBadge(status, raceType) {
        const statusBadge = document.getElementById('raceStatusBadge');
        const statusText = document.getElementById('raceStatusText');
        const s = RACE_STATUS_MAP[status] || RACE_STATUS_MAP['unknown'];
        statusBadge.className = 'badge race-status-badge ' + s.cls + ' ms-3';
        const typeLabel = raceType ? ` (${raceType})` : '';
        statusText.textContent = s.text + typeLabel;
        statusBadge.querySelector('i').className = 'fas ' + s.icon + ' me-1';
    }

    // =========================================================================
    // Fullscreen (global, alle Seiten)
    // =========================================================================
    function toggleFullscreen() {
        const main = document.querySelector('main');
        if (!document.fullscreenElement) {
            (main.requestFullscreen || main.webkitRequestFullscreen || main.msRequestFullscreen).call(main);
        } else {
            (document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen).call(document);
        }
    }

    document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);

    document.addEventListener('fullscreenchange', () => {
        const btn = document.getElementById('fullscreenBtn');
        const main = document.querySelector('main');
        if (document.fullscreenElement) {
            btn.innerHTML = '<i class="fas fa-compress"></i>';
            main.classList.add('fullscreen-mode');
        } else {
            btn.innerHTML = '<i class="fas fa-expand"></i>';
            main.classList.remove('fullscreen-mode');
        }
    });

    // F11 abfangen fuer unseren Fullscreen statt Browser-Fullscreen
    document.addEventListener('keydown', (e) => {
        if (e.key === 'F11') {
            e.preventDefault();
            toggleFullscreen();
        }
    });

    // =========================================================================
    // Race-Info-Bar (Renntyp, Rundenzahl/Dauer, Fortschritt)
    // =========================================================================
    let raceInfo = { type: '', laps: '', duration: '', status: '' };
    let raceMaxLaps = 0;
    let raceDuration = 0;

    function updateRaceInfoBar(data) {
        const bar = document.getElementById('raceInfoBar');
        const typeEl = document.getElementById('raceInfoType');
        const targetEl = document.getElementById('raceInfoTarget');
        const progressContainer = document.getElementById('raceProgressContainer');

        if (data.race_type) raceInfo.type = data.race_type;
        if (data.laps) { raceInfo.laps = data.laps; raceMaxLaps = parseInt(data.laps) || 0; }
        if (data.duration) { raceInfo.duration = data.duration; raceDuration = parseInt(data.duration) || 0; }
        if (data.status) raceInfo.status = data.status;

        if (!raceInfo.type || raceInfo.type === 'Training') {
            bar.classList.add('d-none');
            return;
        }

        bar.classList.remove('d-none');

        const typeLabel = raceInfo.type === 'race' ? 'Rennen' : raceInfo.type === 'qualifying' ? 'Qualifying' : raceInfo.type;
        typeEl.innerHTML = `<i class="fas fa-flag-checkered me-1"></i>${typeLabel}`;

        if (raceMaxLaps > 0) {
            targetEl.textContent = raceMaxLaps + ' Runden';
            progressContainer.classList.remove('d-none');
        } else if (raceDuration > 0) {
            const mins = Math.floor(raceDuration / 60);
            targetEl.textContent = mins + ' Minuten';
            progressContainer.classList.remove('d-none');
        } else {
            targetEl.textContent = '';
            progressContainer.classList.add('d-none');
        }
    }

    function updateRaceProgress(currentLap) {
        if (raceMaxLaps <= 0) return;
        const pct = Math.min(100, Math.round((currentLap / raceMaxLaps) * 100));
        document.getElementById('raceProgressFill').style.width = pct + '%';
        document.getElementById('raceProgressText').textContent = `${currentLap}/${raceMaxLaps}`;
    }

    socket.on('race_status', (data) => {
        updateRaceStatusBadge(data.status, data.race_type);
        updateRaceInfoBar(data);

        if (data.status === 'ended') {
            playSound('finish');
        }
    });

    // Beim Laden pruefen
    fetch('/api/race-status')
        .then(r => r.ok ? r.json() : null)
        .then(data => {
            if (data) {
                updateRaceStatusBadge(data.status, data.race_type);
                updateRaceInfoBar(data);
            }
        })
        .catch(() => {});

    // =========================================================================
    // Dark/Light Theme Toggle
    // =========================================================================
    const themeBtn = document.getElementById('themeToggleBtn');
    const themeIcon = document.getElementById('themeIcon');
    let currentTheme = localStorage.getItem('sr-theme') || 'dark';

    function applyTheme(theme) {
        currentTheme = theme;
        document.documentElement.setAttribute('data-bs-theme', theme);
        if (theme === 'light') {
            document.body.style.backgroundColor = '#f0f2f5';
            document.body.style.color = '#1a1a2e';
            themeIcon.className = 'fas fa-moon';
        } else {
            document.body.style.backgroundColor = '';
            document.body.style.color = '';
            themeIcon.className = 'fas fa-sun';
        }
        localStorage.setItem('sr-theme', theme);
    }

    themeBtn.addEventListener('click', () => {
        applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
    });

    applyTheme(currentTheme);

    // =========================================================================
    // Schriftgroesse
    // =========================================================================
    const FONT_SIZES = [70, 80, 90, 100, 110, 120, 140, 160];
    let fontScale = parseInt(localStorage.getItem('sr-font-scale')) || 100;
    const fontLabel = document.getElementById('fontSizeLabel');

    function applyFontScale(scale) {
        fontScale = scale;
        document.documentElement.style.fontSize = scale + '%';
        fontLabel.textContent = scale + '%';
        localStorage.setItem('sr-font-scale', String(scale));
    }

    document.getElementById('fontSizeUpBtn').addEventListener('click', () => {
        const idx = FONT_SIZES.indexOf(fontScale);
        if (idx >= 0 && idx < FONT_SIZES.length - 1) {
            applyFontScale(FONT_SIZES[idx + 1]);
        } else if (idx === -1) {
            const next = FONT_SIZES.find(s => s > fontScale);
            if (next) applyFontScale(next);
        }
    });

    document.getElementById('fontSizeDownBtn').addEventListener('click', () => {
        const idx = FONT_SIZES.indexOf(fontScale);
        if (idx > 0) {
            applyFontScale(FONT_SIZES[idx - 1]);
        } else if (idx === -1) {
            const prev = [...FONT_SIZES].reverse().find(s => s < fontScale);
            if (prev) applyFontScale(prev);
        }
    });

    document.getElementById('fontSizeResetBtn').addEventListener('click', () => {
        applyFontScale(100);
    });

    applyFontScale(fontScale);

    // =========================================================================
    // Sound-Benachrichtigungen
    // =========================================================================
    let soundEnabled = localStorage.getItem('sr-sound') === 'true';
    const soundIconEl = document.getElementById('soundIcon');

    function updateSoundIcon() {
        soundIconEl.className = soundEnabled ? 'fas fa-volume-high' : 'fas fa-volume-xmark';
    }

    document.getElementById('soundToggleBtn').addEventListener('click', () => {
        soundEnabled = !soundEnabled;
        localStorage.setItem('sr-sound', soundEnabled);
        updateSoundIcon();
        if (soundEnabled) showToast('Ton aktiviert', 'info', 2000);
    });

    updateSoundIcon();

    // Web Audio API Toene
    let audioCtx = null;
    function getAudioCtx() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
    }

    function playSound(type) {
        if (!soundEnabled) return;
        try {
            const ctx = getAudioCtx();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            gain.gain.value = 0.15;

            if (type === 'record') {
                // Aufsteigende Toene
                osc.frequency.setValueAtTime(600, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(1200, ctx.currentTime + 0.2);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                osc.start(); osc.stop(ctx.currentTime + 0.5);
            } else if (type === 'penalty') {
                // Kurzer Warnton
                osc.type = 'square';
                osc.frequency.value = 400;
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
                osc.start(); osc.stop(ctx.currentTime + 0.3);
            } else if (type === 'finish') {
                // Zielflagge: drei Toene
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.frequency.setValueAtTime(1000, ctx.currentTime + 0.15);
                osc.frequency.setValueAtTime(1200, ctx.currentTime + 0.3);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.6);
                osc.start(); osc.stop(ctx.currentTime + 0.6);
            } else if (type === 'vsc') {
                // Langsamer Warnton
                osc.type = 'sawtooth';
                osc.frequency.value = 300;
                gain.gain.value = 0.1;
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);
                osc.start(); osc.stop(ctx.currentTime + 0.8);
            } else if (type === 'jumpstart') {
                // Scharfer hoher Ton
                osc.type = 'square';
                osc.frequency.value = 800;
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                osc.start(); osc.stop(ctx.currentTime + 0.5);
            }
        } catch (e) {}
    }

    // Sounds bei Events
    socket.on('track_record', () => playSound('record'));
    socket.on('penalty', (data) => {
        if (data.penalty_seconds > 0) playSound('penalty');
    });

    // =========================================================================
    // Browser-Benachrichtigungen (Push Notifications)
    // =========================================================================
    let notifyEnabled = localStorage.getItem('sr-notify') === 'true';
    const notifyIconEl = document.getElementById('notifyIcon');
    const notifyBtn = document.getElementById('notifyToggleBtn');

    function updateNotifyIcon() {
        if (notifyEnabled && Notification.permission === 'granted') {
            notifyIconEl.className = 'fas fa-bell';
            notifyBtn.classList.remove('btn-outline-light');
            notifyBtn.classList.add('btn-outline-warning');
        } else {
            notifyIconEl.className = 'fas fa-bell-slash';
            notifyBtn.classList.remove('btn-outline-warning');
            notifyBtn.classList.add('btn-outline-light');
        }
    }

    function sendNotification(title, body, tag) {
        if (!notifyEnabled || Notification.permission !== 'granted') return;
        // Nicht senden wenn Tab aktiv ist
        if (document.visibilityState === 'visible') return;
        try {
            new Notification(title, {
                body: body,
                tag: tag || 'sr-' + Date.now(),
                icon: '/static/img/favicon.png',
                badge: '/static/img/favicon.png',
                silent: false,
            });
        } catch (e) {}
    }

    notifyBtn.addEventListener('click', async () => {
        if (!('Notification' in window)) {
            showToast('Browser unterstuetzt keine Benachrichtigungen', 'warning', 4000);
            return;
        }
        if (!notifyEnabled) {
            // Aktivieren: erst Permission anfragen
            if (Notification.permission === 'default') {
                const perm = await Notification.requestPermission();
                if (perm !== 'granted') {
                    showToast('Benachrichtigungen wurden blockiert', 'warning', 4000);
                    return;
                }
            } else if (Notification.permission === 'denied') {
                showToast('Benachrichtigungen im Browser blockiert. Bitte in den Browser-Einstellungen erlauben.', 'danger', 6000);
                return;
            }
            notifyEnabled = true;
            localStorage.setItem('sr-notify', 'true');
            showToast('Benachrichtigungen aktiviert', 'success', 3000);
        } else {
            notifyEnabled = false;
            localStorage.setItem('sr-notify', 'false');
            showToast('Benachrichtigungen deaktiviert', 'info', 3000);
        }
        updateNotifyIcon();
    });

    updateNotifyIcon();

    // --- Benachrichtigungen bei Events ---

    // Neuer Streckenrekord
    socket.on('track_record', (data) => {
        if (data) {
            const time = data.laptime_formatted || formatTime(data.laptime_ms);
            sendNotification(
                'Neuer Streckenrekord!',
                `${data.driver_name} - ${time}`,
                'sr-record'
            );
        }
    });

    // Rennende
    socket.on('race_status', (data) => {
        if (data.status === 'ended' || data.status === 'finished') {
            sendNotification(
                'Rennen beendet!',
                'Das Rennen ist zu Ende.',
                'sr-race-end'
            );
        } else if (data.status === 'running' || data.status === 'started') {
            sendNotification(
                'Rennen gestartet!',
                data.race_type ? `Typ: ${data.race_type}` : 'Los gehts!',
                'sr-race-start'
            );
        } else if (data.status === 'jumpstart') {
            sendNotification(
                'Fruehstart!',
                'Ein Fahrer hat einen Fruehstart verursacht.',
                'sr-jumpstart'
            );
        } else if (data.status === 'suspended') {
            sendNotification(
                'Rennen unterbrochen',
                'Das Rennen wurde pausiert.',
                'sr-suspended'
            );
        }
    });

    // Strafe
    socket.on('penalty', (data) => {
        if (data && data.penalty_seconds > 0) {
            const name = data.driver_name || 'Unbekannt';
            sendNotification(
                'Strafe!',
                `${name}: ${data.penalty_seconds}s Zeitstrafe`,
                'sr-penalty-' + (data.controller_id || '')
            );
        }
    });

    // VSC
    socket.on('vsc', (data) => {
        if (data.active) {
            sendNotification(
                'Virtual Safety Car',
                'VSC wurde aktiviert!',
                'sr-vsc'
            );
        }
    });

    // Tankwarnung (niedrig)
    socket.on('fuel_update', (data) => {
        if (data.fuel >= 0 && data.fuel <= 10) {
            const name = data.driver_name || 'Controller ' + (data.controller_id || '?');
            sendNotification(
                'Tankwarnung!',
                `${name}: Nur noch ${data.fuel}% Tank`,
                'sr-fuel-' + (data.controller_id || '')
            );
        }
    });

    // Auto aus Session entfernt
    socket.on('car_removed', (data) => {
        const name = data.driver_name || 'Controller ' + (data.controller_id || '?');
        sendNotification(
            'Auto entfernt',
            `${name} wurde aus der Session entfernt.`,
            'sr-removed-' + (data.controller_id || '')
        );
    });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
