<!DOCTYPE html>
<html lang="de" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SmartRace Dashboard{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    {% block styles %}{% endblock %}
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg border-bottom">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="{{ url_for('page_dashboard') }}">
                <i class="fas fa-flag-checkered me-2"></i>SmartRace Live
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_dashboard' %}active{% endif %}" href="{{ url_for('page_dashboard') }}">
                            <i class="fas fa-gauge-high me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_leaderboard' %}active{% endif %}" href="{{ url_for('page_leaderboard') }}">
                            <i class="fas fa-trophy me-1"></i> Leaderboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_analytics' %}active{% endif %}" href="{{ url_for('page_analytics') }}">
                            <i class="fas fa-chart-line me-1"></i> Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_database' %}active{% endif %}" href="{{ url_for('page_database') }}">
                            <i class="fas fa-database me-1"></i> Datenbank
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_stats' %}active{% endif %}" href="{{ url_for('page_stats') }}">
                            <i class="fas fa-chart-column me-1"></i> Statistiken
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_head_to_head' %}active{% endif %}" href="{{ url_for('page_head_to_head') }}">
                            <i class="fas fa-people-arrows me-1"></i> H2H
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_results' %}active{% endif %}" href="{{ url_for('page_results') }}">
                            <i class="fas fa-flag-checkered me-1"></i> Ergebnis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_session_compare' %}active{% endif %}" href="{{ url_for('page_session_compare') }}">
                            <i class="fas fa-columns me-1"></i> Vergleich
                        </a>
                    </li>
                </ul>
                <!-- Rennstatus Badge -->
                <span class="badge race-status-badge bg-secondary ms-3" id="raceStatusBadge" title="Rennstatus">
                    <i class="fas fa-hourglass me-1"></i> <span id="raceStatusText">Warte...</span>
                </span>
                <!-- Verbindungsstatus -->
                <span class="badge bg-warning ms-2" id="connectionBadge">
                    <i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Verbinde...
                </span>
            </div>
        </div>
    </nav>

    <!-- Toast-Container fuer Benachrichtigungen -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <!-- Hauptinhalt -->
    <main class="container-fluid px-4 py-3">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="border-top mt-4 py-3 text-center text-muted small">
        <div class="container-fluid">
            SmartRace Live Dashboard &middot; Carrera Digital Datenschnittstelle
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <script>
    // =========================================================================
    // Globale Hilfsfunktionen
    // =========================================================================
    function formatTime(timeMs) {
        if (!timeMs || timeMs <= 0) return '--:--.---';
        const minutes = Math.floor(timeMs / 60000);
        const seconds = ((timeMs % 60000) / 1000).toFixed(3);
        return minutes + ':' + seconds.padStart(6, '0');
    }

    function hexToRgba(hex, alpha) {
        if (!hex) return `rgba(128, 128, 128, ${alpha})`;
        hex = hex.replace('#', '');
        if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
        const result = /^([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        if (result) {
            return `rgba(${parseInt(result[1],16)}, ${parseInt(result[2],16)}, ${parseInt(result[3],16)}, ${alpha})`;
        }
        return `rgba(128, 128, 128, ${alpha})`;
    }

    const CONTROLLER_COLORS = {
        '1': '#e74c3c', '2': '#3498db', '3': '#2ecc71',
        '4': '#f1c40f', '5': '#e67e22', '6': '#9b59b6'
    };

    function getControllerColor(id) {
        return CONTROLLER_COLORS[String(id)] || '#95a5a6';
    }

    // =========================================================================
    // Toast-Benachrichtigungen
    // =========================================================================
    function showToast(message, type = 'info', duration = 5000) {
        const container = document.getElementById('toastContainer');
        const icons = {
            success: 'fa-check-circle text-success',
            danger: 'fa-exclamation-circle text-danger',
            warning: 'fa-exclamation-triangle text-warning',
            info: 'fa-info-circle text-info',
        };
        const id = 'toast-' + Date.now();
        const html = `<div id="${id}" class="toast show" role="alert" style="background: var(--sr-card); border: 1px solid var(--sr-border);">
            <div class="toast-body d-flex align-items-center gap-2">
                <i class="fas ${icons[type] || icons.info}"></i>
                <span style="color: var(--sr-text);">${message}</span>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
        if (duration > 0) {
            setTimeout(() => {
                const el = document.getElementById(id);
                if (el) el.remove();
            }, duration);
        }
    }

    // =========================================================================
    // WebSocket-Verbindung (mit Reconnect)
    // =========================================================================
    const socket = io({
        reconnection: true,
        reconnectionAttempts: 10,
        reconnectionDelay: 2000,
        reconnectionDelayMax: 30000,
    });
    const badge = document.getElementById('connectionBadge');

    socket.on('connect', () => {
        badge.className = 'badge bg-success ms-2';
        badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Verbunden';
    });

    socket.on('disconnect', () => {
        badge.className = 'badge bg-danger ms-2';
        badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Getrennt';
    });

    socket.on('reconnect_attempt', (attempt) => {
        badge.className = 'badge bg-warning ms-2';
        badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Verbinde... (' + attempt + ')';
    });

    socket.on('reconnect', () => {
        showToast('Verbindung wiederhergestellt', 'success', 3000);
    });

    socket.on('reconnect_failed', () => {
        badge.className = 'badge bg-danger ms-2';
        badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Offline';
        showToast('Verbindung zum Server verloren. Bitte Seite neu laden.', 'danger', 0);
    });

    socket.on('connect_error', () => {
        badge.className = 'badge bg-danger ms-2';
        badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Fehler';
    });

    // Penalty-Benachrichtigung global
    socket.on('penalty', (data) => {
        const name = data.driver_name || 'Fahrer ' + (data.controller_id || '?');
        showToast(`<strong>Strafe:</strong> ${name}`, 'warning', 6000);
    });

    // Rennstatus live aktualisieren
    const RACE_STATUS_MAP = {
        'running': { text: 'Rennen', cls: 'bg-success', icon: 'fa-play' },
        'racing': { text: 'Rennen', cls: 'bg-success', icon: 'fa-play' },
        'started': { text: 'Gestartet', cls: 'bg-success', icon: 'fa-play' },
        'paused': { text: 'Pausiert', cls: 'bg-warning', icon: 'fa-pause' },
        'finished': { text: 'Beendet', cls: 'bg-secondary', icon: 'fa-flag-checkered' },
        'waiting': { text: 'Warte...', cls: 'bg-secondary', icon: 'fa-hourglass' },
        'unknown': { text: 'Unbekannt', cls: 'bg-secondary', icon: 'fa-question' },
    };

    function updateRaceStatusBadge(status, raceType) {
        const statusBadge = document.getElementById('raceStatusBadge');
        const statusText = document.getElementById('raceStatusText');
        const s = RACE_STATUS_MAP[status] || RACE_STATUS_MAP['unknown'];
        statusBadge.className = 'badge race-status-badge ' + s.cls + ' ms-3';
        const typeLabel = raceType ? ` (${raceType})` : '';
        statusText.textContent = s.text + typeLabel;
        statusBadge.querySelector('i').className = 'fas ' + s.icon + ' me-1';
    }

    socket.on('race_status', (data) => {
        updateRaceStatusBadge(data.status, data.race_type);
    });

    // Rennstatus beim Laden holen
    fetch('/api/race-status')
        .then(r => r.ok ? r.json() : null)
        .then(data => {
            if (data) updateRaceStatusBadge(data.status, data.race_type);
        })
        .catch(() => {});
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
