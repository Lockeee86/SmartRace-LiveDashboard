<!DOCTYPE html>
<html lang="de" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SmartRace Dashboard{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    {% block styles %}{% endblock %}
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg border-bottom">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="{{ url_for('page_dashboard') }}">
                <i class="fas fa-flag-checkered me-2"></i>SmartRace Live
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_dashboard' %}active{% endif %}" href="{{ url_for('page_dashboard') }}">
                            <i class="fas fa-gauge-high me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_leaderboard' %}active{% endif %}" href="{{ url_for('page_leaderboard') }}">
                            <i class="fas fa-trophy me-1"></i> Leaderboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_analytics' %}active{% endif %}" href="{{ url_for('page_analytics') }}">
                            <i class="fas fa-chart-line me-1"></i> Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'page_database' %}active{% endif %}" href="{{ url_for('page_database') }}">
                            <i class="fas fa-database me-1"></i> Datenbank
                        </a>
                    </li>
                </ul>
                <!-- Verbindungsstatus -->
                <span class="badge bg-success ms-3" id="connectionBadge">
                    <i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Verbunden
                </span>
            </div>
        </div>
    </nav>

    <!-- Hauptinhalt -->
    <main class="container-fluid px-4 py-3">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="border-top mt-4 py-3 text-center text-muted small">
        <div class="container-fluid">
            SmartRace Live Dashboard &middot; Carrera Digital Datenschnittstelle
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
    // Globale Hilfsfunktionen
    function formatTime(timeMs) {
        if (!timeMs || timeMs <= 0) return '--:--.---';
        const minutes = Math.floor(timeMs / 60000);
        const seconds = ((timeMs % 60000) / 1000).toFixed(3);
        return minutes + ':' + seconds.padStart(6, '0');
    }

    function hexToRgba(hex, alpha) {
        if (!hex) return `rgba(128, 128, 128, ${alpha})`;
        hex = hex.replace('#', '');
        if (hex.length === 3) {
            hex = hex.split('').map(c => c + c).join('');
        }
        const result = /^([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        if (result) {
            return `rgba(${parseInt(result[1],16)}, ${parseInt(result[2],16)}, ${parseInt(result[3],16)}, ${alpha})`;
        }
        return `rgba(128, 128, 128, ${alpha})`;
    }

    const CONTROLLER_COLORS = {
        '1': '#e74c3c', '2': '#3498db', '3': '#2ecc71',
        '4': '#f1c40f', '5': '#e67e22', '6': '#9b59b6'
    };

    function getControllerColor(id) {
        return CONTROLLER_COLORS[String(id)] || '#95a5a6';
    }

    // Verbindungsstatus pruefen
    async function checkConnection() {
        const badge = document.getElementById('connectionBadge');
        try {
            const res = await fetch('/api/health');
            if (res.ok) {
                badge.className = 'badge bg-success ms-3';
                badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Verbunden';
            } else {
                throw new Error();
            }
        } catch {
            badge.className = 'badge bg-danger ms-3';
            badge.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 0.5rem; vertical-align: middle;"></i> Getrennt';
        }
    }
    setInterval(checkConnection, 15000);
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
