{% extends "base.html" %}

{% block title %}Dashboard - SmartRace{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Race Dashboard</h2>
    </div>
</div>

<!-- Session Info Row -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">üèÅ Schnellste Runde (Session)</h5>
                <h3 id="fastest-lap-time">--:--.---</h3>
                <p id="fastest-lap-driver" class="mb-0">Kein Fahrer</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">üèÜ Streckenrekord</h5>
                <h3 id="track-record-time">--:--.---</h3>
                <p id="track-record-driver" class="mb-0">Unbekannt</p>
                <small id="track-record-date" class="text-light">--</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">üìä Session Stats</h5>
                <div class="row">
                    <div class="col-6">
                        <strong id="total-laps">0</strong><br>
                        <small>Runden</small>
                    </div>
                    <div class="col-6">
                        <strong id="active-drivers">0</strong><br>
                        <small>Fahrer</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Current Standings -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Current Standings</h5>
                <div class="table-responsive">
                    <table class="table table-striped" id="standings-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Fahrer</th>
                                <th>Auto</th>
                                <th>Beste Zeit</th>
                                <th>Letzte Runde</th>
                                <th>Runden</th>
                                <th>Diff</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Live Activity</h5>
                <div id="live-feed" style="height: 400px; overflow-y:auto;">
                    <p class="text-muted">Warten auf Daten...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Controller Overview - 6 Tables -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">üéÆ Controller Overview - Letzte 6 Zeiten</h5>
                <div class="controllers-grid">
                    
                    <!-- Controller 1 -->
                    <div class="controller-table" id="controller-1">
                        <h6 class="controller-header">üéÆ Controller 1</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-1-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controller 2 -->
                    <div class="controller-table" id="controller-2">
                        <h6 class="controller-header">üéÆ Controller 2</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-2-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controller 3 -->
                    <div class="controller-table" id="controller-3">
                        <h6 class="controller-header">üéÆ Controller 3</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-3-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controller 4 -->
                    <div class="controller-table" id="controller-4">
                        <h6 class="controller-header">üéÆ Controller 4</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-4-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controller 5 -->
                    <div class="controller-table" id="controller-5">
                        <h6 class="controller-header">üéÆ Controller 5</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-5-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controller 6 -->
                    <div class="controller-table" id="controller-6">
                        <h6 class="controller-header">üéÆ Controller 6</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-6-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let dashboardData = {};
let sessionFastestLap = null;
let trackRecord = null;
    
async function updateDashboard() {
    try {
        console.log('üöÄ Lade Live-Daten...');
        const response = await fetch('/api/live-data');
        console.log('üì° Response Status:', response.status);
        
        const rawText = await response.text();
        console.log('üìÑ Raw Response:', rawText);
        
        dashboardData = JSON.parse(rawText);
        console.log('üìä Live-Daten erhalten:', dashboardData);
        
        // Detaillierte Controller-Logs
        Object.keys(dashboardData).forEach(controllerId => {
            const controller = dashboardData[controllerId];
            console.log(`üéÆ Controller ${controllerId}: ${controller.name} - ${controller.laps ? controller.laps.length : 0} laps`);
        });
        
        // Alle Dashboard-Komponenten aktualisieren
        updateSessionStats();
        updateCurrentStandings();
        updateLiveActivity();
        updateControllerTables();
        
    } catch (error) {
        console.error('‚ùå Fehler beim Laden der Live-Daten:', error);
        // Bei Fehlern leeres Dashboard anzeigen
        document.getElementById('session-laps').textContent = '0';
        document.getElementById('session-fastest').textContent = '--:--.---';
    }
}

function updateSessionStats() {
    console.log('üìä Aktualisiere Session Stats...');
    
    let totalLaps = 0;
    let activeFahrerCount = 0;
    let sessionBest = null;
    let sessionBestDriver = '';
    
    // Durch alle Controller iterieren
    Object.values(dashboardData).forEach(controller => {
        if (controller.laps && controller.laps.length > 0) {
            activeFahrerCount++;
            
            // H√∂chste Rundenzahl f√ºr diesen Controller
            const maxLap = Math.max(...controller.laps.map(lap => lap.lap || 0));
            totalLaps = Math.max(totalLaps, maxLap);
            
            // Session-Bestzeit pr√ºfen
            if (controller.best_time_raw && controller.best_time_raw > 0) {
                if (sessionBest === null || controller.best_time_raw < sessionBest) {
                    sessionBest = controller.best_time_raw;
                    sessionBestDriver = controller.name;
                }
            }
        }
    });
    
    // UI aktualisieren
    document.getElementById('session-laps').textContent = totalLaps;
    document.getElementById('session-drivers').textContent = activeFahrerCount;
    document.getElementById('session-fastest').textContent = 
        sessionBest ? formatTime(sessionBest) : '--:--.---';
    
    // Track Record (Dummy-Wert oder aus DB)
    document.getElementById('track-record').textContent = '1:23.456';
    
    console.log(`üìä Session Stats: ${totalLaps} Runden, ${activeFahrerCount} Fahrer`);
}

function updateCurrentStandings() {
    console.log('üèÜ Aktualisiere Current Standings...');
    
    const tbody = document.getElementById('standings-body');
    tbody.innerHTML = '';
    
    // Controllers nach Rundenanzahl sortieren
    const standings = Object.entries(dashboardData)
        .map(([controllerId, data]) => {
            const maxLap = data.laps && data.laps.length > 0 
                ? Math.max(...data.laps.map(lap => lap.lap || 0))
                : 0;
            
            return {
                controllerId,
                name: data.name,
                car: data.car,
                color: data.color,
                maxLap: maxLap,
                bestTime: data.best_time_formatted || '--:--.---',
                avgTime: data.avg_time || '--:--.---',
                lapCount: data.lap_count || 0
            };
        })
        .filter(driver => driver.maxLap > 0) // Nur Fahrer mit Runden
        .sort((a, b) => {
            // Erst nach Runden, dann nach Bestzeit
            if (b.maxLap !== a.maxLap) {
                return b.maxLap - a.maxLap;
            }
            // Bei gleichen Runden: nach Bestzeit
            if (a.bestTime === '--:--.---') return 1;
            if (b.bestTime === '--:--.---') return -1;
            return parseTime(a.bestTime) - parseTime(b.bestTime);
        });
    
    standings.forEach((driver, index) => {
        const row = document.createElement('tr');
        
        // Position-Badge
        let positionClass = 'bg-secondary';
        if (index === 0) positionClass = 'bg-warning';
        else if (index === 1) positionClass = 'bg-secondary';
        else if (index === 2) positionClass = 'bg-danger';
        
        row.innerHTML = `
            <td><span class="badge ${positionClass}">${index + 1}</span></td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="controller-dot" style="background-color: ${driver.color}"></div>
                    <div>
                        <div class="fw-bold">${driver.name}</div>
                        <small class="text-muted">${driver.car}</small>
                    </div>
                </div>
            </td>
            <td><span class="badge bg-primary">${driver.maxLap}</span></td>
            <td><code>${driver.bestTime}</code></td>
            <td><code>${driver.avgTime}</code></td>
        `;
        
        tbody.appendChild(row);
    });
    
    console.log(`üèÜ Standings: ${standings.length} Fahrer`);
}

function updateLiveActivity() {
    console.log('‚ö° Aktualisiere Live Activity...');
    
    const tbody = document.getElementById('live-activity-body');
    tbody.innerHTML = '';
    
    // Alle Runden sammeln und sortieren
    let allLaps = [];
    
    Object.entries(dashboardData).forEach(([controllerId, controller]) => {
        if (controller.laps && controller.laps.length > 0) {
            controller.laps.forEach(lap => {
                allLaps.push({
                    ...lap,
                    driver_name: controller.name,
                    driver_color: controller.color,
                    car_name: controller.car
                });
            });
        }
    });
    
    // Nach Timestamp sortieren (neueste zuerst)
    allLaps.sort((a, b) => {
        const timeA = new Date(a.timestamp);
        const timeB = new Date(b.timestamp);
        return timeB - timeA;
    });
    
    // Top 5 anzeigen
    allLaps.slice(0, 5).forEach(lap => {
        const row = document.createElement('tr');
        
        // Status Badge
        let statusBadge = '<span class="badge bg-secondary">--</span>';
        if (lap.is_pb) {
            statusBadge = '<span class="badge bg-success">PB</span>';
        } else if (lap.laptime_raw && lap.laptime_raw > 0) {
            statusBadge = '<span class="badge bg-primary">LAP</span>';
        }
        
        // Zeit formatieren
        const timeStr = new Date(lap.timestamp).toLocaleTimeString();
        
        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <div class="controller-dot" style="background-color: ${lap.driver_color}"></div>
                    <span>${lap.driver_name}</span>
                </div>
            </td>
            <td><strong>Runde ${lap.lap}</strong></td>
            <td><code>${lap.laptime_formatted}</code></td>
            <td>
                <small class="text-muted">${timeStr}</small><br>
                ${statusBadge}
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    console.log(`‚ö° Live Activity: ${allLaps.length} total laps, showing ${Math.min(5, allLaps.length)}`);
}

function updateControllerTables() {
    console.log('üéÆ Aktualisiere Controller Tables...');
    
    // F√ºr jeden Controller 1-6
    for (let controllerId = 1; controllerId <= 6; controllerId++) {
        const controllerKey = controllerId.toString();
        const controllerElement = document.getElementById(`controller-${controllerId}`);
        const tbodyElement = document.getElementById(`controller-${controllerId}-times`);
        
        if (dashboardData[controllerKey] && dashboardData[controllerKey].laps && dashboardData[controllerKey].laps.length > 0) {
            const data = dashboardData[controllerKey];
            
            // Controller anzeigen
            controllerElement.style.display = 'block';
            
            // Header stylen
            const header = controllerElement.querySelector('.controller-header');
            header.textContent = `üéÆ Controller ${controllerId}`;
            header.style.background = `linear-gradient(135deg, ${data.color}, ${data.color}CC)`;
            header.style.color = '#fff';
            header.style.textShadow = '0 1px 2px rgba(0,0,0,0.3)';
            
            // Driver Info
            const driverName = controllerElement.querySelector('.driver-name');
            const carName = controllerElement.querySelector('.car-name');
            driverName.textContent = data.name;
            carName.textContent = data.car;
            
            // Runden-Tabelle leeren
            tbodyElement.innerHTML = '';
            
            // Runden nach Lap-Nummer sortieren
            const sortedLaps = [...data.laps].sort((a, b) => a.lap - b.lap);
            
            console.log(`üéÆ Controller ${controllerId} (${data.name}): ${sortedLaps.length} Runden`);
            
            // Runden in Tabelle einf√ºgen
            sortedLaps.forEach(lap => {
                const row = document.createElement('tr');
                
                // Status bestimmen
                let statusBadge = '<span class="badge bg-secondary">--</span>';
                if (lap.is_pb) {
                    statusBadge = '<span class="badge bg-success">PB</span>';
                    row.classList.add('table-success');
                } else if (lap.laptime_raw && lap.laptime_raw > 0) {
                    statusBadge = '<span class="badge bg-primary">OK</span>';
                }
                
                row.innerHTML = `
                    <td><strong>R${lap.lap}</strong></td>
                    <td><code>${lap.laptime_formatted || '--:--.---'}</code></td>
                    <td>${statusBadge}</td>
                `;
                
                tbodyElement.appendChild(row);
            });
            
        } else {
            // Controller verstecken wenn keine Daten
            controllerElement.style.display = 'none';
        }
    }
}

// Helper Functions
function formatTime(milliseconds) {
    if (!milliseconds || milliseconds <= 0) return '--:--.---';
    
    const totalSeconds = milliseconds / 1000;
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    
    return `${minutes}:${seconds.toFixed(3).padStart(6, '0')}`;
}

function parseTime(timeString) {
    if (!timeString || timeString === '--:--.---') return Infinity;
    
    const parts = timeString.split(':');
    if (parts.length !== 2) return Infinity;
    
    const minutes = parseInt(parts[0]);
    const seconds = parseFloat(parts[1]);
    
    return (minutes * 60 + seconds) * 1000; // Zur√ºck zu Millisekunden
}

// Dashboard starten
console.log('üöÄ Dashboard wird gestartet...');
updateDashboard();

// Auto-Update alle 3 Sekunden
setInterval(updateDashboard, 3000);
console.log('‚è±Ô∏è Auto-Update aktiv (alle 3s)');
</script>

{% endblock %}
