{% extends "base.html" %}

{% block title %}Dashboard - SmartRace Live{% endblock %}

{% block content %}
<!-- Session-Auswahl -->
<div class="session-selector d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0"><i class="fas fa-gauge-high me-2"></i>Race Dashboard</h5>
    <div class="d-flex align-items-center gap-2">
        <select id="sessionSelect" class="form-select form-select-sm" style="min-width: 280px;">
            <option value="current">Aktuelle Session (Live)</option>
            <option value="all">Alle Sessions</option>
        </select>
        <button id="refreshBtn" class="btn btn-sm btn-outline-primary" title="Aktualisieren">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
</div>

<!-- Stat Cards -->
<div class="row g-3 mb-3">
    <div class="col-md-4">
        <div class="card stat-card fastest">
            <div class="card-body py-3">
                <div class="stat-label mb-1"><i class="fas fa-bolt me-1"></i> Schnellste Runde</div>
                <div class="stat-value" id="fastestTime">--:--.---</div>
                <div class="small mt-1" id="fastestDriver">Warte auf Daten...</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card record">
            <div class="card-body py-3">
                <div class="stat-label mb-1"><i class="fas fa-trophy me-1"></i> Streckenrekord</div>
                <div class="stat-value" id="recordTime">--:--.---</div>
                <div class="small mt-1" id="recordDriver">--</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card stats">
            <div class="card-body py-3">
                <div class="stat-label mb-2"><i class="fas fa-chart-bar me-1"></i> Session Stats</div>
                <div class="row text-center g-2">
                    <div class="col-3">
                        <div class="fw-bold fs-5" id="totalLaps">0</div>
                        <div class="small text-muted">Runden</div>
                    </div>
                    <div class="col-3">
                        <div class="fw-bold fs-5" id="activeDrivers">0</div>
                        <div class="small text-muted">Fahrer</div>
                    </div>
                    <div class="col-3">
                        <div class="fw-bold fs-5" id="sessionDuration">--</div>
                        <div class="small text-muted">Dauer</div>
                    </div>
                    <div class="col-3">
                        <div class="fw-bold fs-5 font-mono" id="avgLap">--</div>
                        <div class="small text-muted">Schnitt</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Controller Cards -->
<div class="controller-grid" id="controllerGrid">
    <!-- Wird per JavaScript gefuellt -->
</div>
{% endblock %}

{% block scripts %}
<script>
let dashboardData = {};
let trackRecord = null;
let currentSession = 'current';

// Sessions laden
async function loadSessions() {
    try {
        const res = await fetch('/api/sessions');
        if (!res.ok) return;
        const sessions = await res.json();
        const sel = document.getElementById('sessionSelect');
        sel.innerHTML = '<option value="current">Aktuelle Session (Live)</option><option value="all">Alle Sessions</option>';
        sessions.forEach(s => {
            const date = s.start_time ? new Date(s.start_time).toLocaleDateString('de-DE') : '';
            const opt = document.createElement('option');
            opt.value = s.session_id;
            opt.textContent = `${s.session_type || 'Training'} - ${date} - ${s.total_laps} Runden`;
            sel.appendChild(opt);
        });
        sel.value = currentSession;
    } catch (e) {
        console.error('Sessions laden fehlgeschlagen:', e);
    }
}

// Hauptdaten laden
async function updateDashboard() {
    try {
        let url = '/api/live-data';
        if (currentSession !== 'current' && currentSession !== 'all') {
            url += '?session_id=' + encodeURIComponent(currentSession);
        }
        const res = await fetch(url);
        if (!res.ok) return;
        dashboardData = await res.json();
        renderStats();
        renderControllers();
    } catch (e) {
        console.error('Dashboard-Update fehlgeschlagen:', e);
    }
}

// Session-Runden filtern (bei "current" nur letzte 30 Min)
function getSessionLaps(controllerData) {
    if (!controllerData.laps || controllerData.laps.length === 0) return [];
    if (currentSession !== 'current') return controllerData.laps;

    const sorted = [...controllerData.laps].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    if (!sorted[0] || !sorted[0].timestamp) return controllerData.laps;
    const latest = new Date(sorted[0].timestamp);
    const cutoff = new Date(latest.getTime() - 30 * 60 * 1000);
    return controllerData.laps.filter(l => new Date(l.timestamp) >= cutoff);
}

// Stats rendern
function renderStats() {
    let totalLaps = 0, activeDrivers = 0, allTimes = [];
    let fastest = null;
    let startTime = null, endTime = null;

    Object.entries(dashboardData).forEach(([cid, cd]) => {
        const laps = getSessionLaps(cd);
        if (laps.length === 0) return;
        activeDrivers++;

        // Fix: Rundenanzahl = Summe aller Runden pro Controller
        totalLaps += laps.length;

        laps.forEach(l => {
            if (l.laptime_raw > 0) allTimes.push(l.laptime_raw);
            if (l.timestamp) {
                const ts = new Date(l.timestamp);
                if (!startTime || ts < startTime) startTime = ts;
                if (!endTime || ts > endTime) endTime = ts;
            }
        });

        if (cd.best_time_raw && (!fastest || cd.best_time_raw < fastest.time)) {
            fastest = { time: cd.best_time_raw, driver: cd.name || ('Fahrer ' + cid) };
        }
    });

    document.getElementById('totalLaps').textContent = totalLaps;
    document.getElementById('activeDrivers').textContent = activeDrivers;

    if (fastest) {
        document.getElementById('fastestTime').textContent = formatTime(fastest.time);
        document.getElementById('fastestDriver').textContent = fastest.driver;

        if (!trackRecord || fastest.time < trackRecord.time) {
            trackRecord = { time: fastest.time, driver: fastest.driver };
        }
    }

    if (trackRecord) {
        document.getElementById('recordTime').textContent = formatTime(trackRecord.time);
        document.getElementById('recordDriver').textContent = trackRecord.driver;
    }

    // Dauer
    if (startTime && endTime) {
        const ms = endTime - startTime;
        const min = Math.floor(ms / 60000);
        if (min >= 60) {
            document.getElementById('sessionDuration').textContent = Math.floor(min/60) + 'h ' + (min%60) + 'm';
        } else {
            document.getElementById('sessionDuration').textContent = min + 'm';
        }
    }

    // Durchschnitt
    if (allTimes.length > 0) {
        const avg = allTimes.reduce((a,b) => a+b, 0) / allTimes.length;
        document.getElementById('avgLap').textContent = formatTime(avg);
    }
}

// Controller-Karten rendern
function renderControllers() {
    const grid = document.getElementById('controllerGrid');
    const controllerIds = Object.keys(dashboardData).sort((a,b) => parseInt(a) - parseInt(b));
    const allIds = ['1','2','3','4','5','6'];
    const idsToShow = [...new Set([...allIds, ...controllerIds])].sort((a,b) => parseInt(a) - parseInt(b));

    grid.innerHTML = idsToShow.map(cid => {
        const cd = dashboardData[cid];
        const color = (cd && cd.color && cd.color !== '#333333') ? cd.color : getControllerColor(cid);
        const laps = cd ? getSessionLaps(cd) : [];
        const hasData = laps.length > 0;

        const driverName = hasData ? (cd.name || 'Fahrer ' + cid) : 'Controller ' + cid;
        const carName = hasData ? (cd.car || '') : 'Keine Daten';

        // Bestzeit dieses Controllers
        const times = laps.map(l => l.laptime_raw).filter(t => t > 0);
        const bestTime = times.length > 0 ? Math.min(...times) : null;

        // Globale Bestzeit fuer Highlight
        let globalBest = null;
        Object.values(dashboardData).forEach(d => {
            if (d.best_time_raw && (!globalBest || d.best_time_raw < globalBest)) {
                globalBest = d.best_time_raw;
            }
        });
        const isGlobalBest = bestTime && bestTime === globalBest;

        // Penalties & Status
        const penalties = cd ? (cd.penalties || 0) : 0;
        const isRetired = cd ? cd.retired : false;
        const isDQ = cd ? cd.disqualified : false;

        // Letzte Runde fuer Sektoren
        const recentLaps = [...laps].sort((a,b) => (b.lap || 0) - (a.lap || 0));
        const latestLap = recentLaps[0] || {};
        const displayLaps = recentLaps.slice(0, 8);

        // Status-Badges
        let statusBadges = '';
        if (isDQ) statusBadges += '<span class="badge bg-danger ms-1">DQ</span>';
        else if (isRetired) statusBadges += '<span class="badge bg-warning text-dark ms-1">DNF</span>';
        if (penalties > 0) statusBadges += `<span class="badge bg-danger ms-1"><i class="fas fa-exclamation-triangle"></i> ${penalties}</span>`;

        // Sektoren der letzten Runde
        let sectorHtml = '';
        if (latestLap.sector_1 || latestLap.sector_2 || latestLap.sector_3) {
            sectorHtml = `<div class="sector-row">
                <span class="sector-badge" title="Sektor 1">S1: ${latestLap.sector_1 || '--'}</span>
                <span class="sector-badge" title="Sektor 2">S2: ${latestLap.sector_2 || '--'}</span>
                <span class="sector-badge" title="Sektor 3">S3: ${latestLap.sector_3 || '--'}</span>
            </div>`;
        }

        let tableRows = '';
        if (displayLaps.length > 0) {
            tableRows = displayLaps.map((l, idx) => {
                let cls = '';
                if (l.laptime_raw === bestTime && bestTime > 0) cls = 'row-pb';
                else if (idx === 0) cls = 'row-latest';
                const icon = (l.laptime_raw === bestTime && bestTime > 0) ? '<i class="fas fa-trophy text-warning"></i>' : (idx === 0 ? '<i class="fas fa-flag text-info"></i>' : '');
                return `<tr class="${cls}">
                    <td class="text-center">${l.lap || '-'}</td>
                    <td class="font-mono text-center">${l.laptime_formatted || formatTime(l.laptime_raw)}</td>
                    <td class="text-center">${icon}</td>
                </tr>`;
            }).join('');
        } else {
            tableRows = '<tr><td colspan="3" class="text-center text-muted py-3"><small>Noch keine Runden</small></td></tr>';
        }

        return `
        <div class="controller-card ${isRetired ? 'retired' : ''} ${isDQ ? 'disqualified' : ''}" style="--controller-color: ${color}; opacity: ${hasData ? 1 : 0.5}">
            <div class="driver-header d-flex justify-content-between align-items-start">
                <div>
                    <div class="driver-name">${driverName}${statusBadges}</div>
                    <div class="car-name">${carName}</div>
                    ${sectorHtml}
                </div>
                <div class="text-end">
                    <span class="controller-badge" style="background: ${color}">C${cid}</span>
                    ${bestTime ? `<div class="best-time mt-1 ${isGlobalBest ? 'text-warning' : ''}">${isGlobalBest ? '<i class="fas fa-trophy me-1"></i>' : '<i class="fas fa-stopwatch me-1 text-muted"></i>'}${formatTime(bestTime)}</div>` : ''}
                    <div class="small text-muted mt-1">${laps.length} Runden</div>
                </div>
            </div>
            <table class="table table-sm mb-0">
                <thead><tr>
                    <th class="text-center">Runde</th>
                    <th class="text-center">Zeit</th>
                    <th class="text-center" style="width: 40px;"></th>
                </tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>`;
    }).join('');
}

// Event-Listener
document.addEventListener('DOMContentLoaded', async () => {
    await loadSessions();
    await updateDashboard();
});

document.getElementById('sessionSelect').addEventListener('change', function() {
    currentSession = this.value;
    updateDashboard();
});

document.getElementById('refreshBtn').addEventListener('click', async () => {
    const btn = document.getElementById('refreshBtn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    await loadSessions();
    await updateDashboard();
    btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
    btn.disabled = false;
});

// WebSocket: Live-Updates statt Polling
socket.on('new_data', () => {
    updateDashboard();
});

// Fallback: alle 10 Sekunden aktualisieren
setInterval(updateDashboard, 10000);
</script>
{% endblock %}
