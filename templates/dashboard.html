{% extends "base.html" %}

{% block title %}Dashboard - SmartRace Live{% endblock %}

{% block content %}
<!-- Session-Auswahl -->
<div class="session-selector d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0"><i class="fas fa-gauge-high me-2"></i>Race Dashboard</h5>
    <div class="d-flex align-items-center gap-2">
        <select id="sessionSelect" class="form-select form-select-sm" style="min-width: 280px;">
            <option value="current">Aktuelle Session (Live)</option>
            <option value="all">Alle Sessions</option>
        </select>
        <!-- Controller Filter Dropdown -->
        <div class="dropdown" id="controllerFilterDropdown">
            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" title="Controller filtern">
                <i class="fas fa-gamepad me-1"></i><span id="controllerFilterLabel">Alle</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end p-2" style="min-width: 200px;">
                <li>
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0" id="ctrlAll" checked>
                        <span class="fw-bold">Alle Controller</span>
                    </label>
                </li>
                <li><hr class="dropdown-divider my-1"></li>
                <li class="ctrl-option" data-cid="1">
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 ctrl-cb" value="1" checked>
                        <span class="ctrl-dot" style="background:#e74c3c"></span>Controller 1
                    </label>
                </li>
                <li class="ctrl-option" data-cid="2">
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 ctrl-cb" value="2" checked>
                        <span class="ctrl-dot" style="background:#3498db"></span>Controller 2
                    </label>
                </li>
                <li class="ctrl-option" data-cid="3">
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 ctrl-cb" value="3" checked>
                        <span class="ctrl-dot" style="background:#2ecc71"></span>Controller 3
                    </label>
                </li>
                <li class="ctrl-option" data-cid="4">
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 ctrl-cb" value="4" checked>
                        <span class="ctrl-dot" style="background:#f1c40f"></span>Controller 4
                    </label>
                </li>
                <li class="ctrl-option" data-cid="5">
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 ctrl-cb" value="5" checked>
                        <span class="ctrl-dot" style="background:#9b59b6"></span>Controller 5
                    </label>
                </li>
                <li class="ctrl-option" data-cid="6">
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 ctrl-cb" value="6" checked>
                        <span class="ctrl-dot" style="background:#e67e22"></span>Controller 6
                    </label>
                </li>
            </ul>
        </div>
        <!-- Layout Toggle -->
        <button id="layoutToggleBtn" class="btn btn-sm btn-outline-light" title="Grid/Listen-Ansicht">
            <i class="fas fa-th-large" id="layoutIcon"></i>
        </button>
        <!-- Widget Visibility Toggle -->
        <div class="dropdown" id="widgetToggleDropdown">
            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" title="Widgets ein/ausblenden">
                <i class="fas fa-eye"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end p-2" style="min-width: 200px;">
                <li class="small text-muted px-2 pb-1">Widgets anzeigen:</li>
                <li>
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 widget-vis-cb" value="fastest" checked>
                        <i class="fas fa-bolt text-info"></i> Schnellste Runde
                    </label>
                </li>
                <li>
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 widget-vis-cb" value="record" checked>
                        <i class="fas fa-trophy text-success"></i> Streckenrekord
                    </label>
                </li>
                <li>
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 widget-vis-cb" value="consistency" checked>
                        <i class="fas fa-bullseye text-warning"></i> Konsistenz
                    </label>
                </li>
                <li>
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 widget-vis-cb" value="stats" checked>
                        <i class="fas fa-chart-bar" style="color: #9b59b6"></i> Session Stats
                    </label>
                </li>
            </ul>
        </div>
        <button id="refreshBtn" class="btn btn-sm btn-outline-primary" title="Aktualisieren">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
</div>

<!-- Stat Cards (Drag & Drop) -->
<div class="row g-3 mb-3" id="widgetRow">
    <div class="col-md-4 col-lg-3 widget-col" data-widget="fastest" draggable="true">
        <div class="card stat-card fastest h-100">
            <div class="card-body py-3">
                <div class="stat-label mb-1"><i class="fas fa-bolt me-1"></i> Schnellste Runde</div>
                <div class="stat-value" id="fastestTime">--:--.---</div>
                <div class="small mt-1" id="fastestDriver">Warte auf Daten...</div>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-3 widget-col" data-widget="record" draggable="true">
        <div class="card stat-card record h-100">
            <div class="card-body py-3">
                <div class="stat-label mb-1"><i class="fas fa-trophy me-1"></i> Streckenrekord</div>
                <div class="stat-value" id="recordTime">--:--.---</div>
                <div class="small mt-1" id="recordDriver">--</div>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-3 widget-col" data-widget="consistency" draggable="true">
        <div class="card stat-card h-100" style="background: linear-gradient(135deg, #2d2020, #1a1212); border-left: 4px solid #e67e22;">
            <div class="card-body py-3">
                <div class="stat-label mb-1"><i class="fas fa-bullseye me-1"></i> Konsistenz</div>
                <div class="stat-value" id="consistencyDriver">--</div>
                <div class="small mt-1" id="consistencyDetail">Gleichmaessigster Fahrer</div>
            </div>
        </div>
    </div>
    <div class="col-md-12 col-lg-3 widget-col" data-widget="stats" draggable="true">
        <div class="card stat-card stats h-100">
            <div class="card-body py-3">
                <div class="stat-label mb-2"><i class="fas fa-chart-bar me-1"></i> Session Stats</div>
                <div class="row text-center g-2">
                    <div class="col-3">
                        <div class="fw-bold fs-5" id="totalLaps">0</div>
                        <div class="small text-muted">Runden</div>
                    </div>
                    <div class="col-3">
                        <div class="fw-bold fs-5" id="activeDrivers">0</div>
                        <div class="small text-muted">Fahrer</div>
                    </div>
                    <div class="col-3">
                        <div class="fw-bold fs-5" id="sessionDuration">--</div>
                        <div class="small text-muted">Dauer</div>
                    </div>
                    <div class="col-3">
                        <div class="fw-bold fs-5 font-mono" id="avgLap">--</div>
                        <div class="small text-muted">Schnitt</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live-Feed Ticker + Controller Cards -->
<div class="row g-3">
    <!-- Controller Cards -->
    <div class="col-lg-9">
        <div class="controller-grid" id="controllerGrid">
            <!-- Wird per JavaScript gefuellt -->
        </div>
    </div>
    <!-- Live-Feed Ticker -->
    <div class="col-lg-3">
        <div class="card" style="height: 100%; max-height: 600px;">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-rss me-1"></i> Live-Ticker</span>
                <span class="badge bg-danger pulse" style="font-size: 0.65rem;">LIVE</span>
            </div>
            <div class="card-body p-0" style="overflow-y: auto;" id="liveFeedContainer">
                <div class="text-center text-muted py-4 small">Warte auf Events...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let dashboardData = {};
let trackRecord = null;
let currentSession = 'current';
let visibleControllers = new Set(['1','2','3','4','5','6']);
let fuelLevels = {}; // {controller_id: fuel_pct}
let dashLayout = localStorage.getItem('sr-layout') || 'grid';
let previousRanking = []; // fuer Ueberholung-Erkennung

// Streckenrekord aus DB laden
async function loadTrackRecord() {
    try {
        const res = await fetch('/api/track-record');
        if (!res.ok) return;
        const rec = await res.json();
        if (rec && rec.laptime_ms) {
            trackRecord = { time: rec.laptime_ms, driver: rec.driver_name };
            document.getElementById('recordTime').textContent = rec.laptime_formatted;
            document.getElementById('recordDriver').textContent = `${rec.driver_name} (${rec.car_name || '--'})`;
        }
    } catch (e) {
        console.error('Streckenrekord-Fehler:', e);
    }
}

// Live-Feed laden
async function loadLiveFeed() {
    try {
        const res = await fetch('/api/live-feed?limit=25');
        if (!res.ok) return;
        const apiItems = await res.json();
        // Echtzeit-Events (vsc, fuel_warning, car_removed, track) behalten
        const realtimeTypes = ['vsc', 'fuel_warning', 'car_removed', 'track', 'overtake'];
        const realtimeItems = liveFeedItems.filter(i => realtimeTypes.includes(i.type));
        // API-Items + Echtzeit-Events zusammenfuehren, nach Zeit sortieren
        liveFeedItems = [...apiItems, ...realtimeItems]
            .sort((a, b) => (b.timestamp || '').localeCompare(a.timestamp || ''))
            .slice(0, 50);
        renderLiveFeed(liveFeedItems);
    } catch (e) {
        console.error('Live-Feed-Fehler:', e);
    }
}

function renderLiveFeed(items) {
    const container = document.getElementById('liveFeedContainer');
    if (!items || items.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4 small">Warte auf Events...</div>';
        return;
    }
    container.innerHTML = items.map(item => {
        const time = item.timestamp ? new Date(item.timestamp).toLocaleTimeString('de-DE') : '--';
        const color = item.color || '#666';

        if (item.type === 'lap') {
            const pbIcon = item.is_pb ? ' <i class="fas fa-trophy text-warning"></i>' : '';
            return `<div class="feed-item feed-lap" style="border-left-color: ${color}">
                <div class="feed-time">${time}</div>
                <div class="feed-content">
                    <strong>${item.driver_name}</strong> - Runde ${item.lap_number}${pbIcon}
                    <div class="feed-detail font-mono">${item.laptime_formatted}</div>
                </div>
            </div>`;
        }
        if (item.type === 'penalty') {
            const secs = item.penalty_seconds || 0;
            const detail = secs > 0 ? `${secs}s Strafe` : (item.penalty_type || 'Strafe abgesessen');
            return `<div class="feed-item feed-penalty">
                <div class="feed-time">${time}</div>
                <div class="feed-content">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    <strong>${item.driver_name}</strong> - ${detail}
                </div>
            </div>`;
        }
        if (item.type === 'status') {
            const sMap = typeof RACE_STATUS_MAP !== 'undefined' ? RACE_STATUS_MAP : {};
            const s = sMap[item.status] || { text: item.status, icon: 'fa-flag' };
            return `<div class="feed-item feed-status">
                <div class="feed-time">${time}</div>
                <div class="feed-content">
                    <i class="fas ${s.icon} text-info"></i>
                    Status: <strong>${s.text}</strong> ${item.race_type ? '(' + item.race_type + ')' : ''}
                </div>
            </div>`;
        }
        if (item.type === 'record') {
            return `<div class="feed-item feed-record">
                <div class="feed-time">${time}</div>
                <div class="feed-content">
                    <i class="fas fa-star text-warning"></i>
                    <strong>NEUER REKORD!</strong> ${item.driver_name} - ${item.laptime_formatted}
                </div>
            </div>`;
        }
        if (item.type === 'dnf' || item.type === 'dq') {
            const icon = item.type === 'dnf' ? 'fa-ban text-warning' : 'fa-times-circle text-danger';
            const label = item.type === 'dnf' ? 'DNF' : 'DQ';
            return `<div class="feed-item feed-${item.type}">
                <div class="feed-time">${time}</div>
                <div class="feed-content">
                    <i class="fas ${icon}"></i>
                    <strong>${item.driver_name}</strong> - ${label}
                </div>
            </div>`;
        }
        if (item.type === 'vsc') {
            const vscText = item.active ? 'VSC aktiviert' : 'VSC zurueckgezogen';
            const vscIcon = item.active ? 'text-warning' : 'text-muted';
            return `<div class="feed-item feed-status" style="border-left-color: #eab308; background: rgba(234,179,8,0.08);">
                <div class="feed-time">${time}</div>
                <div class="feed-content">
                    <i class="fas fa-shield-halved ${vscIcon}"></i>
                    <strong>${vscText}</strong>
                </div>
            </div>`;
        }
        if (item.type === 'fuel_warning') {
            return `<div class="feed-item" style="border-left-color: #a855f7; background: rgba(168,85,247,0.05);">
                <div class="feed-time">${time}</div>
                <div class="feed-content">
                    <i class="fas fa-gas-pump" style="color: #a855f7"></i>
                    <strong>${item.driver_name}</strong> - Tank: <strong class="text-danger">${item.fuel}%</strong>
                </div>
            </div>`;
        }
        if (item.type === 'car_removed') {
            return `<div class="feed-item feed-dnf">
                <div class="feed-time">${time}</div>
                <div class="feed-content">
                    <i class="fas fa-car-burst text-warning"></i>
                    <strong>${item.driver_name}</strong> - Aus Session entfernt
                </div>
            </div>`;
        }
        if (item.type === 'overtake') {
            return `<div class="feed-item" style="border-left-color: ${item.color || 'var(--sr-accent)'}; background: rgba(59,130,246,0.06);">
                <div class="feed-time">${time}</div>
                <div class="feed-content">
                    <i class="fas fa-arrows-up-down text-info"></i>
                    <strong style="color:${item.color || '#999'}">${item.driver_name}</strong> ueberholt <strong>${item.overtaken_name}</strong> &rarr; ${item.position}
                </div>
            </div>`;
        }
        if (item.type === 'track') {
            return `<div class="feed-item feed-status">
                <div class="feed-time">${time}</div>
                <div class="feed-content">
                    <i class="fas fa-road text-info"></i>
                    Strecke: <strong>${item.name}</strong>
                </div>
            </div>`;
        }
        return '';
    }).join('');
}

// Echtzeit-Event in Ticker einfuegen (oben)
let liveFeedItems = [];
function prependFeedItem(item) {
    item.timestamp = new Date().toISOString();
    liveFeedItems.unshift(item);
    if (liveFeedItems.length > 50) liveFeedItems.length = 50;
    renderLiveFeed(liveFeedItems);
}

// Sessions laden
async function loadSessions() {
    try {
        const res = await fetch('/api/sessions');
        if (!res.ok) return;
        const sessions = await res.json();
        const sel = document.getElementById('sessionSelect');
        sel.innerHTML = '<option value="current">Aktuelle Session (Live)</option><option value="all">Alle Sessions</option>';
        sessions.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.session_id;
            opt.textContent = `${s.display_name || s.session_id} (${s.total_laps} Runden)`;
            sel.appendChild(opt);
        });
        sel.value = currentSession;
    } catch (e) {
        console.error('Sessions laden fehlgeschlagen:', e);
    }
}

// Rangliste berechnen (nach Runden desc, dann Bestzeit asc)
function computeRanking(data) {
    const drivers = [];
    Object.entries(data).forEach(([cid, cd]) => {
        const laps = cd.laps ? cd.laps.length : 0;
        if (laps === 0) return;
        const times = (cd.laps || []).map(l => l.laptime_raw).filter(t => t > 0);
        const best = times.length > 0 ? Math.min(...times) : Infinity;
        drivers.push({ cid, name: cd.name || 'Fahrer ' + cid, laps, best, color: cd.color || getControllerColor(cid) });
    });
    drivers.sort((a, b) => {
        if (a.laps !== b.laps) return b.laps - a.laps;
        return a.best - b.best;
    });
    return drivers;
}

// Ueberholungen erkennen
function detectOvertakes(oldRank, newRank) {
    if (oldRank.length < 2) return;
    const oldPos = {};
    oldRank.forEach((d, i) => oldPos[d.cid] = i);
    newRank.forEach((d, i) => {
        const prevIdx = oldPos[d.cid];
        if (prevIdx !== undefined && prevIdx > i) {
            // Fahrer hat Positionen gewonnen
            const overtaken = oldRank[i];
            if (overtaken && overtaken.cid !== d.cid) {
                const posLabel = 'P' + (i + 1);
                prependFeedItem({
                    type: 'overtake',
                    driver_name: d.name,
                    overtaken_name: overtaken.name,
                    position: posLabel,
                    color: d.color,
                });
            }
        }
    });
}

// Hauptdaten laden
async function updateDashboard() {
    try {
        let url = '/api/live-data';
        if (currentSession !== 'current' && currentSession !== 'all') {
            url += '?session_id=' + encodeURIComponent(currentSession);
        }
        const res = await fetch(url);
        if (!res.ok) return;
        const newData = await res.json();

        // Ueberholungen erkennen (vor Zuweisung)
        const newRanking = computeRanking(newData);
        if (previousRanking.length >= 2 && newRanking.length >= 2) {
            detectOvertakes(previousRanking, newRanking);
        }
        previousRanking = newRanking;

        dashboardData = newData;
        renderStats();
        renderControllers();
        updateControllerNames();
    } catch (e) {
        console.error('Dashboard-Update fehlgeschlagen:', e);
    }
}

// Session-Runden filtern (bei "current" nur letzte 30 Min)
function getSessionLaps(controllerData) {
    if (!controllerData.laps || controllerData.laps.length === 0) return [];
    if (currentSession !== 'current') return controllerData.laps;

    const sorted = [...controllerData.laps].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    if (!sorted[0] || !sorted[0].timestamp) return controllerData.laps;
    const latest = new Date(sorted[0].timestamp);
    const cutoff = new Date(latest.getTime() - 30 * 60 * 1000);
    return controllerData.laps.filter(l => new Date(l.timestamp) >= cutoff);
}

// Stats rendern
function renderStats() {
    let totalLaps = 0, activeDrivers = 0, allTimes = [];
    let fastest = null;
    let startTime = null, endTime = null;

    Object.entries(dashboardData).forEach(([cid, cd]) => {
        const laps = getSessionLaps(cd);
        if (laps.length === 0) return;
        activeDrivers++;

        // Fix: Rundenanzahl = Summe aller Runden pro Controller
        totalLaps += laps.length;

        laps.forEach(l => {
            if (l.laptime_raw > 0) allTimes.push(l.laptime_raw);
            if (l.timestamp) {
                const ts = new Date(l.timestamp);
                if (!startTime || ts < startTime) startTime = ts;
                if (!endTime || ts > endTime) endTime = ts;
            }
        });

        if (cd.best_time_raw && (!fastest || cd.best_time_raw < fastest.time)) {
            fastest = { time: cd.best_time_raw, driver: cd.name || ('Fahrer ' + cid) };
        }
    });

    document.getElementById('totalLaps').textContent = totalLaps;
    document.getElementById('activeDrivers').textContent = activeDrivers;

    if (fastest) {
        document.getElementById('fastestTime').textContent = formatTime(fastest.time);
        document.getElementById('fastestDriver').textContent = fastest.driver;

        if (!trackRecord || fastest.time < trackRecord.time) {
            trackRecord = { time: fastest.time, driver: fastest.driver };
        }
    }

    if (trackRecord) {
        document.getElementById('recordTime').textContent = formatTime(trackRecord.time);
        document.getElementById('recordDriver').textContent = trackRecord.driver || '--';
    }

    // Dauer
    if (startTime && endTime) {
        const ms = endTime - startTime;
        const min = Math.floor(ms / 60000);
        if (min >= 60) {
            document.getElementById('sessionDuration').textContent = Math.floor(min/60) + 'h ' + (min%60) + 'm';
        } else {
            document.getElementById('sessionDuration').textContent = min + 'm';
        }
    }

    // Durchschnitt
    if (allTimes.length > 0) {
        const avg = allTimes.reduce((a,b) => a+b, 0) / allTimes.length;
        document.getElementById('avgLap').textContent = formatTime(avg);
    }

    // Konsistenz-Score: Fahrer mit niedrigster Standardabweichung
    let bestConsistency = null;
    Object.entries(dashboardData).forEach(([cid, cd]) => {
        const laps = getSessionLaps(cd);
        const times = laps.map(l => l.laptime_raw).filter(t => t > 0);
        if (times.length < 3) return; // mind. 3 Runden
        const mean = times.reduce((a,b) => a+b, 0) / times.length;
        const variance = times.reduce((sum, t) => sum + Math.pow(t - mean, 2), 0) / times.length;
        const stdDev = Math.sqrt(variance);
        const pct = (stdDev / mean * 100); // Variation in %
        const name = cd.name || 'Fahrer ' + cid;
        if (!bestConsistency || pct < bestConsistency.pct) {
            bestConsistency = { name, pct, stdDev, laps: times.length };
        }
    });
    if (bestConsistency) {
        document.getElementById('consistencyDriver').textContent = bestConsistency.name;
        document.getElementById('consistencyDetail').textContent =
            `${bestConsistency.pct.toFixed(1)}% Abweichung (${bestConsistency.laps} Rdn.)`;
    }
}

// Controller-Karten rendern
function renderControllers() {
    const grid = document.getElementById('controllerGrid');
    const controllerIds = Object.keys(dashboardData).sort((a,b) => parseInt(a) - parseInt(b));
    const allIds = ['1','2','3','4','5','6'];
    const idsToShow = [...new Set([...allIds, ...controllerIds])]
        .filter(cid => visibleControllers.has(cid))
        .sort((a,b) => parseInt(a) - parseInt(b));

    // Gespeicherte Reihenfolge anwenden
    const savedOrder = JSON.parse(localStorage.getItem('sr-card-order') || '[]');
    if (savedOrder.length > 0) {
        idsToShow.sort((a, b) => {
            const ia = savedOrder.indexOf(a);
            const ib = savedOrder.indexOf(b);
            if (ia === -1 && ib === -1) return parseInt(a) - parseInt(b);
            if (ia === -1) return 1;
            if (ib === -1) return -1;
            return ia - ib;
        });
    }

    grid.innerHTML = idsToShow.map(cid => {
        const cd = dashboardData[cid];
        const color = (cd && cd.color && cd.color !== '#333333') ? cd.color : getControllerColor(cid);
        const laps = cd ? getSessionLaps(cd) : [];
        const hasData = laps.length > 0;

        const driverName = hasData ? (cd.name || 'Fahrer ' + cid) : 'Controller ' + cid;
        const carName = hasData ? (cd.car || '') : 'Keine Daten';

        // Bestzeit dieses Controllers
        const times = laps.map(l => l.laptime_raw).filter(t => t > 0);
        const bestTime = times.length > 0 ? Math.min(...times) : null;

        // Globale Bestzeit fuer Highlight
        let globalBest = null;
        Object.values(dashboardData).forEach(d => {
            if (d.best_time_raw && (!globalBest || d.best_time_raw < globalBest)) {
                globalBest = d.best_time_raw;
            }
        });
        const isGlobalBest = bestTime && bestTime === globalBest;

        // Penalties & Status
        const penalties = cd ? (cd.penalties || 0) : 0;
        const isRetired = cd ? cd.retired : false;
        const isDQ = cd ? cd.disqualified : false;

        // Letzte Runde fuer Sektoren
        const recentLaps = [...laps].sort((a,b) => (b.lap || 0) - (a.lap || 0));
        const latestLap = recentLaps[0] || {};
        const displayLaps = recentLaps.slice(0, 8);

        // Status-Badges
        let statusBadges = '';
        if (isDQ) statusBadges += '<span class="badge bg-danger ms-1">DQ</span>';
        else if (isRetired) statusBadges += '<span class="badge bg-warning text-dark ms-1">DNF</span>';
        if (penalties > 0) statusBadges += `<span class="badge bg-danger ms-1"><i class="fas fa-exclamation-triangle"></i> ${penalties}</span>`;

        // Sektoren der letzten Runde
        let sectorHtml = '';
        if (latestLap.sector_1 || latestLap.sector_2 || latestLap.sector_3) {
            sectorHtml = `<div class="sector-row">
                <span class="sector-badge" title="Sektor 1">S1: ${latestLap.sector_1 || '--'}</span>
                <span class="sector-badge" title="Sektor 2">S2: ${latestLap.sector_2 || '--'}</span>
                <span class="sector-badge" title="Sektor 3">S3: ${latestLap.sector_3 || '--'}</span>
            </div>`;
        }

        // Fuel-Anzeige
        let fuelHtml = '';
        const fuel = fuelLevels[cid];
        if (fuel !== undefined && fuel >= 0) {
            const fuelColor = fuel > 50 ? 'var(--sr-success)' : fuel > 20 ? 'var(--sr-warning)' : 'var(--sr-danger)';
            fuelHtml = `<div class="fuel-bar-container">
                <div class="fuel-bar-fill" style="width: ${fuel}%; background: ${fuelColor}"></div>
            </div>
            <div class="fuel-label"><span><i class="fas fa-gas-pump"></i> Tank</span><span>${fuel}%</span></div>`;
        }

        let tableRows = '';
        if (displayLaps.length > 0) {
            tableRows = displayLaps.map((l, idx) => {
                let cls = '';
                let deltaHtml = '';
                if (l.laptime_raw === bestTime && bestTime > 0) {
                    cls = 'row-pb';
                    deltaHtml = '<i class="fas fa-trophy text-warning"></i>';
                } else if (idx === 0) {
                    cls = 'row-latest';
                    if (bestTime && l.laptime_raw > 0) {
                        const diff = l.laptime_raw - bestTime;
                        deltaHtml = `<span class="${diff <= 0 ? 'delta-faster' : 'delta-slower'}">${diff > 0 ? '+' : ''}${formatTime(Math.abs(diff))}</span>`;
                    } else {
                        deltaHtml = '<i class="fas fa-flag text-info"></i>';
                    }
                } else if (bestTime && l.laptime_raw > 0) {
                    const diff = l.laptime_raw - bestTime;
                    deltaHtml = `<span class="${diff <= 0 ? 'delta-faster' : 'delta-slower'}">${diff > 0 ? '+' : ''}${formatTime(Math.abs(diff))}</span>`;
                }
                return `<tr class="${cls}">
                    <td class="text-center">${l.lap || '-'}</td>
                    <td class="font-mono text-center">${l.laptime_formatted || formatTime(l.laptime_raw)}</td>
                    <td class="text-center small">${deltaHtml}</td>
                </tr>`;
            }).join('');
        } else {
            tableRows = '<tr><td colspan="3" class="text-center text-muted py-3"><small>Noch keine Runden</small></td></tr>';
        }

        return `
        <div class="controller-card ${isRetired ? 'retired' : ''} ${isDQ ? 'disqualified' : ''}" draggable="true" data-cid="${cid}" style="--controller-color: ${color}; opacity: ${hasData ? 1 : 0.5}">
            <div class="driver-header d-flex justify-content-between align-items-start">
                <div>
                    <div class="driver-name">${driverName}${statusBadges}</div>
                    <div class="car-name">${carName}</div>
                    ${sectorHtml}
                </div>
                <div class="text-end">
                    <span class="controller-badge" style="background: ${color}">C${cid}</span>
                    ${bestTime ? `<div class="best-time mt-1 ${isGlobalBest ? 'text-warning' : ''}">${isGlobalBest ? '<i class="fas fa-trophy me-1"></i>' : '<i class="fas fa-stopwatch me-1 text-muted"></i>'}${formatTime(bestTime)}</div>` : ''}
                    <div class="small text-muted mt-1">${laps.length} Runden</div>
                </div>
            </div>
            ${fuelHtml}
            <table class="table table-sm mb-0">
                <thead><tr>
                    <th class="text-center">Runde</th>
                    <th class="text-center">Zeit</th>
                    <th class="text-center" style="width: 40px;"></th>
                </tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>`;
    }).join('');

    // Layout anwenden
    applyLayout();
}

// Drag & Drop fuer Controller-Cards
let draggedCard = null;
document.getElementById('controllerGrid').addEventListener('dragstart', (e) => {
    const card = e.target.closest('.controller-card');
    if (!card) return;
    draggedCard = card;
    card.style.opacity = '0.4';
    e.dataTransfer.effectAllowed = 'move';
});
document.getElementById('controllerGrid').addEventListener('dragend', (e) => {
    const card = e.target.closest('.controller-card');
    if (card) card.style.opacity = '';
    draggedCard = null;
    document.querySelectorAll('.controller-card').forEach(c => c.classList.remove('drag-over'));
});
document.getElementById('controllerGrid').addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const card = e.target.closest('.controller-card');
    if (card && card !== draggedCard) {
        document.querySelectorAll('.controller-card').forEach(c => c.classList.remove('drag-over'));
        card.classList.add('drag-over');
    }
});
document.getElementById('controllerGrid').addEventListener('drop', (e) => {
    e.preventDefault();
    const target = e.target.closest('.controller-card');
    if (!target || !draggedCard || target === draggedCard) return;
    const grid = document.getElementById('controllerGrid');
    const cards = [...grid.children];
    const fromIdx = cards.indexOf(draggedCard);
    const toIdx = cards.indexOf(target);
    if (fromIdx < toIdx) {
        target.after(draggedCard);
    } else {
        target.before(draggedCard);
    }
    // Reihenfolge speichern
    const order = [...grid.children].map(c => c.dataset.cid).filter(Boolean);
    localStorage.setItem('sr-card-order', JSON.stringify(order));
    document.querySelectorAll('.controller-card').forEach(c => c.classList.remove('drag-over'));
});

// ---- Controller Filter ----
function getVisibleControllers() {
    const cbs = document.querySelectorAll('.ctrl-cb');
    const active = new Set();
    cbs.forEach(cb => { if (cb.checked) active.add(cb.value); });
    return active;
}

function updateFilterLabel() {
    const label = document.getElementById('controllerFilterLabel');
    if (visibleControllers.size === 6) {
        label.textContent = 'Alle';
    } else if (visibleControllers.size === 0) {
        label.textContent = 'Keine';
    } else {
        label.textContent = [...visibleControllers].sort().map(c => 'C' + c).join(', ');
    }
}

function updateControllerNames() {
    // Farbpunkte und Namen aus Live-Daten aktualisieren
    document.querySelectorAll('.ctrl-option').forEach(li => {
        const cid = li.dataset.cid;
        const cd = dashboardData[cid];
        const dot = li.querySelector('.ctrl-dot');
        const labelEl = li.querySelector('label');
        if (cd) {
            const color = (cd.color && cd.color !== '#333333') ? cd.color : getControllerColor(cid);
            if (dot) dot.style.background = color;
            const name = cd.name || 'Fahrer ' + cid;
            const textNode = labelEl.childNodes[labelEl.childNodes.length - 1];
            textNode.textContent = name + ' (C' + cid + ')';
        }
    });
}

// "Alle" Checkbox
document.getElementById('ctrlAll').addEventListener('change', function() {
    const cbs = document.querySelectorAll('.ctrl-cb');
    cbs.forEach(cb => cb.checked = this.checked);
    visibleControllers = this.checked ? new Set(['1','2','3','4','5','6']) : new Set();
    updateFilterLabel();
    localStorage.setItem('sr-ctrl-filter', JSON.stringify([...visibleControllers]));
    renderControllers();
});

// Einzelne Checkboxen
document.querySelectorAll('.ctrl-cb').forEach(cb => {
    cb.addEventListener('change', () => {
        visibleControllers = getVisibleControllers();
        document.getElementById('ctrlAll').checked = visibleControllers.size === 6;
        updateFilterLabel();
        localStorage.setItem('sr-ctrl-filter', JSON.stringify([...visibleControllers]));
        renderControllers();
    });
});

// Gespeicherten Filter laden
(function loadSavedFilter() {
    const saved = localStorage.getItem('sr-ctrl-filter');
    if (saved) {
        try {
            const arr = JSON.parse(saved);
            visibleControllers = new Set(arr);
            document.querySelectorAll('.ctrl-cb').forEach(cb => {
                cb.checked = visibleControllers.has(cb.value);
            });
            document.getElementById('ctrlAll').checked = visibleControllers.size === 6;
            updateFilterLabel();
        } catch (e) {}
    }
})();

// Event-Listener
document.addEventListener('DOMContentLoaded', async () => {
    await loadTrackRecord();
    await loadSessions();
    await Promise.all([updateDashboard(), loadLiveFeed()]);
});

document.getElementById('sessionSelect').addEventListener('change', function() {
    currentSession = this.value;
    updateDashboard();
});

document.getElementById('refreshBtn').addEventListener('click', async () => {
    const btn = document.getElementById('refreshBtn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    await loadSessions();
    await updateDashboard();
    btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
    btn.disabled = false;
});

// WebSocket: Live-Updates statt Polling
socket.on('new_data', () => {
    updateDashboard();
    loadLiveFeed();
    // Fortschritt aktualisieren: hoechste Rundenzahl aller Controller
    if (typeof raceMaxLaps !== 'undefined' && raceMaxLaps > 0) {
        let maxLap = 0;
        Object.values(dashboardData).forEach(cd => {
            if (cd.laps && cd.laps.length > maxLap) maxLap = cd.laps.length;
        });
        if (maxLap > 0 && typeof updateRaceProgress === 'function') {
            updateRaceProgress(maxLap);
        }
    }
});

socket.on('track_record', (data) => {
    if (data && data.laptime_ms) {
        trackRecord = { time: data.laptime_ms, driver: data.driver_name };
        document.getElementById('recordTime').textContent = data.laptime_formatted;
        document.getElementById('recordDriver').textContent = `${data.driver_name} (${data.car_name || '--'})`;
    }
});

socket.on('penalty', (data) => {
    const name = data.driver_name || 'Fahrer ' + (data.controller_id || '?');
    const secs = data.penalty_seconds || 0;
    const detail = secs > 0 ? `${secs}s Strafe` : 'Strafe abgesessen';
    prependFeedItem({ type: 'penalty', driver_name: name, penalty_seconds: secs, penalty_type: detail, color: data.color });
});

// VSC im Ticker
socket.on('vsc', (data) => {
    prependFeedItem({ type: 'vsc', active: data.active });
});

// Fuel-Warnung im Ticker (nur bei <= 20%)
socket.on('fuel_update', (data) => {
    if (data.fuel >= 0 && data.fuel <= 20) {
        const name = data.driver_name || 'Controller ' + (data.controller_id || '?');
        prependFeedItem({ type: 'fuel_warning', driver_name: name, fuel: data.fuel });
    }
});

// Auto entfernt
socket.on('car_removed', (data) => {
    const name = data.driver_name || 'Controller ' + (data.controller_id || '?');
    prependFeedItem({ type: 'car_removed', driver_name: name, color: data.color });
});

// Strecke gewechselt
socket.on('active_track', (data) => {
    if (data.name) {
        prependFeedItem({ type: 'track', name: data.name });
    }
});

// Rennstatus im Ticker
socket.on('race_status', (data) => {
    prependFeedItem({ type: 'status', status: data.status, race_type: data.race_type });
    if (data.status === 'jumpstart' && typeof playSound === 'function') {
        playSound('jumpstart');
    }
});

// ---- Layout Toggle ----
function applyLayout() {
    const grid = document.getElementById('controllerGrid');
    const icon = document.getElementById('layoutIcon');
    if (!grid) return;
    if (dashLayout === 'list') {
        grid.style.gridTemplateColumns = '1fr';
        if (icon) icon.className = 'fas fa-th-large';
    } else {
        grid.style.gridTemplateColumns = '';
        if (icon) icon.className = 'fas fa-list';
    }
}

document.getElementById('layoutToggleBtn').addEventListener('click', () => {
    dashLayout = dashLayout === 'grid' ? 'list' : 'grid';
    localStorage.setItem('sr-layout', dashLayout);
    applyLayout();
});

// ---- Fuel Updates via WebSocket ----
socket.on('fuel_update', (data) => {
    if (data.controller_id !== undefined && data.fuel !== undefined) {
        const cid = String(data.controller_id);
        if (data.fuel < 0) {
            delete fuelLevels[cid];
        } else {
            fuelLevels[cid] = data.fuel;
        }
        renderControllers();
    }
});

// ---- Widget Visibility ----
function applyWidgetVisibility() {
    const hidden = JSON.parse(localStorage.getItem('sr-hidden-widgets') || '[]');
    document.querySelectorAll('.widget-col').forEach(col => {
        const wid = col.dataset.widget;
        if (hidden.includes(wid)) {
            col.classList.add('d-none');
        } else {
            col.classList.remove('d-none');
        }
    });
    // Checkboxen synchronisieren
    document.querySelectorAll('.widget-vis-cb').forEach(cb => {
        cb.checked = !hidden.includes(cb.value);
    });
}

document.querySelectorAll('.widget-vis-cb').forEach(cb => {
    cb.addEventListener('change', () => {
        const hidden = [];
        document.querySelectorAll('.widget-vis-cb').forEach(c => {
            if (!c.checked) hidden.push(c.value);
        });
        localStorage.setItem('sr-hidden-widgets', JSON.stringify(hidden));
        applyWidgetVisibility();
    });
});

// Gespeicherte Sichtbarkeit laden
applyWidgetVisibility();

// ---- Widget Drag & Drop ----
let draggedWidget = null;
const widgetRow = document.getElementById('widgetRow');

widgetRow.addEventListener('dragstart', (e) => {
    const col = e.target.closest('.widget-col');
    if (!col) return;
    draggedWidget = col;
    col.style.opacity = '0.4';
    e.dataTransfer.effectAllowed = 'move';
});

widgetRow.addEventListener('dragend', (e) => {
    const col = e.target.closest('.widget-col');
    if (col) col.style.opacity = '';
    draggedWidget = null;
    document.querySelectorAll('.widget-col').forEach(c => c.style.outline = '');
});

widgetRow.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const col = e.target.closest('.widget-col');
    if (col && col !== draggedWidget) {
        document.querySelectorAll('.widget-col').forEach(c => c.style.outline = '');
        col.style.outline = '2px dashed var(--sr-accent)';
    }
});

widgetRow.addEventListener('drop', (e) => {
    e.preventDefault();
    const target = e.target.closest('.widget-col');
    if (!target || !draggedWidget || target === draggedWidget) return;
    const cols = [...widgetRow.children];
    const fromIdx = cols.indexOf(draggedWidget);
    const toIdx = cols.indexOf(target);
    if (fromIdx < toIdx) {
        target.after(draggedWidget);
    } else {
        target.before(draggedWidget);
    }
    const order = [...widgetRow.children].map(c => c.dataset.widget).filter(Boolean);
    localStorage.setItem('sr-widget-order', JSON.stringify(order));
    document.querySelectorAll('.widget-col').forEach(c => c.style.outline = '');
});

// Widget-Reihenfolge wiederherstellen
(function restoreWidgetOrder() {
    const saved = localStorage.getItem('sr-widget-order');
    if (!saved) return;
    try {
        const order = JSON.parse(saved);
        order.forEach(wid => {
            const el = widgetRow.querySelector(`[data-widget="${wid}"]`);
            if (el) widgetRow.appendChild(el);
        });
    } catch (e) {}
})();

// Fallback: alle 10 Sekunden aktualisieren
setInterval(() => { updateDashboard(); loadLiveFeed(); }, 10000);
</script>
{% endblock %}
