{% extends "base.html" %}

{% block title %}Dashboard - SmartRace{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Race Dashboard</h2>
    </div>
</div>

<!-- Session Info Row -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">üèÅ Schnellste Runde (Session)</h5>
                <h3 id="fastest-lap-time">--:--.---</h3>
                <p id="fastest-lap-driver" class="mb-0">Kein Fahrer</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">üèÜ Streckenrekord</h5>
                <h3 id="track-record-time">--:--.---</h3>
                <p id="track-record-driver" class="mb-0">Unbekannt</p>
                <small id="track-record-date" class="text-light">--</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">üìä Session Stats</h5>
                <div class="row">
                    <div class="col-6">
                        <strong id="total-laps">0</strong><br>
                        <small>Runden</small>
                    </div>
                    <div class="col-6">
                        <strong id="active-drivers">0</strong><br>
                        <small>Fahrer</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Controller Overview - 6 Tables -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">üéÆ Controller Overview - Letzte 6 Zeiten</h5>
                <div class="controllers-grid">
                    
                    <!-- Controller 1 -->
                    <div class="controller-table" id="controller-1">
                        <h6 class="controller-header">üéÆ Controller 1</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-1-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controller 2 -->
                    <div class="controller-table" id="controller-2">
                        <h6 class="controller-header">üéÆ Controller 2</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-2-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controller 3 -->
                    <div class="controller-table" id="controller-3">
                        <h6 class="controller-header">üéÆ Controller 3</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-3-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controller 4 -->
                    <div class="controller-table" id="controller-4">
                        <h6 class="controller-header">üéÆ Controller 4</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-4-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controller 5 -->
                    <div class="controller-table" id="controller-5">
                        <h6 class="controller-header">üéÆ Controller 5</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-5-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Controller 6 -->
                    <div class="controller-table" id="controller-6">
                        <h6 class="controller-header">üéÆ Controller 6</h6>
                        <div class="driver-info">
                            <div class="driver-name">-</div>
                            <div class="car-name">-</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Runde</th>
                                        <th>Zeit</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controller-6-times">
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let dashboardData = {};
let sessionFastestLap = null;
let trackRecord = null;
    
async function updateDashboard() {
    try {
        console.log('üöÄ Lade Live-Daten...');
        const response = await fetch('/api/live-data');
        console.log('üì° Response Status:', response.status);
        
        const rawText = await response.text();
        console.log('üìÑ Raw Response:', rawText);
        
        dashboardData = JSON.parse(rawText);
        console.log('üìä Live-Daten erhalten:', dashboardData);
        
        // ‚úÖ NEU: Session Stats aus Analytics API
        await updateSessionStats();
        
        updateControllerTables();
        updateTrackRecord();
        updateSessionFastestLap();
        
    } catch (error) {
        console.error('‚ùå Live-Daten Fehler:', error);
    }
}

// ‚úÖ NEU: Session Stats aus Analytics API laden
async function updateSessionStats() {
    try {
        const response = await fetch('/api/analytics');
        const analyticsData = await response.json();
        console.log('üìä Analytics Daten:', analyticsData);
        
        // SESSION FASTEST LAP
        if (analyticsData.session_fastest && analyticsData.session_fastest.lap_time) {
            document.getElementById('fastest-lap-time').textContent = formatTime(analyticsData.session_fastest.lap_time * 1000);
            document.getElementById('fastest-lap-driver').textContent = `Driver ${analyticsData.session_fastest.controller_id}`;
        } else {
            document.getElementById('fastest-lap-time').textContent = '--:--.---';
            document.getElementById('fastest-lap-driver').textContent = 'Kein Fahrer';
        }
        
        // TRACK RECORD
        if (analyticsData.track_record && analyticsData.track_record.lap_time) {
            document.getElementById('track-record-time').textContent = formatTime(analyticsData.track_record.lap_time * 1000);
            document.getElementById('track-record-driver').textContent = `Driver ${analyticsData.track_record.controller_id}`;
            document.getElementById('track-record-date').textContent = new Date(analyticsData.track_record.timestamp).toLocaleDateString('de-DE');
        }
        
        // SESSION STATS
        if (analyticsData.session_stats) {
            document.getElementById('total-laps').textContent = analyticsData.session_stats.total_laps || 0;
            document.getElementById('active-drivers').textContent = analyticsData.session_stats.active_drivers || 0;
        }
        
    } catch (error) {
        console.error('‚ùå Analytics Fehler:', error);
        // Fallback auf alte Berechnung
        updateMainStatsOld();
    }
}

function updateSessionFastestLap() {
    let fastestLap = null;
    
    Object.keys(dashboardData).forEach(controllerId => {
        const controllerData = dashboardData[controllerId];
        
        if (controllerData && controllerData.best_time) {
            if (!fastestLap || controllerData.best_time < fastestLap.time) {
                fastestLap = {
                    time: controllerData.best_time,
                    driver: controllerData.name
                };
            }
        }
    });
    
    if (fastestLap) {
        sessionFastestLap = fastestLap;
    }
}

// Fallback f√ºr alte Stats-Berechnung
function updateMainStatsOld() {
    // Session Fastest Lap (fallback)
    if (sessionFastestLap) {
        document.getElementById('fastest-lap-time').textContent = formatTime(sessionFastestLap.time);
        document.getElementById('fastest-lap-driver').textContent = sessionFastestLap.driver || 'Unbekannt';
    }
    
    // Track Record (fallback hardcoded)
    document.getElementById('track-record-time').textContent = '1:23.456';
    document.getElementById('track-record-driver').textContent = 'Max Verstappen';
    document.getElementById('track-record-date').textContent = '2024-01-15';
    
    // Session Stats (fallback berechnet)
    const totalLaps = Object.values(dashboardData).reduce((sum, controller) => {
        return sum + (controller?.lap_count || 0);
    }, 0);
    
    const activeDrivers = Object.values(dashboardData).filter(controller => 
        controller && controller.lap_count > 0
    ).length;
    
    document.getElementById('total-laps').textContent = totalLaps;
    document.getElementById('active-drivers').textContent = activeDrivers;
}

function updateControllerTables() {
    for (let i = 1; i <= 6; i++) {
        const controllerData = dashboardData[i.toString()];
        const tableElement = document.getElementById(`controller-${i}`);
        const timesBody = document.getElementById(`controller-${i}-times`);
        
        if (!tableElement || !timesBody) continue;
        
        if (controllerData && controllerData.recent_times && controllerData.recent_times.length > 0) {
            // Controller aktiv - Styling setzen
            const color = controllerData.color || getDefaultControllerColor(i);
            const rgbaColor = hexToRgba(color, 0.15);
            const borderColor = hexToRgba(color, 0.5);
            
            tableElement.style.backgroundColor = rgbaColor;
            tableElement.style.borderColor = borderColor;
            tableElement.style.borderWidth = '2px';
            tableElement.style.borderStyle = 'solid';
            
            // Driver Info aktualisieren
            const driverNameEl = tableElement.querySelector('.driver-name');
            const carNameEl = tableElement.querySelector('.car-name');
            const driverInfoEl = tableElement.querySelector('.driver-info');
            
            if (driverNameEl) driverNameEl.textContent = controllerData.name || `Driver ${i}`;
            if (carNameEl) carNameEl.textContent = controllerData.car_name || 'Unbekanntes Auto';
            
            if (driverInfoEl) {
                driverInfoEl.style.backgroundColor = hexToRgba(color, 0.3);
                driverInfoEl.style.color = '#333';
            }
            
            // Zeiten-Tabelle f√ºllen
            timesBody.innerHTML = '';
            
            // Letzte 6 Zeiten (neueste zuerst)
            const recentTimes = controllerData.recent_times.slice(-6).reverse();
            
            recentTimes.forEach((timeEntry, index) => {
                const row = document.createElement('tr');
                
                // Runden-Nummer (r√ºckw√§rts z√§hlen)
                const lapNumber = (controllerData.lap_count || 0) - index;
                
                // Status bestimmen
                let status = '‚è±Ô∏è';
                let statusClass = '';
                
                if (timeEntry === controllerData.best_time) {
                    status = 'üèÜ BEST';
                    statusClass = 'text-warning fw-bold';
                } else if (index === 0) {
                    status = 'üîÑ LAST';
                    statusClass = 'text-info';
                }
                
                row.innerHTML = `
                    <td><strong>#${lapNumber}</strong></td>
                    <td><strong>${formatTime(timeEntry)}</strong></td>
                    <td><span class="${statusClass}">${status}</span></td>
                `;
                
                timesBody.appendChild(row);
            });
            
        } else {
            // Controller inaktiv - Styling zur√ºcksetzen
            tableElement.style.backgroundColor = '#f8f9fa';
            tableElement.style.borderColor = '#e0e0e0';
            
            // Driver Info zur√ºcksetzen
            const driverNameEl = tableElement.querySelector('.driver-name');
            const carNameEl = tableElement.querySelector('.car-name');
            const driverInfoEl = tableElement.querySelector('.driver-info');
            
            if (driverNameEl) driverNameEl.textContent = '-';
            if (carNameEl) carNameEl.textContent = '-';
            if (driverInfoEl) {
                driverInfoEl.style.backgroundColor = '#e9ecef';
                driverInfoEl.style.color = '#6c757d';
            }
            
            // Leere Tabelle
            timesBody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-muted text-center">
                        <em>Keine Daten</em>
                    </td>
                </tr>
            `;
        }
    }
}

function updateTrackRecord() {
    // Wird von updateSessionStats() √ºbernommen
    if (trackRecord) {
        document.getElementById('track-record-time').textContent = formatTime(trackRecord.time);
        document.getElementById('track-record-driver').textContent = trackRecord.driver;
        document.getElementById('track-record-date').textContent = trackRecord.date;
    }
}

// Erweiterte Fallback-Farben
function getDefaultControllerColor(controllerId) {
    const colors = {
        1: '#FF4444', // Rot
        2: '#4444FF', // Blau  
        3: '#44FF44', // Gr√ºn
        4: '#FFFF44', // Gelb
        5: '#FF8844', // Orange
        6: '#8844FF'  // Violett
    };
    
    const color = colors[controllerId] || '#888888';
    console.log(`üé® getDefaultControllerColor(${controllerId}) = ${color}`);
    return color;
}

// ‚úÖ Verbesserte Farb-Konvertierung
function hexToRgba(hex, alpha) {
    // Entferne # falls vorhanden
    hex = hex.replace('#', '');
    
    // 3-stellige HEX zu 6-stellig konvertieren
    if (hex.length === 3) {
        hex = hex.split('').map(char => char + char).join('');
    }
    
    const result = /^([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    
    if (result) {
        const r = parseInt(result[1], 16);
        const g = parseInt(result[2], 16);
        const b = parseInt(result[3], 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    
    // Fallback
    return `rgba(128, 128, 128, ${alpha})`;
}

// Zeit formatieren - ‚úÖ FIX f√ºr Sekunden vs Millisekunden  
function formatTime(timeMs) {
    if (!timeMs || timeMs === 0) return '--:--.---';
    
    // Falls es schon in Sekunden ist (< 1000), zu ms konvertieren
    if (timeMs < 1000) {
        timeMs = timeMs * 1000;
    }
    
    const minutes = Math.floor(timeMs / 60000);
    const seconds = ((timeMs % 60000) / 1000).toFixed(3);
    
    if (minutes > 0) {
        return `${minutes}:${seconds.padStart(6, '0')}`;
    } else {
        return `0:${seconds.padStart(6, '0')}`;
    }
}

// CSS f√ºr Controller-Tabellen
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .controllers-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-top: 15px;
    }
    
    .controller-table {
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
        border: 2px solid #e0e0e0;
    }
    
    .controller-table:hover {
        transform: translateY(-2px);
    }
    
    .controller-header {
        margin: 0 0 15px 0;
        text-align: center;
        font-weight: bold;
        font-size: 16px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .driver-info {
        text-align: center;
        margin-bottom: 15px;
        padding: 12px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .driver-name {
        font-weight: bold;
        font-size: 15px;
        display: block;
        margin-bottom: 4px;
    }
    
    .car-name {
        font-size: 13px;
        font-style: italic;
    }
    
    .controller-table table {
        margin-bottom: 0;
        border-radius: 6px;
        overflow: hidden;
    }
    
    .controller-table th {
        background: rgba(0,0,0,0.8) !important;
        color: white !important;
        font-size: 12px;
        padding: 8px;
        text-align: center;
        font-weight: bold;
    }
    
    .controller-table td {
        padding: 8px;
        text-align: center;
        font-size: 13px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
        .controllers-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .controllers-grid {
            grid-template-columns: 1fr;
        }
    }
`;
document.head.appendChild(style);

// Initial load und regelm√§√üige Updates
updateDashboard();
setInterval(updateDashboard, 3000); // Update alle 3 Sekunden
</script>
{% endblock %}
