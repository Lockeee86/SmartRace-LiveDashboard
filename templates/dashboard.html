{% extends "base.html" %}

{% block title %}Dashboard - SmartRace{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Live Race Dashboard</h2>
    </div>
</div>

<div class="row" id="controller-tables">
    <!-- Controller-Tabellen werden hier dynamisch eingefÃ¼gt -->
</div>
{% endblock %}

{% block scripts %}
<script>
let controllerColors = {};

function updateDashboard() {
    fetch('/api/live-data')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('controller-tables');
            container.innerHTML = '';

            Object.keys(data).forEach(controllerId => {
                const controllerData = data[controllerId];
                if (controllerData.length > 0) {
                    const color = controllerData[0].color || getRandomColor();
                    controllerColors[controllerId] = color;
                    
                    const colDiv = document.createElement('div');
                    colDiv.className = 'col-md-6 col-lg-4 mb-4';
                    
                    colDiv.innerHTML = `
                        <div class="card" style="border-color: ${color};">
                            <div class="card-header" style="background-color: ${color}; color: #000;">
                                <h5>Controller ${controllerId}</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>Fahrer</th>
                                                <th>Auto</th>
                                                <th>Runde</th>
                                                <th>Zeit</th>
                                                <th>S1</th>
                                                <th>S2</th>
                                                <th>S3</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${controllerData.slice(0, 10).map(lap => `
                                                <tr class="${lap.is_pb ? 'table-success' : ''}">
                                                    <td>${lap.driver}</td>
                                                    <td>${lap.car}</td>
                                                    <td>${lap.lap}</td>
                                                    <td>${lap.laptime}</td>
                                                    <td>${lap.sector_1}</td>
                                                    <td>${lap.sector_2}</td>
                                                    <td>${lap.sector_3}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(colDiv);
                }
            });
        })
        .catch(error => console.error('Error:', error));
}

function getRandomColor() {
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
    return colors[Math.floor(Math.random() * colors.length)];
}

// Update alle 2 Sekunden
setInterval(updateDashboard, 2000);
updateDashboard();
</script>
{% endblock %}
