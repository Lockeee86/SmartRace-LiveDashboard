{% extends "base.html" %}

{% block title %}Leaderboard - SmartRace Live{% endblock %}

{% block content %}
<!-- Header -->
<div class="session-selector d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Live Leaderboard</h5>
    <div class="d-flex align-items-center gap-2">
        <!-- Widget Visibility Toggle -->
        <div class="dropdown" id="lbWidgetToggleDropdown">
            <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" title="Widgets ein/ausblenden">
                <i class="fas fa-eye"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end p-2" style="min-width: 200px;">
                <li class="small text-muted px-2 pb-1">Widgets anzeigen:</li>
                <li>
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 lb-widget-vis-cb" value="fastest" checked>
                        <i class="fas fa-bolt text-info"></i> Schnellste Runde
                    </label>
                </li>
                <li>
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 lb-widget-vis-cb" value="record" checked>
                        <i class="fas fa-trophy text-success"></i> Streckenrekord
                    </label>
                </li>
                <li>
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 lb-widget-vis-cb" value="consistency" checked>
                        <i class="fas fa-bullseye text-warning"></i> Konsistenz
                    </label>
                </li>
                <li>
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 lb-widget-vis-cb" value="stats" checked>
                        <i class="fas fa-chart-bar" style="color: #9b59b6"></i> Session Stats
                    </label>
                </li>
                <li>
                    <label class="dropdown-item d-flex align-items-center gap-2 rounded py-1 px-2">
                        <input type="checkbox" class="form-check-input m-0 lb-widget-vis-cb" value="tracklayout" checked>
                        <i class="fas fa-draw-polygon text-info"></i> Streckenlayout
                    </label>
                </li>
            </ul>
        </div>
        <span class="badge bg-danger pulse" id="liveBadge">LIVE</span>
    </div>
</div>

<!-- Stat Cards (Drag & Drop) -->
<div class="row g-3 mb-3" id="lbWidgetRow">
    <div class="col-md-4 col-lg-3 lb-widget-col" data-widget="fastest" draggable="true">
        <div class="card stat-card fastest h-100">
            <div class="card-body py-3">
                <div class="stat-label mb-1"><i class="fas fa-bolt me-1"></i> Schnellste Runde</div>
                <div class="stat-value" id="lb-fastestTime">--:--.---</div>
                <div class="small mt-1" id="lb-fastestDriver">--</div>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-3 lb-widget-col" data-widget="record" draggable="true">
        <div class="card stat-card record h-100">
            <div class="card-body py-3">
                <div class="stat-label mb-1"><i class="fas fa-trophy me-1"></i> Streckenrekord</div>
                <div class="stat-value" id="lb-recordTime">--:--.---</div>
                <div class="small mt-1" id="lb-recordDriver">--</div>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-3 lb-widget-col" data-widget="consistency" draggable="true">
        <div class="card stat-card h-100" style="background: linear-gradient(135deg, #2d2020, #1a1212); border-left: 4px solid #e67e22;">
            <div class="card-body py-3">
                <div class="stat-label mb-1"><i class="fas fa-bullseye me-1"></i> Konsistenz</div>
                <div class="stat-value" id="lb-consistencyDriver">--</div>
                <div class="small mt-1" id="lb-consistencyDetail">Gleichmaessigster Fahrer</div>
            </div>
        </div>
    </div>
    <div class="col-md-12 col-lg-3 lb-widget-col" data-widget="stats" draggable="true">
        <div class="card stat-card stats h-100">
            <div class="card-body py-3">
                <div class="stat-label mb-2"><i class="fas fa-chart-bar me-1"></i> Session Stats</div>
                <div class="row text-center g-2">
                    <div class="col-4">
                        <div class="fw-bold fs-5" id="lb-totalLaps">0</div>
                        <div class="small text-muted">Runden</div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold fs-5" id="lb-drivers">0</div>
                        <div class="small text-muted">Fahrer</div>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold fs-5" id="lb-penalties">0</div>
                        <div class="small text-muted">Strafen</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3 lb-widget-col" data-widget="tracklayout" draggable="true">
        <div class="card stat-card h-100" style="background: linear-gradient(135deg, #1a2030, #121820); border-left: 4px solid #3498db;">
            <div class="card-body py-2 px-3">
                <div class="stat-label mb-1"><i class="fas fa-draw-polygon me-1"></i> Strecke <span class="fw-normal text-muted ms-1" id="lbTrackLayoutName">--</span></div>
                <div id="lbTrackLayout" class="text-center track-layout-widget">
                    <span class="text-muted small">Kein Layout</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Ticker -->
<div class="card mb-3 ticker-card">
    <div class="card-body p-0 d-flex align-items-center overflow-hidden" style="height: 52px;">
        <div class="ticker-label px-3 d-flex align-items-center h-100">
            <i class="fas fa-broadcast-tower me-1 pulse"></i><span class="d-none d-sm-inline">LIVE</span>
        </div>
        <div class="ticker-display flex-grow-1 overflow-hidden h-100" id="tickerViewport">
            <div class="ticker-strip d-flex align-items-center h-100" id="tickerStrip">
            </div>
        </div>
    </div>
</div>

<!-- Leaderboard Tabelle -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th style="width: 60px;" class="text-center">Pos</th>
                        <th>Fahrer</th>
                        <th>Auto</th>
                        <th class="text-center">Controller</th>
                        <th class="text-center">Runden</th>
                        <th class="text-center">Beste Zeit</th>
                        <th class="text-center">Letzte Zeit</th>
                        <th class="text-center">Sektoren</th>
                        <th class="text-center">Abstand</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr><td colspan="10" class="text-center text-muted py-5">
                        <i class="fas fa-flag-checkered fa-2x mb-2 d-block"></i>
                        Warte auf Rennstart...
                    </td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/track-positions.js') }}"></script>
<script>
let lbData = {};
let lbTrackRecord = null;
let previousPositions = {};

// Streckenrekord aus DB laden
async function loadTrackRecord() {
    try {
        const res = await fetch('/api/track-record');
        if (!res.ok) return;
        const rec = await res.json();
        if (rec && rec.laptime_ms) {
            lbTrackRecord = { time: rec.laptime_ms, driver: rec.driver_name };
            document.getElementById('lb-recordTime').textContent = rec.laptime_formatted;
            document.getElementById('lb-recordDriver').textContent = `${rec.driver_name} (${rec.car_name || '--'})`;
        }
    } catch (e) {}
}

function getSessionLaps(cd) {
    if (!cd.laps || cd.laps.length === 0) return [];
    const sorted = [...cd.laps].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
    if (!sorted[0] || !sorted[0].timestamp) return cd.laps;
    const latest = new Date(sorted[0].timestamp);
    const cutoff = new Date(latest.getTime() - 30 * 60 * 1000);
    return cd.laps.filter(l => new Date(l.timestamp) >= cutoff);
}

async function fetchLeaderboard() {
    try {
        const res = await fetch('/api/live-data');
        if (!res.ok) return;
        lbData = await res.json();
        updateLeaderboard();
    } catch (e) {
        console.error('Leaderboard-Fehler:', e);
    }
}

function updateLeaderboard() {
    const drivers = [];
    let totalLaps = 0;
    let totalPenalties = 0;
    let fastest = null;

    Object.entries(lbData).forEach(([cid, cd]) => {
        const laps = getSessionLaps(cd);
        if (laps.length === 0) return;

        const lapNums = laps.map(l => l.lap || 0).filter(n => n > 0);
        const maxLap = lapNums.length > 0 ? Math.max(...lapNums) : 0;
        totalLaps += laps.length;
        totalPenalties += cd.penalties || 0;

        const sorted = [...laps].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        const lastLap = sorted[0] || {};

        const color = (cd.color && cd.color !== '#333333') ? cd.color : getControllerColor(cid);

        drivers.push({
            cid: parseInt(cid),
            name: cd.name || 'Fahrer ' + cid,
            car: cd.car || 'Auto ' + cid,
            color: color,
            totalLaps: maxLap,
            bestTime: cd.best_time_raw,
            lastTime: lastLap.laptime_raw || null,
            lastSector1: lastLap.sector_1 || null,
            lastSector2: lastLap.sector_2 || null,
            lastSector3: lastLap.sector_3 || null,
            penalties: cd.penalties || 0,
            retired: cd.retired || false,
            disqualified: cd.disqualified || false,
        });

        if (cd.best_time_raw && (!fastest || cd.best_time_raw < fastest.time)) {
            fastest = { time: cd.best_time_raw, driver: cd.name || 'Fahrer ' + cid };
        }
    });

    // Sortieren: DQ/DNF ans Ende, dann meiste Runden, dann beste Zeit
    drivers.sort((a, b) => {
        if (a.disqualified !== b.disqualified) return a.disqualified ? 1 : -1;
        if (a.retired !== b.retired) return a.retired ? 1 : -1;
        if (a.totalLaps !== b.totalLaps) return b.totalLaps - a.totalLaps;
        if (a.bestTime && b.bestTime) return a.bestTime - b.bestTime;
        if (a.bestTime) return -1;
        if (b.bestTime) return 1;
        return 0;
    });

    // Stats
    document.getElementById('lb-totalLaps').textContent = totalLaps;
    document.getElementById('lb-drivers').textContent = drivers.length;
    document.getElementById('lb-penalties').textContent = totalPenalties;

    if (fastest) {
        document.getElementById('lb-fastestTime').textContent = formatTime(fastest.time);
        document.getElementById('lb-fastestDriver').textContent = fastest.driver;
        if (!lbTrackRecord || fastest.time < lbTrackRecord.time) {
            lbTrackRecord = fastest;
        }
    }
    if (lbTrackRecord) {
        document.getElementById('lb-recordTime').textContent = formatTime(lbTrackRecord.time);
        document.getElementById('lb-recordDriver').textContent = lbTrackRecord.driver;
    }

    // Leaderboard Tabelle
    const tbody = document.getElementById('leaderboardBody');
    if (drivers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-5"><i class="fas fa-flag-checkered fa-2x mb-2 d-block"></i>Warte auf Rennstart...</td></tr>';
        return;
    }

    const leader = drivers.find(d => !d.retired && !d.disqualified) || drivers[0];

    // Konsistenz aktualisieren
    updateConsistency();

    tbody.innerHTML = drivers.map((d, i) => {
        const pos = i + 1;
        const prevPos = previousPositions[d.cid];
        let change = '';
        if (prevPos !== undefined) {
            if (prevPos > pos) change = '<i class="fas fa-caret-up text-success ms-1"></i>';
            else if (prevPos < pos) change = '<i class="fas fa-caret-down text-danger ms-1"></i>';
        }
        previousPositions[d.cid] = pos;

        let posClass = 'other';
        if (!d.retired && !d.disqualified) {
            if (pos === 1) posClass = 'gold';
            else if (pos === 2) posClass = 'silver';
            else if (pos === 3) posClass = 'bronze';
        }

        // Abstand
        let gap = '';
        if (d.disqualified) {
            gap = '<span class="text-danger fw-bold">DQ</span>';
        } else if (d.retired) {
            gap = '<span class="text-warning fw-bold">DNF</span>';
        } else if (d === leader) {
            gap = '<span class="text-warning fw-bold">Leader</span>';
        } else if (d.totalLaps < leader.totalLaps) {
            const diff = leader.totalLaps - d.totalLaps;
            gap = '+' + diff + ' Runde' + (diff > 1 ? 'n' : '');
        } else if (d.bestTime && leader.bestTime) {
            gap = '+' + formatTime(d.bestTime - leader.bestTime);
        }

        const isFastest = fastest && d.bestTime === fastest.time;

        // Status
        let status = '';
        if (d.disqualified) {
            status = '<span class="badge bg-danger">Disqualifiziert</span>';
        } else if (d.retired) {
            status = '<span class="badge bg-warning text-dark">Ausgeschieden</span>';
        } else if (d.penalties > 0) {
            status = `<span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> ${d.penalties}x Strafe</span>`;
        } else if (pos === 1) {
            status = '<i class="fas fa-crown text-warning"></i> Leader';
        } else if (isFastest) {
            status = '<i class="fas fa-trophy text-warning"></i> Bestzeit';
        } else if (pos <= 3) {
            status = '<i class="fas fa-medal"></i> Podium';
        } else {
            status = '<span class="text-muted">Aktiv</span>';
        }

        // Sektoren
        let sectors = '--';
        if (d.lastSector1 || d.lastSector2 || d.lastSector3) {
            sectors = `<span class="sector-mini">${d.lastSector1 || '--'}</span> <span class="sector-mini">${d.lastSector2 || '--'}</span> <span class="sector-mini">${d.lastSector3 || '--'}</span>`;
        }

        let rowClass = '';
        if (d.disqualified) rowClass = 'leaderboard-row disqualified';
        else if (d.retired) rowClass = 'leaderboard-row retired';
        else if (pos === 1) rowClass = 'leaderboard-row leader';
        else if (pos <= 3) rowClass = 'leaderboard-row podium';

        return `<tr class="${rowClass}" style="border-left: 4px solid ${d.color}">
            <td class="text-center"><span class="position-badge ${posClass}">${pos}</span>${change}</td>
            <td class="fw-bold ${d.disqualified ? 'text-decoration-line-through text-muted' : ''}" style="color: ${d.disqualified ? '' : d.color}">${d.name}</td>
            <td class="text-muted">${d.car}</td>
            <td class="text-center"><span class="controller-badge" style="background: ${d.color}">C${d.cid}</span></td>
            <td class="text-center fw-bold">${d.totalLaps}</td>
            <td class="text-center font-mono ${isFastest ? 'text-warning fw-bold' : ''}">${formatTime(d.bestTime)}${isFastest ? ' <i class="fas fa-trophy"></i>' : ''}</td>
            <td class="text-center font-mono">${formatTime(d.lastTime)}</td>
            <td class="text-center font-mono small">${sectors}</td>
            <td class="text-center small">${gap}</td>
            <td class="text-center small">${status}</td>
        </tr>`;
    }).join('');

}

// ---- Live Ticker ----
const TICKER_HISTORY = 30;
let tickerQueue = []; // gespeicherte HTML-Strings (neueste zuerst)

async function loadTickerFeed() {
    try {
        const res = await fetch('/api/live-feed?limit=20');
        if (!res.ok) return;
        const items = await res.json();
        // Aelteste zuerst einfuegen damit neueste am Ende (=links) landen
        tickerQueue = [];
        for (let i = items.length - 1; i >= 0; i--) {
            const html = formatTickerItem(items[i]);
            if (html) tickerQueue.push(html);
        }
        rebuildTicker();
    } catch (e) {
        console.error('Ticker-Fehler:', e);
    }
}

function formatTickerItem(item) {
    if (item.type === 'lap') {
        const color = item.color || '#888';
        const time = item.laptime_formatted || formatTime(item.laptime_ms);
        const pb = item.is_pb ? ' <i class="fas fa-trophy text-warning ms-1"></i>' : '';
        return `<span class="ticker-dot" style="background:${color}"></span><strong style="color:${color}">${item.driver_name}</strong> <span class="text-muted">R${item.lap_number || '?'}</span> <span class="font-mono fw-bold">${time}</span>${pb}`;
    }
    if (item.type === 'penalty') {
        return `<i class="fas fa-flag text-danger"></i> <strong>${item.driver_name}</strong> <span class="text-danger">${item.penalty_type || 'Strafe'}</span>`;
    }
    if (item.type === 'record') {
        const time = item.laptime_formatted || formatTime(item.laptime_ms);
        return `<i class="fas fa-star text-warning"></i> <strong class="text-warning">REKORD</strong> ${item.driver_name} <span class="font-mono fw-bold">${time}</span>`;
    }
    if (item.type === 'status') {
        const rt = item.race_type ? ` (${item.race_type})` : '';
        return `<i class="fas fa-flag-checkered"></i> <strong>${item.status || '?'}</strong>${rt}`;
    }
    if (item.type === 'dnf') {
        return `<i class="fas fa-ban text-warning"></i> <strong>${item.driver_name}</strong> <span class="text-warning">DNF</span>`;
    }
    if (item.type === 'dq') {
        return `<i class="fas fa-times-circle text-danger"></i> <strong>${item.driver_name}</strong> <span class="text-danger">DQ</span>`;
    }
    return null;
}

function rebuildTicker() {
    const strip = document.getElementById('tickerStrip');
    const viewport = document.getElementById('tickerViewport');
    strip.innerHTML = '';

    if (tickerQueue.length === 0) {
        strip.innerHTML = '<span class="ticker-entry text-muted">Warte auf Events...</span>';
        return;
    }

    const vpWidth = viewport.offsetWidth;
    let usedWidth = 0;

    // Neueste zuerst (von hinten im Array) einfuegen
    for (let i = tickerQueue.length - 1; i >= 0; i--) {
        const el = document.createElement('div');
        el.className = 'ticker-entry';
        el.innerHTML = tickerQueue[i];
        strip.appendChild(el);

        // Breite messen
        const w = el.offsetWidth;
        usedWidth += w;
        if (usedWidth > vpWidth) {
            el.remove();
            break;
        }
    }
}

function addTickerEvent(item) {
    const html = formatTickerItem(item);
    if (!html) return;
    tickerQueue.push(html);
    if (tickerQueue.length > TICKER_HISTORY) tickerQueue.shift();

    // Neues Element links mit Slide-Animation einfuegen
    const strip = document.getElementById('tickerStrip');
    const viewport = document.getElementById('tickerViewport');
    const newEl = document.createElement('div');
    newEl.className = 'ticker-entry ticker-entry-new';
    newEl.innerHTML = html;
    strip.insertBefore(newEl, strip.firstChild);

    // Animation triggern
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            newEl.classList.remove('ticker-entry-new');
        });
    });

    // Ueberlauf rechts entfernen
    trimTicker();
}

function trimTicker() {
    const strip = document.getElementById('tickerStrip');
    const viewport = document.getElementById('tickerViewport');
    const vpWidth = viewport.offsetWidth;

    while (strip.scrollWidth > vpWidth && strip.children.length > 1) {
        const last = strip.lastElementChild;
        last.classList.add('ticker-entry-out');
        last.addEventListener('animationend', () => last.remove(), { once: true });
        // Fallback falls Animation nicht feuert
        setTimeout(() => { if (last.parentNode) last.remove(); }, 500);
        break; // nur eins pro Durchlauf, Rest beim naechsten Event
    }
}

// Bei Fenstergroessenaenderung neu berechnen
window.addEventListener('resize', () => rebuildTicker());

// Aktives Streckenlayout laden
let lbTrackMap = null;

async function loadLbTrackLayout() {
    try {
        const res = await fetch('/api/active-track-layout');
        if (!res.ok) return;
        const data = await res.json();
        const container = document.getElementById('lbTrackLayout');
        const nameEl = document.getElementById('lbTrackLayoutName');
        if (data.name) nameEl.textContent = data.name;
        if (data.svg_layout) {
            if (lbTrackMap) { lbTrackMap.destroy(); lbTrackMap = null; }
            container.innerHTML = data.svg_layout;
            const svg = container.querySelector('svg');
            if (svg) {
                svg.style.width = '100%';
                svg.style.height = 'auto';
            }
            lbTrackMap = new TrackPositionMap('lbTrackLayout', () => lbData);
            lbTrackMap.init();
        } else {
            container.innerHTML = '<span class="text-muted small">Kein Layout</span>';
        }
    } catch (e) {}
}

// Start
loadTrackRecord();
fetchLeaderboard();
loadTickerFeed();
loadLbTrackLayout();

// WebSocket: Live-Updates statt Polling
socket.on('new_data', (data) => {
    fetchLeaderboard();
    // Ticker nach kurzer Verzoegerung aktualisieren (Events muessen erst in DB sein)
    setTimeout(loadTickerFeed, 500);
});

socket.on('track_record', (data) => {
    if (data && data.laptime_ms) {
        lbTrackRecord = { time: data.laptime_ms, driver: data.driver_name };
        document.getElementById('lb-recordTime').textContent = data.laptime_formatted;
        document.getElementById('lb-recordDriver').textContent = `${data.driver_name} (${data.car_name || '--'})`;
        addTickerEvent({
            type: 'record',
            driver_name: data.driver_name,
            laptime_ms: data.laptime_ms,
            laptime_formatted: data.laptime_formatted,
        });
    }
});

socket.on('penalty', (data) => {
    if (data) {
        addTickerEvent({
            type: 'penalty',
            driver_name: data.driver_name || 'Unbekannt',
            penalty_type: 'Strafe',
        });
    }
});

socket.on('race_status', (data) => {
    if (data) {
        addTickerEvent({
            type: 'status',
            status: data.status || 'unknown',
            race_type: data.race_type || '',
        });
    }
});

socket.on('active_track', () => {
    loadLbTrackLayout();
});

// Fallback
setInterval(fetchLeaderboard, 10000);

// ---- Konsistenz-Score berechnen ----
function updateConsistency() {
    let bestConsistency = null;
    Object.entries(lbData).forEach(([cid, cd]) => {
        const laps = getSessionLaps(cd);
        const times = laps.map(l => l.laptime_raw).filter(t => t > 0);
        if (times.length < 3) return;
        const mean = times.reduce((a,b) => a+b, 0) / times.length;
        const variance = times.reduce((sum, t) => sum + Math.pow(t - mean, 2), 0) / times.length;
        const stdDev = Math.sqrt(variance);
        const pct = (stdDev / mean * 100);
        const name = cd.name || 'Fahrer ' + cid;
        if (!bestConsistency || pct < bestConsistency.pct) {
            bestConsistency = { name, pct, laps: times.length };
        }
    });
    if (bestConsistency) {
        document.getElementById('lb-consistencyDriver').textContent = bestConsistency.name;
        document.getElementById('lb-consistencyDetail').textContent =
            `${bestConsistency.pct.toFixed(1)}% Abweichung (${bestConsistency.laps} Rdn.)`;
    }
}

// ---- Widget Visibility ----
function applyLbWidgetVisibility() {
    const hidden = JSON.parse(localStorage.getItem('sr-lb-hidden-widgets') || '[]');
    document.querySelectorAll('.lb-widget-col').forEach(col => {
        const wid = col.dataset.widget;
        if (hidden.includes(wid)) {
            col.classList.add('d-none');
        } else {
            col.classList.remove('d-none');
        }
    });
    document.querySelectorAll('.lb-widget-vis-cb').forEach(cb => {
        cb.checked = !hidden.includes(cb.value);
    });
}

document.querySelectorAll('.lb-widget-vis-cb').forEach(cb => {
    cb.addEventListener('change', () => {
        const hidden = [];
        document.querySelectorAll('.lb-widget-vis-cb').forEach(c => {
            if (!c.checked) hidden.push(c.value);
        });
        localStorage.setItem('sr-lb-hidden-widgets', JSON.stringify(hidden));
        applyLbWidgetVisibility();
    });
});

applyLbWidgetVisibility();

// ---- Widget Drag & Drop ----
let lbDraggedWidget = null;
const lbWidgetRow = document.getElementById('lbWidgetRow');

lbWidgetRow.addEventListener('dragstart', (e) => {
    const col = e.target.closest('.lb-widget-col');
    if (!col) return;
    lbDraggedWidget = col;
    col.style.opacity = '0.4';
    e.dataTransfer.effectAllowed = 'move';
});

lbWidgetRow.addEventListener('dragend', (e) => {
    const col = e.target.closest('.lb-widget-col');
    if (col) col.style.opacity = '';
    lbDraggedWidget = null;
    document.querySelectorAll('.lb-widget-col').forEach(c => c.style.outline = '');
});

lbWidgetRow.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const col = e.target.closest('.lb-widget-col');
    if (col && col !== lbDraggedWidget) {
        document.querySelectorAll('.lb-widget-col').forEach(c => c.style.outline = '');
        col.style.outline = '2px dashed var(--sr-accent)';
    }
});

lbWidgetRow.addEventListener('drop', (e) => {
    e.preventDefault();
    const target = e.target.closest('.lb-widget-col');
    if (!target || !lbDraggedWidget || target === lbDraggedWidget) return;
    const cols = [...lbWidgetRow.children];
    const fromIdx = cols.indexOf(lbDraggedWidget);
    const toIdx = cols.indexOf(target);
    if (fromIdx < toIdx) {
        target.after(lbDraggedWidget);
    } else {
        target.before(lbDraggedWidget);
    }
    const order = [...lbWidgetRow.children].map(c => c.dataset.widget).filter(Boolean);
    localStorage.setItem('sr-lb-widget-order', JSON.stringify(order));
    document.querySelectorAll('.lb-widget-col').forEach(c => c.style.outline = '');
});

// Widget-Reihenfolge wiederherstellen
(function restoreLbWidgetOrder() {
    const saved = localStorage.getItem('sr-lb-widget-order');
    if (!saved) return;
    try {
        const order = JSON.parse(saved);
        order.forEach(wid => {
            const el = lbWidgetRow.querySelector(`[data-widget="${wid}"]`);
            if (el) lbWidgetRow.appendChild(el);
        });
    } catch (e) {}
})();

// ---- Widget Resize ----
const LB_SIZES = ['3', '6', '12'];
const LB_SIZE_ICONS = { '3': 'fa-expand', '6': 'fa-up-right-and-down-left-from-center', '12': 'fa-compress' };
const LB_SIZE_TITLES = { '3': 'Klein (25%)', '6': 'Mittel (50%)', '12': 'Gross (100%)' };

function getLbWidgetSizes() {
    try { return JSON.parse(localStorage.getItem('sr-lb-widget-sizes') || '{}'); } catch (e) { return {}; }
}

function applyLbWidgetSize(col, size) {
    col.className = col.className.replace(/col-lg-\d+/g, '');
    col.classList.add('col-lg-' + size);
    col.dataset.size = size;
    const btn = col.querySelector('.widget-resize-btn');
    if (btn) {
        btn.innerHTML = '<i class="fas ' + (LB_SIZE_ICONS[size] || 'fa-expand') + '"></i>';
        btn.title = LB_SIZE_TITLES[size] || '';
    }
}

(function initLbWidgetResize() {
    const saved = getLbWidgetSizes();
    document.querySelectorAll('#lbWidgetRow .lb-widget-col').forEach(col => {
        const wid = col.dataset.widget;
        const card = col.querySelector('.card');
        if (card && !col.querySelector('.widget-resize-btn')) {
            const btn = document.createElement('button');
            btn.className = 'widget-resize-btn';
            btn.type = 'button';
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const cur = col.dataset.size || '3';
                const idx = LB_SIZES.indexOf(cur);
                const next = LB_SIZES[(idx + 1) % LB_SIZES.length];
                applyLbWidgetSize(col, next);
                const sizes = getLbWidgetSizes();
                sizes[wid] = next;
                localStorage.setItem('sr-lb-widget-sizes', JSON.stringify(sizes));
            });
            card.appendChild(btn);
        }
        const size = saved[wid] || (col.className.match(/col-lg-(\d+)/) || [])[1] || '3';
        applyLbWidgetSize(col, size);
    });
})();
</script>
{% endblock %}
