{% extends "base.html" %}

{% block title %}Datenbank - SmartRace Live{% endblock %}

{% block content %}
<!-- Header -->
<div class="session-selector d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0"><i class="fas fa-database me-2"></i>Datenbank</h5>
    <div class="d-flex align-items-center gap-2">
        <select id="sessionSelect" class="form-select form-select-sm" style="min-width: 280px;">
            <option value="all">Alle Sessions</option>
        </select>
        <button id="refreshBtn" class="btn btn-sm btn-outline-primary" title="Aktualisieren">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
</div>

<!-- Filter Leiste -->
<div class="filter-section mb-3">
    <div class="row g-2 align-items-end">
        <div class="col-md-2">
            <label class="form-label small text-muted mb-1">Fahrer</label>
            <select id="driverFilter" class="form-select form-select-sm">
                <option value="">Alle Fahrer</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted mb-1">Auto</label>
            <select id="carFilter" class="form-select form-select-sm">
                <option value="">Alle Autos</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted mb-1">Datum von</label>
            <input type="date" id="dateFrom" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted mb-1">Datum bis</label>
            <input type="date" id="dateTo" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
            <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearFilters()">
                <i class="fas fa-times me-1"></i>Filter Reset
            </button>
        </div>
        <div class="col-md-2">
            <button class="btn btn-sm btn-success w-100" onclick="exportCSV()">
                <i class="fas fa-download me-1"></i>CSV Export
            </button>
        </div>
    </div>
</div>

<!-- Statistik Cards -->
<div class="row g-3 mb-3">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body py-2 text-center">
                <div class="fw-bold fs-5" id="statTotal">--</div>
                <div class="small text-muted">Eintraege gesamt</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body py-2 text-center">
                <div class="fw-bold fs-5" id="statFiltered">--</div>
                <div class="small text-muted">Gefiltert</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body py-2 text-center">
                <div class="fw-bold fs-5" id="statDrivers">--</div>
                <div class="small text-muted">Fahrer</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body py-2 text-center">
                <div class="fw-bold fs-5" id="statCars">--</div>
                <div class="small text-muted">Autos</div>
            </div>
        </div>
    </div>
</div>

<!-- Status Alert -->
<div id="statusAlert" class="alert d-none mb-3" role="alert"></div>

<!-- Datentabelle -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th class="sortable" data-col="event_id">Session <i class="fas fa-sort sort-icon"></i></th>
                        <th class="sortable" data-col="event_type">Typ <i class="fas fa-sort sort-icon"></i></th>
                        <th class="sortable" data-col="driver_name">Fahrer <i class="fas fa-sort sort-icon"></i></th>
                        <th class="sortable" data-col="car_name">Auto <i class="fas fa-sort sort-icon"></i></th>
                        <th class="sortable text-center" data-col="lap">Runde <i class="fas fa-sort sort-icon"></i></th>
                        <th class="sortable text-center" data-col="laptime_formatted">Rundenzeit <i class="fas fa-sort sort-icon"></i></th>
                        <th class="text-center">S1</th>
                        <th class="text-center">S2</th>
                        <th class="text-center">S3</th>
                        <th class="sortable text-center" data-col="timestamp">Zeitstempel <i class="fas fa-sort sort-icon"></i></th>
                        <th class="text-center" style="width: 40px;">PB</th>
                    </tr>
                </thead>
                <tbody id="dataBody">
                    <tr><td colspan="11" class="text-center text-muted py-4">Lade Daten...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allData = [];
let currentSort = { col: null, dir: null };
let currentSessionFilter = 'all';

// Sessions laden
async function loadSessions() {
    try {
        const res = await fetch('/api/sessions');
        const sessions = await res.json();
        const sel = document.getElementById('sessionSelect');
        sel.innerHTML = '<option value="all">Alle Sessions</option>';
        sessions.forEach(s => {
            const date = s.start_time ? new Date(s.start_time).toLocaleDateString('de-DE') : '';
            const opt = document.createElement('option');
            opt.value = s.event_id;
            opt.textContent = `${s.event_id} (${s.event_type || 'Training'}) - ${date} - ${s.total_laps} Runden`;
            sel.appendChild(opt);
        });
        sel.value = currentSessionFilter;
    } catch (e) {
        console.error('Sessions-Fehler:', e);
    }
}

// Filter laden
async function loadFilters() {
    try {
        const res = await fetch('/api/filters');
        const data = await res.json();

        const driverSel = document.getElementById('driverFilter');
        const carSel = document.getElementById('carFilter');
        const currentDriver = driverSel.value;
        const currentCar = carSel.value;

        driverSel.innerHTML = '<option value="">Alle Fahrer</option>';
        data.drivers.forEach(d => {
            driverSel.innerHTML += `<option value="${d}">${d}</option>`;
        });

        carSel.innerHTML = '<option value="">Alle Autos</option>';
        data.cars.forEach(c => {
            carSel.innerHTML += `<option value="${c}">${c}</option>`;
        });

        driverSel.value = currentDriver;
        carSel.value = currentCar;

        document.getElementById('statDrivers').textContent = data.drivers.length;
        document.getElementById('statCars').textContent = data.cars.length;
    } catch (e) {
        console.error('Filter-Fehler:', e);
    }
}

// Daten laden
async function loadData() {
    try {
        const params = new URLSearchParams();
        currentSessionFilter = document.getElementById('sessionSelect').value;
        if (currentSessionFilter !== 'all') params.append('session_id', currentSessionFilter);

        const driver = document.getElementById('driverFilter').value;
        if (driver) params.append('driver', driver);

        const car = document.getElementById('carFilter').value;
        if (car) params.append('car', car);

        const dateFrom = document.getElementById('dateFrom').value;
        if (dateFrom) params.append('date_from', dateFrom);

        const dateTo = document.getElementById('dateTo').value;
        if (dateTo) params.append('date_to', dateTo);

        const res = await fetch('/api/laps?' + params);
        allData = await res.json();

        // Sortierung beibehalten
        let displayData = allData;
        if (currentSort.col) {
            displayData = sortData(allData, currentSort.col, currentSort.dir);
        }

        renderTable(displayData);
        document.getElementById('statFiltered').textContent = displayData.length;

        // Total separat laden
        const totalRes = await fetch('/api/laps');
        const totalData = await totalRes.json();
        document.getElementById('statTotal').textContent = totalData.length;

    } catch (e) {
        console.error('Daten-Fehler:', e);
        showStatus('Fehler beim Laden der Daten', 'danger');
    }
}

// Tabelle rendern
function renderTable(data) {
    const tbody = document.getElementById('dataBody');

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted py-4"><i class="fas fa-search me-2"></i>Keine Daten gefunden</td></tr>';
        return;
    }

    tbody.innerHTML = data.map(lap => {
        const rowClass = lap.is_pb ? 'row-pb' : '';

        let typeBadge = 'bg-secondary';
        const et = (lap.event_type || '').toLowerCase();
        if (et.includes('race')) typeBadge = 'bg-danger';
        else if (et.includes('quali')) typeBadge = 'bg-warning text-dark';
        else if (et.includes('practice') || et.includes('training')) typeBadge = 'bg-info';

        const ts = lap.timestamp ? new Date(lap.timestamp).toLocaleString('de-DE', {
            day: '2-digit', month: '2-digit', year: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        }) : '--';

        return `<tr class="${rowClass}">
            <td><span class="badge ${typeBadge} small">${lap.event_id || '--'}</span></td>
            <td class="small">${lap.event_type || '--'}</td>
            <td>${lap.driver_name || '--'}</td>
            <td class="small text-muted">${lap.car_name || '--'}</td>
            <td class="text-center">${lap.lap || '--'}</td>
            <td class="text-center font-mono fw-bold">${lap.laptime_formatted || '--'}</td>
            <td class="text-center font-mono small">${lap.sector_1 || '--'}</td>
            <td class="text-center font-mono small">${lap.sector_2 || '--'}</td>
            <td class="text-center font-mono small">${lap.sector_3 || '--'}</td>
            <td class="text-center small">${ts}</td>
            <td class="text-center">${lap.is_pb ? '<i class="fas fa-trophy text-warning"></i>' : ''}</td>
        </tr>`;
    }).join('');
}

// Sortierung
function sortData(data, col, dir) {
    return [...data].sort((a, b) => {
        let va = a[col], vb = b[col];

        if (col === 'timestamp') {
            va = va ? new Date(va) : new Date(0);
            vb = vb ? new Date(vb) : new Date(0);
        } else if (col === 'lap') {
            va = parseInt(va) || 0;
            vb = parseInt(vb) || 0;
        } else if (col === 'laptime_formatted') {
            va = a.laptime_raw || 999999;
            vb = b.laptime_raw || 999999;
        } else {
            va = (va || '').toString().toLowerCase();
            vb = (vb || '').toString().toLowerCase();
        }

        if (va < vb) return dir === 'asc' ? -1 : 1;
        if (va > vb) return dir === 'asc' ? 1 : -1;
        return 0;
    });
}

function setupSorting() {
    document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const col = th.dataset.col;
            let dir = 'asc';
            if (currentSort.col === col && currentSort.dir === 'asc') dir = 'desc';

            document.querySelectorAll('.sortable').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            th.classList.add('sort-' + dir);
            currentSort = { col, dir };

            renderTable(sortData(allData, col, dir));
        });
    });
}

// CSV Export
function exportCSV() {
    const params = new URLSearchParams();
    const session = document.getElementById('sessionSelect').value;
    if (session !== 'all') params.append('event', session);

    const driver = document.getElementById('driverFilter').value;
    if (driver) params.append('driver', driver);

    const car = document.getElementById('carFilter').value;
    if (car) params.append('car', car);

    const dateFrom = document.getElementById('dateFrom').value;
    if (dateFrom) params.append('date_from', dateFrom);

    const dateTo = document.getElementById('dateTo').value;
    if (dateTo) params.append('date_to', dateTo);

    const link = document.createElement('a');
    link.href = '/api/export/csv?' + params;
    link.download = 'smartrace_export.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showStatus('CSV wird heruntergeladen...', 'success');
}

// Filter zuruecksetzen
function clearFilters() {
    document.getElementById('sessionSelect').value = 'all';
    document.getElementById('driverFilter').value = '';
    document.getElementById('carFilter').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    currentSessionFilter = 'all';
    currentSort = { col: null, dir: null };
    document.querySelectorAll('.sortable').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
    loadData();
}

// Status-Nachricht
function showStatus(msg, type) {
    const el = document.getElementById('statusAlert');
    el.className = 'alert alert-' + type + ' mb-3';
    el.textContent = msg;
    el.classList.remove('d-none');
    if (type !== 'danger') {
        setTimeout(() => el.classList.add('d-none'), 4000);
    }
}

// Event Listener
document.addEventListener('DOMContentLoaded', async () => {
    await loadSessions();
    await loadFilters();
    await loadData();
    setupSorting();
});

document.getElementById('sessionSelect').addEventListener('change', () => { loadFilters(); loadData(); });
document.getElementById('driverFilter').addEventListener('change', loadData);
document.getElementById('carFilter').addEventListener('change', loadData);
document.getElementById('dateFrom').addEventListener('change', loadData);
document.getElementById('dateTo').addEventListener('change', loadData);

document.getElementById('refreshBtn').addEventListener('click', async function() {
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    this.disabled = true;
    await loadSessions();
    await loadFilters();
    await loadData();
    this.innerHTML = '<i class="fas fa-sync-alt"></i>';
    this.disabled = false;
});

// Auto-Refresh alle 30s
setInterval(() => {
    if (currentSessionFilter === 'all') loadData();
}, 30000);

// Keyboard Shortcuts
document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') { e.preventDefault(); exportCSV(); }
    if (e.key === 'Escape') clearFilters();
});
</script>
{% endblock %}
