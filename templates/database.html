{% extends "base.html" %}

{% block title %}Database - SmartRace{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Race Database</h2>
    </div>
</div>

<!-- Filter und Export Sektion -->
<div class="row mb-4">
    <div class="col-md-2">
        <select id="driverFilter" class="form-select">
            <option value="">Alle Fahrer</option>
        </select>
    </div>
    <div class="col-md-2">
        <select id="carFilter" class="form-select">
            <option value="">Alle Autos</option>
        </select>
    </div>
    <!-- ✅ NEU: Event Filter -->
    <div class="col-md-2">
        <select id="eventFilter" class="form-select">
            <option value="">Alle Events</option>
        </select>
    </div>
    <div class="col-md-6">
        <div class="btn-group w-100" role="group">
            <button type="button" class="btn btn-success" onclick="exportCSV()">
                <i class="fas fa-download"></i> CSV Export
            </button>
            <button type="button" class="btn btn-primary" onclick="exportDropbox()" id="dropboxBtn">
                <i class="fab fa-dropbox"></i> Zu Dropbox
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="showDropboxConfig()">
                <i class="fas fa-cog"></i> Dropbox Setup
            </button>
        </div>
    </div>
</div>


<!-- Export Status -->
<div id="exportStatus" class="alert d-none" role="alert"></div>

<!-- Statistiken -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="totalLaps">-</h5>
                <p class="card-text">Gesamte Runden</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="totalDrivers">-</h5>
                <p class="card-text">Fahrer</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="totalCars">-</h5>
                <p class="card-text">Autos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="filteredRows">-</h5>
                <p class="card-text">Gefilterte Einträge</p>
            </div>
        </div>
    </div>
</div>

<!-- Daten Tabelle -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Event ID</th>
                                <th>Fahrer</th>
                                <th>Auto</th>
                                <th>Runde</th>
                                <th>Rundenzeit</th>
                                <th>Sektor 1</th>
                                <th>Sektor 2</th>
                                <th>Sektor 3</th>
                                <th>Zeitstempel</th>
                                <th>PB</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dropbox Konfiguration Modal -->
<div class="modal fade" id="dropboxModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dropbox Konfiguration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dropboxStatus" class="mb-3"></div>
                
                <div class="mb-3">
                    <label for="dropboxToken" class="form-label">Dropbox Access Token</label>
                    <input type="password" class="form-control" id="dropboxToken" 
                           placeholder="Dropbox Access Token eingeben">
                    <div class="form-text">
                        <strong>So erhältst du einen Access Token:</strong><br>
                        1. Gehe zu <a href="https://www.dropbox.com/developers/apps" target="_blank">Dropbox App Console</a><br>
                        2. Erstelle eine neue App (Scoped access, Full Dropbox)<br>
                        3. Gehe zu "Settings" → "Generated access token"<br>
                        4. Klicke "Generate" und kopiere den Token hier ein
                    </div>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Exports werden im Ordner "/SmartRace_Exports" in deiner Dropbox gespeichert.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                <button type="button" class="btn btn-success" onclick="testDropboxConnection()">Test Verbindung</button>
                <button type="button" class="btn btn-primary" onclick="saveDropboxConfig()">Speichern</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentData = [];
let dropboxConfigured = false;

// ✅ NEU: Events laden
function loadEvents() {
    fetch('/api/events')
        .then(response => response.json())
        .then(data => {
            const eventSelect = document.getElementById('eventFilter');
            eventSelect.innerHTML = '<option value="">Alle Events</option>';
            
            data.forEach(event => {
                const option = document.createElement('option');
                option.value = event.event_id;
                option.textContent = event.event_id;
                eventSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading events:', error);
        });
}

function loadFilters() {
    fetch('/api/filters')
        .then(response => response.json())
        .then(data => {
            const driverSelect = document.getElementById('driverFilter');
            const carSelect = document.getElementById('carFilter');
            
            driverSelect.innerHTML = '<option value="">Alle Fahrer</option>';
            carSelect.innerHTML = '<option value="">Alle Autos</option>';
            
            data.drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver;
                option.textContent = driver;
                driverSelect.appendChild(option);
            });
            
            data.cars.forEach(car => {
                const option = document.createElement('option');
                option.value = car;
                option.textContent = car;
                carSelect.appendChild(option);
            });
            
            document.getElementById('totalDrivers').textContent = data.drivers.length;
            document.getElementById('totalCars').textContent = data.cars.length;
        });
}

function loadData() {
    const driverFilter = document.getElementById('driverFilter').value;
    const carFilter = document.getElementById('carFilter').value;
    const eventFilter = document.getElementById('eventFilter').value; // ✅ NEU
    
    const params = new URLSearchParams();
    if (driverFilter) params.append('driver', driverFilter);
    if (carFilter) params.append('car', carFilter);
    if (eventFilter) params.append('event', eventFilter); // ✅ NEU
    
    fetch(`/api/database?${params}`)
        .then(response => response.json())
        .then(data => {
            currentData = data;
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            data.forEach(lap => {
                const row = document.createElement('tr');
                if (lap.is_pb) row.classList.add('table-success');
                
                row.innerHTML = `
                    <td>${lap.event_id || '-'}</td>
                    <td>${lap.driver || '-'}</td>
                    <td>${lap.car || '-'}</td>
                    <td>${lap.lap || '-'}</td>
                    <td>${lap.laptime || '-'}</td>
                    <td>${lap.sector_1 || '-'}</td>
                    <td>${lap.sector_2 || '-'}</td>
                    <td>${lap.sector_3 || '-'}</td>
                    <td>${new Date(lap.timestamp).toLocaleString()}</td>
                    <td>${lap.is_pb ? '<i class="fas fa-trophy text-warning"></i>' : ''}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            document.getElementById('filteredRows').textContent = data.length;
            
            fetch('/api/database')
                .then(response => response.json())
                .then(allData => {
                    document.getElementById('totalLaps').textContent = allData.length;
                });
        })
        .catch(error => {
            console.error('Error:', error);
            showStatus('Fehler beim Laden der Daten', 'danger');
        });
}

// Restliche Funktionen bleiben gleich...
function exportCSV() {
    const driverFilter = document.getElementById('driverFilter').value;
    const carFilter = document.getElementById('carFilter').value;
    const eventFilter = document.getElementById('eventFilter').value; // ✅ NEU
    
    const params = new URLSearchParams();
    if (driverFilter) params.append('driver', driverFilter);
    if (carFilter) params.append('car', carFilter);
    if (eventFilter) params.append('event', eventFilter); // ✅ NEU
    
    showStatus('CSV Export wird erstellt...', 'info');
    
    const link = document.createElement('a');
    link.href = `/api/export/csv?${params}`;
    link.download = `smartrace_export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => {
        showStatus(`CSV Export erfolgreich! ${currentData.length} Einträge exportiert.`, 'success');
    }, 1000);
}

// ... alle anderen Funktionen bleiben gleich ...

// Event Listeners - ✅ NEU erweitern:
document.getElementById('driverFilter').addEventListener('change', loadData);
document.getElementById('carFilter').addEventListener('change', loadData);
document.getElementById('eventFilter').addEventListener('change', loadData); // ✅ NEU

// Initial load - ✅ erweitern:
loadFilters();
loadEvents(); // ✅ NEU
loadData();
checkDropboxStatus();
</script>

{% endblock %}
