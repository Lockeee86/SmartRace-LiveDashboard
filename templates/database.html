{% extends "base.html" %}

{% block title %}Database - SmartRace{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Race Database</h2>
    </div>
</div>

<!-- 🎯 ERWEITERTE FILTER-SEKTION -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">📊 Filter & Export</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- ✅ NEUE SESSION-AUSWAHL -->
            <div class="col-md-3 mb-3">
                <label for="sessionSelect" class="form-label">📋 Session</label>
                <select id="sessionSelect" class="form-select">
                    <option value="">Alle Sessions</option>
                    <option value="current">🟢 Aktuelle Session</option>
                    <!-- Dynamisch gefüllt -->
                </select>
            </div>
            
            <!-- DATUM FILTER -->
            <div class="col-md-3 mb-3">
                <label for="dateFilter" class="form-label">📅 Datum</label>
                <input type="date" id="dateFilter" class="form-control">
            </div>
            
            <!-- FAHRER FILTER -->
            <div class="col-md-3 mb-3">
                <label for="driverFilter" class="form-label">🏁 Fahrer</label>
                <select id="driverFilter" class="form-select">
                    <option value="">Alle Fahrer</option>
                    <!-- Dynamisch gefüllt -->
                </select>
            </div>
            
            <!-- AKTIONEN -->
            <div class="col-md-3 mb-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="resetAllFilters()">
                        🔄 Reset
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportData()">
                        📥 Export
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ✅ AKTIVE FILTER ANZEIGE -->
        <div id="activeFilters" class="mt-2"></div>
    </div>
</div>

<!-- TABELLE -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="dataTable">
                <thead class="table-dark">
                    <tr>
                        <th style="cursor: pointer;" onclick="sortTable(0)">
                            📅 Timestamp <i class="fas fa-sort"></i>
                        </th>
                        <th style="cursor: pointer;" onclick="sortTable(1)">
                            📋 Session <i class="fas fa-sort"></i>
                        </th>
                        <th style="cursor: pointer;" onclick="sortTable(2)">
                            🏁 Fahrer <i class="fas fa-sort"></i>
                        </th>
                        <th style="cursor: pointer;" onclick="sortTable(3)">
                            ⏱️ Rundenzeit <i class="fas fa-sort"></i>
                        </th>
                        <th style="cursor: pointer;" onclick="sortTable(4)">
                            🔢 Runde <i class="fas fa-sort"></i>
                        </th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Dynamisch gefüllt -->
                </tbody>
            </table>
        </div>
        
        <div class="mt-3 d-flex justify-content-between align-items-center">
            <div>
                <span id="recordCount" class="text-muted">0 Einträge</span>
            </div>
            <div>
                <button class="btn btn-primary" onclick="loadData()">
                    🔄 Aktualisieren
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allData = [];
let filteredData = [];
let currentSession = null;
let availableSessions = [];
let availableDrivers = [];

// ✅ DATEN LADEN UND SESSIONS ERKENNEN
function loadData() {
    fetch('/api/database')
        .then(response => response.json())
        .then(data => {
            allData = data;
            extractSessionsAndDrivers();
            populateFilterOptions();
            applyFilters();
            console.log(`📊 ${data.length} Einträge geladen`);
        })
        .catch(error => {
            console.error('❌ Fehler beim Laden:', error);
        });
}

// ✅ SESSIONS UND FAHRER EXTRAHIEREN
function extractSessionsAndDrivers() {
    const sessions = [...new Set(allData.map(item => item.session_id))].sort((a, b) => b - a);
    const drivers = [...new Set(allData.map(item => item.driver))].sort();
    
    availableSessions = sessions;
    availableDrivers = drivers;
    currentSession = sessions[0]; // Höchste Session-ID = aktuell
    
    console.log(`🔍 ${sessions.length} Sessions gefunden:`, sessions);
    console.log(`🏁 ${drivers.length} Fahrer gefunden:`, drivers);
    console.log(`🟢 Aktuelle Session: ${currentSession}`);
}

// ✅ FILTER-OPTIONEN FÜLLEN
function populateFilterOptions() {
    const sessionSelect = document.getElementById('sessionSelect');
    const driverSelect = document.getElementById('driverFilter');
    
    // Session-Optionen
    sessionSelect.innerHTML = `
        <option value="">Alle Sessions (${availableSessions.length})</option>
        <option value="current">🟢 Aktuelle Session (${currentSession})</option>
        <option disabled>────────────────</option>
    `;
    
    availableSessions.forEach(session => {
        const count = allData.filter(item => item.session_id === session).length;
        const isCurrent = session === currentSession;
        sessionSelect.innerHTML += `
            <option value="${session}">
                ${isCurrent ? '🟢' : '📋'} Session ${session} (${count} Runden)
            </option>
        `;
    });
    
    // Fahrer-Optionen
    driverSelect.innerHTML = '<option value="">Alle Fahrer</option>';
    availableDrivers.forEach(driver => {
        const count = allData.filter(item => item.driver === driver).length;
        driverSelect.innerHTML += `<option value="${driver}">${driver} (${count})</option>`;
    });
}

// ✅ FILTER ANWENDEN
function applyFilters() {
    const dateFilter = document.getElementById('dateFilter').value;
    const sessionFilter = document.getElementById('sessionSelect').value;
    const driverFilter = document.getElementById('driverFilter').value;
    
    filteredData = allData.filter(item => {
        // Datum Filter
        if (dateFilter) {
            const itemDate = new Date(item.timestamp).toISOString().split('T')[0];
            if (itemDate !== dateFilter) return false;
        }
        
        // Session Filter
        if (sessionFilter) {
            if (sessionFilter === 'current') {
                if (item.session_id !== currentSession) return false;
            } else if (item.session_id != sessionFilter) {
                return false;
            }
        }
        
        // Fahrer Filter
        if (driverFilter && item.driver !== driverFilter) return false;
        
        return true;
    });
    
    displayData();
    updateActiveFilters();
    updateRecordCount();
}

// ✅ AKTIVE FILTER ANZEIGEN
function updateActiveFilters() {
    const dateFilter = document.getElementById('dateFilter').value;
    const sessionFilter = document.getElementById('sessionSelect').value;
    const driverFilter = document.getElementById('driverFilter').value;
    
    let filters = [];
    
    if (dateFilter) {
        filters.push(`<span class="badge bg-primary">📅 ${dateFilter}</span>`);
    }
    
    if (sessionFilter) {
        if (sessionFilter === 'current') {
            filters.push(`<span class="badge bg-success">🟢 Aktuelle Session (${currentSession})</span>`);
        } else {
            filters.push(`<span class="badge bg-info">📋 Session ${sessionFilter}</span>`);
        }
    }
    
    if (driverFilter) {
        filters.push(`<span class="badge bg-warning">🏁 ${driverFilter}</span>`);
    }
    
    const activeFiltersDiv = document.getElementById('activeFilters');
    if (filters.length > 0) {
        activeFiltersDiv.innerHTML = `<strong>Aktive Filter:</strong> ${filters.join(' ')}`;
    } else {
        activeFiltersDiv.innerHTML = '<em class="text-muted">Keine Filter aktiv</em>';
    }
}

// ✅ DATEN ANZEIGEN
function displayData() {
    const tbody = document.getElementById('tableBody');
    
    if (filteredData.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="5" class="text-center text-muted py-4">
                📭 Keine Daten gefunden
            </td></tr>
        `;
        return;
    }
    
    tbody.innerHTML = filteredData.map(item => {
        const sessionBadge = item.session_id === currentSession 
            ? `<span class="badge bg-success">🟢 ${item.session_id}</span>`
            : `<span class="badge bg-secondary">📋 ${item.session_id}</span>`;
            
        return `
            <tr>
                <td>${new Date(item.timestamp).toLocaleString('de-DE')}</td>
                <td>${sessionBadge}</td>
                <td><strong>${item.driver}</strong></td>
                <td><code>${(item.laptime / 1000).toFixed(3)}s</code></td>
                <td>${item.lap_number || '-'}</td>
            </tr>
        `;
    }).join('');
}

// BESTEHENDE FUNKTIONEN...
function resetAllFilters() {
    document.getElementById('dateFilter').value = '';
    document.getElementById('sessionSelect').value = '';
    document.getElementById('driverFilter').value = '';
    applyFilters();
}

function updateRecordCount() {
    document.getElementById('recordCount').textContent = 
        `${filteredData.length} von ${allData.length} Einträgen`;
}

function exportData() {
    const dateStr = document.getElementById('dateFilter').value || 'alle';
    const sessionStr = document.getElementById('sessionSelect').value || 'alle';
    const driverStr = document.getElementById('driverFilter').value || 'alle';
    
    const filename = `smartrace_${dateStr}_session${sessionStr}_${driverStr}.csv`;
    
    const csv = [
        'Timestamp,Session,Fahrer,Rundenzeit_ms,Rundenzeit_s,Runde',
        ...filteredData.map(item => 
            `"${item.timestamp}",${item.session_id},"${item.driver}",${item.laptime},${(item.laptime/1000).toFixed(3)},${item.lap_number || ''}`
        )
    ].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Sortier-Funktionalität (vereinfacht)
function sortTable(column) {
    // Implementierung bleibt gleich wie vorher
    console.log(`🔄 Sortiere nach Spalte ${column}`);
}

// EVENT LISTENER
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    
    // Filter Event Listener
    document.getElementById('dateFilter').addEventListener('change', applyFilters);
    document.getElementById('sessionSelect').addEventListener('change', applyFilters);
    document.getElementById('driverFilter').addEventListener('change', applyFilters);
});

// Auto-Refresh alle 30 Sekunden
setInterval(loadData, 30000);
</script>
{% endblock %}
