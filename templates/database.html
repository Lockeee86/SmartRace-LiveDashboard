{% extends "base.html" %}

{% block title %}Database - SmartRace{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Race Database</h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <select id="driverFilter" class="form-select">
            <option value="">Alle Fahrer</option>
        </select>
    </div>
    <div class="col-md-6">
        <select id="carFilter" class="form-select">
            <option value="">Alle Autos</option>
        </select>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Fahrer</th>
                                <th>Auto</th>
                                <th>Runde</th>
                                <th>Rundenzeit</th>
                                <th>Sektor 1</th>
                                <th>Sektor 2</th>
                                <th>Sektor 3</th>
                                <th>Zeitstempel</th>
                                <th>PB</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadFilters() {
    fetch('/api/filters')
        .then(response => response.json())
        .then(data => {
            const driverSelect = document.getElementById('driverFilter');
            const carSelect = document.getElementById('carFilter');
            
            data.drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver;
                option.textContent = driver;
                driverSelect.appendChild(option);
            });
            
            data.cars.forEach(car => {
                const option = document.createElement('option');
                option.value = car;
                option.textContent = car;
                carSelect.appendChild(option);
            });
        });
}

function loadData() {
    const driverFilter = document.getElementById('driverFilter').value;
    const carFilter = document.getElementById('carFilter').value;
    
    const params = new URLSearchParams();
    if (driverFilter) params.append('driver', driverFilter);
    if (carFilter) params.append('car', carFilter);
    
    fetch(`/api/database?${params}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';
            
            data.forEach(lap => {
                const row = document.createElement('tr');
                if (lap.is_pb) row.classList.add('table-success');
                
                row.innerHTML = `
                    <td>${lap.driver}</td>
                    <td>${lap.car}</td>
                    <td>${lap.lap}</td>
                    <td>${lap.laptime}</td>
                    <td>${lap.sector_1}</td>
                    <td>${lap.sector_2}</td>
                    <td>${lap.sector_3}</td>
                    <td>${new Date(lap.timestamp).toLocaleString()}</td>
                    <td>${lap.is_pb ? '<i class="fas fa-trophy text-warning"></i>' : ''}</td>
                `;
                
                tbody.appendChild(row);
            });
        });
}

document.getElementById('driverFilter').addEventListener('change', loadData);
document.getElementById('carFilter').addEventListener('change', loadData);

loadFilters();
loadData();
</script>
{% endblock %}
