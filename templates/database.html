{% extends "base.html" %}

{% block title %}Database - SmartRace{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Race Database</h2>
            
            <!-- ‚úÖ SESSION-AUSWAHL -->
            <div class="d-flex align-items-center gap-3">
                <label for="sessionSelect" class="form-label mb-0">
                    <i class="fas fa-database"></i> Session:
                </label>
                <select id="sessionSelect" class="form-select" style="min-width: 350px;">
                    <option value="all">üåç Alle Sessions</option>
                    <!-- Wird dynamisch gef√ºllt -->
                </select>
                <button id="refreshSessions" class="btn btn-outline-primary btn-sm" title="Sessions aktualisieren">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filter und Export Sektion -->
<div class="row mb-4">
    <div class="col-md-2">
        <select id="driverFilter" class="form-select">
            <option value="">Alle Fahrer</option>
        </select>
    </div>
    <div class="col-md-2">
        <select id="carFilter" class="form-select">
            <option value="">Alle Autos</option>
        </select>
    </div>
    <!-- ‚úÖ NEUER DATUMS-FILTER -->
    <div class="col-md-2">
        <input type="date" id="dateFilter" class="form-control" title="Filter nach Datum">
    </div>
    <div class="col-md-1">
        <button type="button" class="btn btn-outline-secondary" onclick="clearDateFilter()" title="Datum zur√ºcksetzen">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="col-md-5">
        <div class="btn-group w-100" role="group">
            <button type="button" class="btn btn-success" onclick="exportCSV()">
                <i class="fas fa-download"></i> CSV Export
            </button>
            <button type="button" class="btn btn-primary" onclick="exportDropbox()" id="dropboxBtn">
                <i class="fab fa-dropbox"></i> Zu Dropbox
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="showDropboxConfig()">
                <i class="fas fa-cog"></i> Dropbox Setup
            </button>
        </div>
    </div>
</div>

<!-- ‚úÖ FILTER STATUS ANZEIGE -->
<div class="row mb-3" id="filterStatus" style="display: none;">
    <div class="col-12">
        <div class="alert alert-info py-2 mb-0">
            <i class="fas fa-filter"></i> <span id="filterText"></span>
            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearAllFilters()">
                Alle Filter zur√ºcksetzen
            </button>
        </div>
    </div>
</div>

<!-- Export Status -->
<div id="exportStatus" class="alert d-none" role="alert"></div>

<!-- Statistiken -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="totalLaps">-</h5>
                <p class="card-text">Gesamte Runden</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="totalDrivers">-</h5>
                <p class="card-text">Fahrer</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="totalCars">-</h5>
                <p class="card-text">Autos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title" id="filteredRows">-</h5>
                <p class="card-text">Gefilterte Eintr√§ge</p>
            </div>
        </div>
    </div>
</div>

<!-- Daten Tabelle -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th class="sortable" data-column="event_id">
                                    Session <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="event_type">
                                    Typ <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="driver_name">
                                    Fahrer <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="car_name">
                                    Auto <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="lap">
                                    Runde <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="laptime_formatted">
                                    Rundenzeit <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="sector_1">
                                    Sektor 1 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="sector_2">
                                    Sektor 2 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="sector_3">
                                    Sektor 3 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="timestamp">
                                    Zeitstempel <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable" data-column="is_pb">
                                    PB <i class="fas fa-sort sort-icon"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dropbox Konfiguration Modal -->
<div class="modal fade" id="dropboxModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dropbox Konfiguration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dropboxStatus" class="mb-3"></div>
                
                <div class="mb-3">
                    <label for="dropboxToken" class="form-label">Dropbox Access Token</label>
                    <input type="password" class="form-control" id="dropboxToken" 
                           placeholder="Dropbox Access Token eingeben">
                    <div class="form-text">
                        <strong>So erh√§ltst du einen Access Token:</strong><br>
                        1. Gehe zu <a href="https://www.dropbox.com/developers/apps" target="_blank">Dropbox App Console</a><br>
                        2. Erstelle eine neue App (Scoped access, Full Dropbox)<br>
                        3. Gehe zu "Settings" ‚Üí "Generated access token"<br>
                        4. Klicke "Generate" und kopiere den Token hier ein
                    </div>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Exports werden im Ordner "/SmartRace_Exports" in deiner Dropbox gespeichert.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
                <button type="button" class="btn btn-success" onclick="testDropboxConnection()">Test Verbindung</button>
                <button type="button" class="btn btn-primary" onclick="saveDropboxConfig()">Speichern</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Sortierbare Tabellen Styles */
.sortable {
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s;
}

.sortable:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.sort-icon {
    margin-left: 5px;
    opacity: 0.5;
    transition: opacity 0.2s;
}

.sortable:hover .sort-icon {
    opacity: 1;
}

.sortable.sort-asc .sort-icon:before {
    content: "\f0de"; /* fa-sort-up */
    color: #007bff;
    opacity: 1;
}

.sortable.sort-desc .sort-icon:before {
    content: "\f0dd"; /* fa-sort-down */
    color: #007bff;
    opacity: 1;
}

.controller-row {
    border-left: 4px solid var(--controller-color);
    background: linear-gradient(90deg, var(--controller-color)10 0%, transparent 50px);
}

.controller-badge {
    color: white;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
}
    
/* ‚úÖ DATUMS-FILTER STYLES */
#dateFilter {
    cursor: pointer;
}

#filterStatus .alert {
    border-radius: 8px;
    border-left: 4px solid #17a2b8;
}

/* ‚úÖ SESSION-AUSWAHL STYLES */
#sessionSelect {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

#sessionSelect option {
    padding: 5px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentData = [];
let availableSessions = [];
let currentSessionFilter = 'all';
let dropboxConfigured = false;
let currentSort = { column: null, direction: null };

// ‚úÖ SESSION-MANAGEMENT
async function loadSessions() {
    try {
        const response = await fetch('/api/sessions');
        if (!response.ok) throw new Error('Sessions laden fehlgeschlagen');
        
        availableSessions = await response.json();
        
        const sessionSelect = document.getElementById('sessionSelect');
        sessionSelect.innerHTML = '<option value="all">üåç Alle Sessions</option>';
        
        availableSessions.forEach((session, index) => {
            const option = document.createElement('option');
            option.value = session.event_id;
            
            // Sch√∂ne Anzeige mit Datum und Details
            const startDate = session.start_time ? new Date(session.start_time).toLocaleDateString('de-DE') : 'Unbekannt';
            const duration = session.start_time && session.end_time ? 
                Math.round((new Date(session.end_time) - new Date(session.start_time)) / 60000) + 'min' : '';
            
            option.textContent = `${session.event_id} (${session.event_type || 'Training'}) - ${startDate} - ${session.total_laps} Runden, ${session.drivers} Fahrer ${duration}`;
            
            // Neueste Session als Standard (falls nicht "all" gew√§hlt)
            if (index === 0 && currentSessionFilter === 'all') {
                // Kommentar: Du kannst das aktivieren wenn du willst dass automatisch die neueste Session gew√§hlt wird
                // option.selected = true;
                // currentSessionFilter = session.event_id;
            }
            
            sessionSelect.appendChild(option);
        });
        
        // Aktuell gew√§hlte Session beibehalten
        sessionSelect.value = currentSessionFilter;
        
        console.log('üîç Sessions geladen:', availableSessions.length);
        
    } catch (error) {
        console.error('‚ùå Session loading error:', error);
        showStatus('Fehler beim Laden der Sessions', 'danger');
    }
}

// ‚úÖ DATUMS-FILTER FUNKTIONEN
function formatDateForFilter(date) {
    return date.toISOString().split('T')[0];
}

function isSameDay(date1, date2) {
    return formatDateForFilter(date1) === formatDateForFilter(date2);
}

function updateFilterStatus() {
    const sessionFilter = document.getElementById('sessionSelect').value;
    const driverFilter = document.getElementById('driverFilter').value;
    const carFilter = document.getElementById('carFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    const filterParts = [];
    if (sessionFilter && sessionFilter !== 'all') {
        const session = availableSessions.find(s => s.event_id === sessionFilter);
        filterParts.push(`Session: ${session ? session.display_name : sessionFilter}`);
    }
    if (driverFilter) filterParts.push(`Fahrer: ${driverFilter}`);
    if (carFilter) filterParts.push(`Auto: ${carFilter}`);
    if (dateFilter) filterParts.push(`Datum: ${new Date(dateFilter).toLocaleDateString('de-DE')}`);
    
    const filterStatus = document.getElementById('filterStatus');
    const filterText = document.getElementById('filterText');
    
    if (filterParts.length > 0) {
        filterText.textContent = `Aktive Filter: ${filterParts.join(', ')}`;
        filterStatus.style.display = 'block';
    } else {
        filterStatus.style.display = 'none';
    }
}

function clearDateFilter() {
    document.getElementById('dateFilter').value = '';
    loadData();
    console.log('üìÖ Datumsfilter zur√ºckgesetzt');
}

function clearAllFilters() {
    document.getElementById('sessionSelect').value = 'all';
    document.getElementById('driverFilter').value = '';
    document.getElementById('carFilter').value = '';
    document.getElementById('dateFilter').value = '';
    currentSessionFilter = 'all';
    loadData();
    console.log('üîÑ Alle Filter zur√ºckgesetzt');
}

// ‚úÖ SORTIERUNGS-FUNKTIONEN
function sortData(data, column, direction) {
    return [...data].sort((a, b) => {
        let valA = a[column];
        let valB = b[column];
        
        if (column === 'timestamp') {
            valA = new Date(valA);
            valB = new Date(valB);
        } else if (column === 'lap') {
            valA = parseInt(valA) || 0;
            valB = parseInt(valB) || 0;
        } else if (column === 'laptime_formatted' || column === 'sector_1' || column === 'sector_2' || column === 'sector_3') {
            valA = timeToMs(valA) || 999999999;
            valB = timeToMs(valB) || 999999999;
        } else if (column === 'is_pb') {
            valA = valA ? 1 : 0;
            valB = valB ? 1 : 0;
        } else {
            valA = (valA || '').toString().toLowerCase();
            valB = (valB || '').toString().toLowerCase();
        }
        
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
    });
}

function timeToMs(timeStr) {
    if (!timeStr || timeStr === '-') return null;
    
    const parts = timeStr.split(':');
    let minutes = 0;
    let seconds = 0;
    
    if (parts.length === 2) {
        minutes = parseInt(parts[0]) || 0;
        seconds = parseFloat(parts[1]) || 0;
    } else {
        seconds = parseFloat(parts[0]) || 0;
    }
    
    return (minutes * 60 + seconds) * 1000;
}

function setupTableSorting() {
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', (e) => {
            const column = e.currentTarget.getAttribute('data-column');
            
            let direction = 'asc';
            if (currentSort.column === column && currentSort.direction === 'asc') {
                direction = 'desc';
            }
            
            document.querySelectorAll('.sortable').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            
            e.currentTarget.classList.add(`sort-${direction}`);
            currentSort = { column, direction };
            
            const sortedData = sortData(currentData, column, direction);
            renderTable(sortedData);
            
            console.log(`üîÑ Sortiert nach ${column} (${direction})`);
        });
    });
}

function renderTable(data) {
    const tbody = document.getElementById('dataTable');
    tbody.innerHTML = '';
    
    if (data.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center py-4 text-muted">
                    <i class="fas fa-search"></i><br>
                    Keine Daten gefunden
                </td>
            </tr>
        `;
        return;
    }
    
    data.forEach(lap => {
        const row = document.createElement('tr');
        if (lap.is_pb) row.classList.add('table-success');
        
        // Session Badge mit Typ-Farbe
        let sessionBadgeClass = 'bg-primary';
        if (lap.event_type === 'Race') sessionBadgeClass = 'bg-danger';
        else if (lap.event_type === 'Qualifying') sessionBadgeClass = 'bg-warning text-dark';
        else if (lap.event_type === 'Practice') sessionBadgeClass = 'bg-info';
        
        row.innerHTML = `
            <td>
                <span class="badge ${sessionBadgeClass}">${lap.event_id || '-'}</span>
            </td>
            <td>${lap.event_type || '-'}</td>
            <td>${lap.driver_name || '-'}</td>
            <td>${lap.car_name || '-'}</td>
            <td>${lap.lap || '-'}</td>
            <td><strong>${lap.laptime_formatted || '-'}</strong></td>
            <td>${lap.sector_1 || '-'}</td>
            <td>${lap.sector_2 || '-'}</td>
            <td>${lap.sector_3 || '-'}</td>
            <td>${lap.timestamp ? new Date(lap.timestamp).toLocaleString('de-DE') : '-'}</td>
            <td>${lap.is_pb ? '<i class="fas fa-trophy text-warning" title="Personal Best"></i>' : ''}</td>
        `;
        
        tbody.appendChild(row);
    });
}

function loadFilters() {
    // Session-spezifische Filter laden wenn eine Session gew√§hlt ist
    const sessionParam = currentSessionFilter !== 'all' ? `?session_id=${encodeURIComponent(currentSessionFilter)}` : '';
    
    fetch(`/api/filters${sessionParam}`)
        .then(response => response.json())
        .then(data => {
            const driverSelect = document.getElementById('driverFilter');
            const carSelect = document.getElementById('carFilter');
            
            driverSelect.innerHTML = '<option value="">Alle Fahrer</option>';
            carSelect.innerHTML = '<option value="">Alle Autos</option>';
            
            data.drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver;
                option.textContent = driver;
                driverSelect.appendChild(option);
            });
            
            data.cars.forEach(car => {
                const option = document.createElement('option');
                option.value = car;
                option.textContent = car;
                carSelect.appendChild(option);
            });
            
            document.getElementById('totalDrivers').textContent = data.drivers.length;
            document.getElementById('totalCars').textContent = data.cars.length;
        })
        .catch(error => {
            console.error('Filter loading error:', error);
        });
}

// ‚úÖ ERWEITERTE LOADDATA FUNKTION
async function loadData() {
    try {
        currentSessionFilter = document.getElementById('sessionSelect').value;
        const driverFilter = document.getElementById('driverFilter').value;
        const carFilter = document.getElementById('carFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        
        const params = new URLSearchParams();
        if (currentSessionFilter && currentSessionFilter !== 'all') {
            params.append('session_id', currentSessionFilter);
        }
        if (driverFilter) params.append('driver', driverFilter);
        if (carFilter) params.append('car', carFilter);
        if (dateFilter) params.append('date', dateFilter);
        
        const response = await fetch(`/api/laps?${params}`);
        if (!response.ok) throw new Error('Daten laden fehlgeschlagen');
        
        const data = await response.json();
        currentData = data;
        
        // Sortierung beibehalten
        let displayData = data;
        if (currentSort.column) {
            displayData = sortData(data, currentSort.column, currentSort.direction);
        }
        
        renderTable(displayData);
        updateFilterStatus();
        
        // Update statistics
        document.getElementById('filteredRows').textContent = displayData.length;
        
        // Gesamtzahl laden (ohne Filter)
        const totalResponse = await fetch('/api/laps');
        const totalData = await totalResponse.json();
        document.getElementById('totalLaps').textContent = totalData.length;
        
        console.log(`üìä Daten geladen: ${displayData.length} von ${totalData.length} Eintr√§gen`);
        
    } catch (error) {
        console.error('‚ùå Load error:', error);
        showStatus('Fehler beim Laden der Daten', 'danger');
    }
}

// ‚úÖ EXPORT FUNKTIONEN
function exportCSV() {
    const params = new URLSearchParams();
    if (currentSessionFilter && currentSessionFilter !== 'all') {
        params.append('session_id', currentSessionFilter);
    }
    
    const driverFilter = document.getElementById('driverFilter').value;
    const carFilter = document.getElementById('carFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    if (driverFilter) params.append('driver', driverFilter);
    if (carFilter) params.append('car', carFilter);
    if (dateFilter) params.append('date', dateFilter);
    
    showStatus('CSV Export wird erstellt...', 'info');
    
    const link = document.createElement('a');
    link.href = `/api/export/csv?${params}`;
    
    let filename = 'smartrace_export';
    if (currentSessionFilter && currentSessionFilter !== 'all') {
        filename += `_${currentSessionFilter}`;
    }
    if (dateFilter) {
        filename += `_${dateFilter}`;
    }
    filename += `_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
    
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => {
        showStatus(`CSV Export erfolgreich! ${currentData.length} Eintr√§ge exportiert.`, 'success');
    }, 1000);
}

function exportDropbox() {
    if (!dropboxConfigured) {
        showStatus('Bitte konfiguriere zuerst Dropbox √ºber das Setup.', 'warning');
        showDropboxConfig();
        return;
    }
    
    showStatus('Upload zu Dropbox...', 'info');
    
    fetch('/api/dropbox/backup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = `‚úÖ Export erfolgreich! ${data.records} Eintr√§ge zu Dropbox hochgeladen.<br>`;
            message += `üìÅ Datei: backup_${new Date().toISOString().slice(0, 10)}.csv`;
            showStatus(message, 'success');
        } else {
            showStatus(`‚ùå Export fehlgeschlagen: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showStatus('‚ùå Netzwerkfehler beim Dropbox Export', 'danger');
    });
}

function showDropboxConfig() {
    checkDropboxStatus();
    const modal = new bootstrap.Modal(document.getElementById('dropboxModal'));
    modal.show();
}

function checkDropboxStatus() {
    fetch('/api/dropbox/test')
        .then(response => response.json())
        .then(data => {
            dropboxConfigured = data.success;
            const statusDiv = document.getElementById('dropboxStatus');
            
            if (data.success) {
                statusDiv.innerHTML = `<div class="alert alert-success">
                    <i class="fas fa-check"></i> Dropbox ist verbunden<br>
                    <strong>Account:</strong> ${data.account}
                </div>`;
                document.getElementById('dropboxBtn').disabled = false;
            } else {
                statusDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Dropbox nicht konfiguriert</div>';
                document.getElementById('dropboxBtn').disabled = true;
            }
        })
        .catch(error => {
            console.error('Dropbox check error:', error);
            dropboxConfigured = false;
            document.getElementById('dropboxBtn').disabled = true;
        });
}

function saveDropboxConfig() {
    const token = document.getElementById('dropboxToken').value.trim();
    
    if (!token) {
        alert('Bitte gib einen Access Token ein.');
        return;
    }
    
    const statusDiv = document.getElementById('dropboxStatus');
    statusDiv.innerHTML = '<div class="alert alert-info">Konfiguration wird gespeichert...</div>';
    
    fetch('/api/dropbox/setup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            token: token
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            dropboxConfigured = true;
            document.getElementById('dropboxBtn').disabled = false;
            
            statusDiv.innerHTML = `<div class="alert alert-success">
                <i class="fas fa-check"></i> Erfolgreich verbunden!<br>
                <strong>Nachricht:</strong> ${data.message}
            </div>`;
            
            showStatus('Dropbox erfolgreich konfiguriert!', 'success');
            
            document.getElementById('dropboxToken').value = '';
            
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('dropboxModal'));
                modal.hide();
            }, 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Konfiguration fehlgeschlagen: ${data.error}
            </div>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusDiv.innerHTML = '<div class="alert alert-danger">Netzwerkfehler bei der Konfiguration</div>';
    });
}

function testDropboxConnection() {
    const statusDiv = document.getElementById('dropboxStatus');
    statusDiv.innerHTML = '<div class="alert alert-info">Verbindung wird getestet...</div>';
    
    fetch('/api/dropbox/test')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                dropboxConfigured = true;
                statusDiv.innerHTML = `<div class="alert alert-success">
                    <i class="fas fa-check"></i> ‚úÖ Verbindung erfolgreich!<br>
                    <strong>Account:</strong> ${data.account}
                </div>`;
                document.getElementById('dropboxBtn').disabled = false;
            } else {
                dropboxConfigured = false;
                statusDiv.innerHTML = `<div class="alert alert-danger">
                    <i class="fas fa-times"></i> ‚ùå Verbindung fehlgeschlagen: ${data.error}
                </div>`;
                document.getElementById('dropboxBtn').disabled = true;
            }
        })
        .catch(error => {
            console.error('Test error:', error);
            statusDiv.innerHTML = '<div class="alert alert-danger">Netzwerkfehler beim Test</div>';
        });
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('exportStatus');
    statusDiv.className = `alert alert-${type}`;
    statusDiv.innerHTML = message;
    statusDiv.classList.remove('d-none');
    
    if (type !== 'danger') {
        setTimeout(() => {
            statusDiv.classList.add('d-none');
        }, 5000);
    }
}

// ‚úÖ EVENT LISTENERS
document.addEventListener('DOMContentLoaded', async function() {
    // Alles in der richtigen Reihenfolge laden
    await loadSessions();    // 1. Sessions laden
    loadFilters();           // 2. Filter laden
    await loadData();        // 3. Daten laden
    checkDropboxStatus();    // 4. Dropbox Status pr√ºfen
    
    // Nach dem DOM-Load Sortierung einrichten
    setTimeout(setupTableSorting, 100);
    
    console.log('‚úÖ Database page loaded successfully');
});

// Session-Wechsel Event Listener
document.getElementById('sessionSelect').addEventListener('change', function() {
    currentSessionFilter = this.value;
    console.log(`üîÑ Session changed to: ${currentSessionFilter}`);
    loadFilters();  // Filter f√ºr neue Session laden
    loadData();     // Daten neu laden
});

// Refresh Sessions Button
document.getElementById('refreshSessions').addEventListener('click', async function() {
    const button = this;
    const originalHTML = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    try {
        await loadSessions();
        await loadData();
        showStatus('Sessions erfolgreich aktualisiert!', 'success');
    } catch (error) {
        console.error('‚ùå Refresh error:', error);
        showStatus('Fehler beim Aktualisieren der Sessions', 'danger');
    } finally {
        button.innerHTML = originalHTML;
        button.disabled = false;
    }
});

// Filter Event Listeners
document.getElementById('driverFilter').addEventListener('change', function() {
    console.log(`üîç Driver filter: ${this.value}`);
    loadData();
});

document.getElementById('carFilter').addEventListener('change', function() {
    console.log(`üöó Car filter: ${this.value}`);
    loadData();
});

document.getElementById('dateFilter').addEventListener('change', function() {
    console.log(`üìÖ Date filter: ${this.value}`);
    loadData();
});

// Auto-refresh alle 30 Sekunden (nur wenn "all" Sessions gew√§hlt ist)
setInterval(() => {
    if (currentSessionFilter === 'all') {
        loadData();
        console.log('üîÑ Auto-refresh triggered');
    }
}, 30000);

// Keyboard Shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + R = Refresh Sessions
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        document.getElementById('refreshSessions').click();
    }
    
    // Ctrl/Cmd + E = Export CSV
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        exportCSV();
    }
    
    // Escape = Clear all filters
    if (e.key === 'Escape') {
        clearAllFilters();
    }
});

console.log('üéØ Database.html loaded with session management!');
</script>
{% endblock %}
