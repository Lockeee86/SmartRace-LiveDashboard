{% extends "base.html" %}

{% block title %}Datenbank - SmartRace Live{% endblock %}

{% block content %}
<!-- Header -->
<div class="session-selector d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0"><i class="fas fa-database me-2"></i>Datenbank</h5>
    <div class="d-flex align-items-center gap-2">
        <select id="sessionSelect" class="form-select form-select-sm" style="min-width: 280px;">
            <option value="all">Alle Sessions</option>
        </select>
        <button id="refreshBtn" class="btn btn-sm btn-outline-primary" title="Aktualisieren">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
</div>

<!-- Filter Leiste -->
<div class="filter-section mb-3">
    <div class="row g-2 align-items-end">
        <div class="col-md-2">
            <label class="form-label small text-muted mb-1">Fahrer</label>
            <select id="driverFilter" class="form-select form-select-sm">
                <option value="">Alle Fahrer</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted mb-1">Auto</label>
            <select id="carFilter" class="form-select form-select-sm">
                <option value="">Alle Autos</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted mb-1">Datum von</label>
            <input type="date" id="dateFrom" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted mb-1">Datum bis</label>
            <input type="date" id="dateTo" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
            <label class="form-label small text-muted mb-1">Pro Seite</label>
            <select id="perPageSelect" class="form-select form-select-sm">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
        </div>
        <div class="col-md-2">
            <div class="btn-group w-100">
                <button class="btn btn-sm btn-outline-secondary" onclick="clearFilters()" title="Filter Reset" style="flex: 1;">
                    <i class="fas fa-times me-1"></i>Reset
                </button>
                <button class="btn btn-sm btn-success" onclick="exportCSV()" title="CSV Export">
                    <i class="fas fa-download"></i>
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="renameSession()" title="Session umbenennen">
                    <i class="fas fa-pen"></i>
                </button>
                <button class="btn btn-sm btn-primary" onclick="downloadBackup()" title="JSON Backup">
                    <i class="fas fa-archive"></i>
                </button>
                <button class="btn btn-sm btn-warning" onclick="document.getElementById('restoreFile').click()" title="JSON Restore">
                    <i class="fas fa-upload"></i>
                </button>
            </div>
            <input type="file" id="restoreFile" accept=".json" class="d-none" onchange="restoreBackup(this)">
        </div>
    </div>
</div>

<!-- Statistik Cards -->
<div class="row g-3 mb-3">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body py-2 text-center">
                <div class="fw-bold fs-5" id="statTotal">--</div>
                <div class="small text-muted">Eintraege gesamt</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body py-2 text-center">
                <div class="fw-bold fs-5" id="statFiltered">--</div>
                <div class="small text-muted">Gefiltert</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body py-2 text-center">
                <div class="fw-bold fs-5" id="statDrivers">--</div>
                <div class="small text-muted">Fahrer</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body py-2 text-center">
                <div class="fw-bold fs-5" id="statCars">--</div>
                <div class="small text-muted">Autos</div>
            </div>
        </div>
    </div>
</div>

<!-- Status Alert -->
<div id="statusAlert" class="alert d-none mb-3" role="alert"></div>

<!-- Datentabelle -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th class="sortable" data-col="session_id">Session <i class="fas fa-sort sort-icon"></i></th>
                        <th class="sortable" data-col="session_type">Typ <i class="fas fa-sort sort-icon"></i></th>
                        <th class="sortable" data-col="driver_name">Fahrer <i class="fas fa-sort sort-icon"></i></th>
                        <th class="sortable" data-col="car_name">Auto <i class="fas fa-sort sort-icon"></i></th>
                        <th class="sortable text-center" data-col="lap">Runde <i class="fas fa-sort sort-icon"></i></th>
                        <th class="sortable text-center" data-col="laptime_raw">Rundenzeit <i class="fas fa-sort sort-icon"></i></th>
                        <th class="text-center">Delta</th>
                        <th class="text-center d-none d-lg-table-cell">S1</th>
                        <th class="text-center d-none d-lg-table-cell">S2</th>
                        <th class="text-center d-none d-lg-table-cell">S3</th>
                        <th class="sortable text-center" data-col="timestamp">Zeitstempel <i class="fas fa-sort sort-icon"></i></th>
                        <th class="text-center" style="width: 40px;">PB</th>
                        <th class="text-center" style="width: 40px;"></th>
                    </tr>
                </thead>
                <tbody id="dataBody">
                    <tr><td colspan="13" class="text-center text-muted py-4">Lade Daten...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- Pagination -->
    <div class="card-footer d-flex justify-content-between align-items-center py-2">
        <div class="small text-muted" id="paginationInfo">--</div>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="paginationNav"></ul>
        </nav>
    </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="fas fa-trash-alt text-danger me-2"></i>Runde loeschen</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deleteModalBody">
                Diese Runde wirklich loeschen?
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-sm btn-danger" id="deleteConfirmBtn">Loeschen</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let perPage = 50;
let currentSort = { col: 'created_at', dir: 'desc' };
let currentSessionFilter = 'all';
let bestTimes = {}; // {driver_name+session_id: best_time_ms}

async function loadSessions() {
    try {
        const res = await fetch('/api/sessions');
        if (!res.ok) return;
        const sessions = await res.json();
        const sel = document.getElementById('sessionSelect');
        sel.innerHTML = '<option value="all">Alle Sessions</option>';
        sessions.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.session_id;
            opt.textContent = `${s.display_name || s.session_id} (${s.total_laps} Runden)`;
            sel.appendChild(opt);
        });
        sel.value = currentSessionFilter;
    } catch (e) {
        console.error('Sessions-Fehler:', e);
    }
}

async function loadFilters() {
    try {
        const res = await fetch('/api/filters');
        if (!res.ok) return;
        const data = await res.json();

        const driverSel = document.getElementById('driverFilter');
        const carSel = document.getElementById('carFilter');
        const currentDriver = driverSel.value;
        const currentCar = carSel.value;

        driverSel.innerHTML = '<option value="">Alle Fahrer</option>';
        data.drivers.forEach(d => {
            driverSel.innerHTML += `<option value="${d}">${d}</option>`;
        });

        carSel.innerHTML = '<option value="">Alle Autos</option>';
        data.cars.forEach(c => {
            carSel.innerHTML += `<option value="${c}">${c}</option>`;
        });

        driverSel.value = currentDriver;
        carSel.value = currentCar;

        document.getElementById('statDrivers').textContent = data.drivers.length;
        document.getElementById('statCars').textContent = data.cars.length;
    } catch (e) {
        console.error('Filter-Fehler:', e);
    }
}

function buildParams() {
    const params = new URLSearchParams();
    currentSessionFilter = document.getElementById('sessionSelect').value;
    if (currentSessionFilter !== 'all') params.append('session_id', currentSessionFilter);
    const driver = document.getElementById('driverFilter').value;
    if (driver) params.append('driver', driver);
    const car = document.getElementById('carFilter').value;
    if (car) params.append('car', car);
    const dateFrom = document.getElementById('dateFrom').value;
    if (dateFrom) params.append('date_from', dateFrom);
    const dateTo = document.getElementById('dateTo').value;
    if (dateTo) params.append('date_to', dateTo);
    return params;
}

async function loadData() {
    try {
        const params = buildParams();
        perPage = parseInt(document.getElementById('perPageSelect').value);
        params.append('page', currentPage);
        params.append('per_page', perPage);
        params.append('sort', currentSort.col);
        params.append('dir', currentSort.dir);

        const res = await fetch('/api/laps?' + params);
        if (!res.ok) return;
        const result = await res.json();

        const data = result.data || [];
        totalPages = result.pages || 1;
        currentPage = result.page || 1;

        // Beste Zeiten pro Fahrer+Session berechnen fuer Delta
        bestTimes = {};
        data.forEach(lap => {
            if (!lap.laptime_raw || lap.laptime_raw <= 0) return;
            const key = (lap.driver_name || '') + '|' + (lap.session_id || '');
            if (!bestTimes[key] || lap.laptime_raw < bestTimes[key]) {
                bestTimes[key] = lap.laptime_raw;
            }
        });

        renderTable(data);
        renderPagination();
        document.getElementById('statFiltered').textContent = result.total || 0;

        // Total separat
        const totalRes = await fetch('/api/laps/count');
        if (totalRes.ok) {
            const totalData = await totalRes.json();
            document.getElementById('statTotal').textContent = totalData.count;
        }
    } catch (e) {
        console.error('Daten-Fehler:', e);
        showStatus('Fehler beim Laden der Daten', 'danger');
    }
}

function renderTable(data) {
    const tbody = document.getElementById('dataBody');

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" class="text-center text-muted py-4"><i class="fas fa-search me-2"></i>Keine Daten gefunden</td></tr>';
        return;
    }

    tbody.innerHTML = data.map(lap => {
        const rowClass = lap.is_pb ? 'row-pb' : '';

        let typeBadge = 'bg-secondary';
        const et = (lap.session_type || '').toLowerCase();
        if (et.includes('race') || et.includes('rennen')) typeBadge = 'bg-danger';
        else if (et.includes('quali')) typeBadge = 'bg-warning text-dark';
        else if (et.includes('practice') || et.includes('training')) typeBadge = 'bg-info';

        const ts = lap.timestamp ? new Date(lap.timestamp).toLocaleString('de-DE', {
            day: '2-digit', month: '2-digit', year: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        }) : '--';

        // Delta berechnen
        let deltaHtml = '<span class="text-muted">--</span>';
        if (lap.laptime_raw && lap.laptime_raw > 0) {
            const key = (lap.driver_name || '') + '|' + (lap.session_id || '');
            const best = bestTimes[key];
            if (best && best > 0) {
                const diff = lap.laptime_raw - best;
                if (diff === 0) {
                    deltaHtml = '<span class="text-success fw-bold">Best</span>';
                } else {
                    const sign = '+';
                    const sec = (diff / 1000).toFixed(3);
                    let cls = 'text-muted';
                    if (diff < 500) cls = 'text-success';
                    else if (diff < 1500) cls = 'text-warning';
                    else cls = 'text-danger';
                    deltaHtml = `<span class="${cls}">${sign}${sec}s</span>`;
                }
            }
        }

        return `<tr class="${rowClass}">
            <td><span class="badge ${typeBadge} small">${lap.session_id || '--'}</span></td>
            <td class="small">${lap.session_type || '--'}</td>
            <td>${lap.driver_name || '--'}</td>
            <td class="small text-muted">${lap.car_name || '--'}</td>
            <td class="text-center">${lap.lap || '--'}</td>
            <td class="text-center font-mono fw-bold">${lap.laptime_formatted || '--'}</td>
            <td class="text-center font-mono small">${deltaHtml}</td>
            <td class="text-center font-mono small d-none d-lg-table-cell">${lap.sector_1 || '--'}</td>
            <td class="text-center font-mono small d-none d-lg-table-cell">${lap.sector_2 || '--'}</td>
            <td class="text-center font-mono small d-none d-lg-table-cell">${lap.sector_3 || '--'}</td>
            <td class="text-center small">${ts}</td>
            <td class="text-center">${lap.is_pb ? '<i class="fas fa-trophy text-warning"></i>' : ''}</td>
            <td class="text-center">
                <button class="btn btn-link btn-sm text-danger p-0 opacity-50 delete-lap-btn"
                        data-id="${lap.id}" data-driver="${lap.driver_name || ''}"
                        data-lap="${lap.lap || ''}" data-time="${lap.laptime_formatted || ''}"
                        title="Runde loeschen"><i class="fas fa-trash-alt fa-sm"></i></button>
            </td>
        </tr>`;
    }).join('');

    // Delete-Buttons binden
    tbody.querySelectorAll('.delete-lap-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const driver = btn.dataset.driver;
            const lap = btn.dataset.lap;
            const time = btn.dataset.time;
            confirmDeleteLap(id, driver, lap, time);
        });
    });
}

function renderPagination() {
    const info = document.getElementById('paginationInfo');
    const nav = document.getElementById('paginationNav');

    const from = ((currentPage - 1) * perPage) + 1;
    const to = Math.min(currentPage * perPage, parseInt(document.getElementById('statFiltered').textContent) || 0);
    const total = document.getElementById('statFiltered').textContent;
    info.textContent = `${from}-${to} von ${total}`;

    let html = '';

    // Zurueck
    html += `<li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage - 1}">&laquo;</a></li>`;

    // Seitenzahlen (max 7 sichtbar)
    const maxVisible = 7;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }

    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
        if (startPage > 2) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }

    for (let i = startPage; i <= endPage; i++) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
    }

    // Vor
    html += `<li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage + 1}">&raquo;</a></li>`;

    nav.innerHTML = html;

    // Click Handler
    nav.querySelectorAll('a[data-page]').forEach(a => {
        a.addEventListener('click', e => {
            e.preventDefault();
            const p = parseInt(a.dataset.page);
            if (p >= 1 && p <= totalPages && p !== currentPage) {
                currentPage = p;
                loadData();
            }
        });
    });
}

// Delete Lap
let deleteTargetId = null;
const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

function confirmDeleteLap(id, driver, lap, time) {
    deleteTargetId = id;
    document.getElementById('deleteModalBody').innerHTML =
        `Runde <strong>${lap}</strong> von <strong>${driver}</strong> (${time}) wirklich loeschen?`;
    deleteModal.show();
}

document.getElementById('deleteConfirmBtn').addEventListener('click', async () => {
    if (!deleteTargetId) return;
    try {
        const res = await fetch(`/api/laps/${deleteTargetId}`, { method: 'DELETE' });
        const data = await res.json();
        if (res.ok) {
            showStatus('Runde geloescht', 'success');
            deleteModal.hide();
            loadData();
        } else {
            showStatus('Fehler: ' + (data.error || 'Unbekannt'), 'danger');
        }
    } catch (e) {
        showStatus('Fehler: ' + e.message, 'danger');
    }
    deleteTargetId = null;
});

function setupSorting() {
    document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const col = th.dataset.col;
            let dir = 'asc';
            if (currentSort.col === col && currentSort.dir === 'asc') dir = 'desc';
            document.querySelectorAll('.sortable').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            th.classList.add('sort-' + dir);
            currentSort = { col, dir };
            currentPage = 1;
            loadData();
        });
    });
}

function exportCSV() {
    const params = buildParams();
    const session = document.getElementById('sessionSelect').value;
    if (session !== 'all') params.set('event', session);

    const link = document.createElement('a');
    link.href = '/api/export/csv?' + params;
    link.download = 'smartrace_export.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showStatus('CSV wird heruntergeladen...', 'success');
}

function clearFilters() {
    document.getElementById('sessionSelect').value = 'all';
    document.getElementById('driverFilter').value = '';
    document.getElementById('carFilter').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    currentSessionFilter = 'all';
    currentSort = { col: 'created_at', dir: 'desc' };
    currentPage = 1;
    document.querySelectorAll('.sortable').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
    loadData();
}

function showStatus(msg, type) {
    const el = document.getElementById('statusAlert');
    el.className = 'alert alert-' + type + ' mb-3';
    el.textContent = msg;
    el.classList.remove('d-none');
    if (type !== 'danger') {
        setTimeout(() => el.classList.add('d-none'), 4000);
    }
}

// Event Listener
document.addEventListener('DOMContentLoaded', async () => {
    await loadSessions();
    await loadFilters();
    await loadData();
    setupSorting();
});

document.getElementById('sessionSelect').addEventListener('change', () => {
    currentPage = 1;
    loadFilters();
    loadData();
});
document.getElementById('driverFilter').addEventListener('change', () => { currentPage = 1; loadData(); });
document.getElementById('carFilter').addEventListener('change', () => { currentPage = 1; loadData(); });
document.getElementById('dateFrom').addEventListener('change', () => { currentPage = 1; loadData(); });
document.getElementById('dateTo').addEventListener('change', () => { currentPage = 1; loadData(); });
document.getElementById('perPageSelect').addEventListener('change', () => { currentPage = 1; loadData(); });

document.getElementById('refreshBtn').addEventListener('click', async function() {
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    this.disabled = true;
    await loadSessions();
    await loadFilters();
    await loadData();
    this.innerHTML = '<i class="fas fa-sync-alt"></i>';
    this.disabled = false;
});

// WebSocket: Live-Updates
socket.on('new_data', () => {
    loadData();
});

// Fallback
setInterval(() => { loadData(); }, 30000);

// Backup / Restore
function downloadBackup() {
    showStatus('Backup wird erstellt...', 'info');
    const link = document.createElement('a');
    link.href = '/api/backup';
    link.download = 'smartrace_backup.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showStatus('Backup wird heruntergeladen...', 'success');
}

async function restoreBackup(input) {
    const file = input.files[0];
    if (!file) return;

    if (!confirm('Backup wiederherstellen? Die importierten Daten werden zu den bestehenden hinzugefuegt.')) {
        input.value = '';
        return;
    }

    try {
        showStatus('Backup wird wiederhergestellt...', 'info');
        const text = await file.text();
        const data = JSON.parse(text);

        const res = await fetch('/api/restore', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });

        const result = await res.json();
        if (res.ok) {
            const counts = Object.entries(result.imported || {}).map(([k, v]) => `${v} ${k}`).join(', ');
            showStatus(`Backup erfolgreich wiederhergestellt: ${counts}`, 'success');
            await loadSessions();
            await loadFilters();
            await loadData();
        } else {
            showStatus('Fehler: ' + (result.error || 'Unbekannter Fehler'), 'danger');
        }
    } catch (e) {
        showStatus('Fehler beim Lesen der Datei: ' + e.message, 'danger');
    }
    input.value = '';
}

// Session umbenennen
async function renameSession() {
    const sid = document.getElementById('sessionSelect').value;
    if (!sid || sid === 'all') {
        showStatus('Bitte zuerst eine Session auswaehlen', 'warning');
        return;
    }
    const currentName = document.getElementById('sessionSelect').selectedOptions[0].textContent;
    const newName = prompt('Neuen Namen fuer die Session eingeben:', currentName.replace(/ \(\d+ Runden\)$/, ''));
    if (!newName || !newName.trim()) return;

    try {
        const res = await fetch('/api/session-name', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: sid, display_name: newName.trim() }),
        });
        if (res.ok) {
            showStatus('Session umbenannt', 'success');
            await loadSessions();
        } else {
            showStatus('Umbenennung fehlgeschlagen', 'danger');
        }
    } catch (e) {
        showStatus('Fehler: ' + e.message, 'danger');
    }
}

// Keyboard Shortcuts
document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') { e.preventDefault(); exportCSV(); }
    if (e.key === 'Escape') clearFilters();
    if (e.key === 'ArrowLeft' && currentPage > 1) { currentPage--; loadData(); }
    if (e.key === 'ArrowRight' && currentPage < totalPages) { currentPage++; loadData(); }
});
</script>
{% endblock %}
